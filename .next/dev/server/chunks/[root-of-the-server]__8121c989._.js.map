{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/app/api/supabase/proxy/route.ts"],"sourcesContent":["/**\n * API Route: Supabase Proxy\n *\n * Proxies Supabase requests to avoid CORS issues on Safari/iOS.\n * Supports device registration, photo metadata operations.\n */\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\n\n// Server-side Supabase client\nconst supabase = createClient(supabaseUrl, supabaseAnonKey);\n\nexport async function POST(request: NextRequest) {\n    try {\n        const body = await request.json();\n        const { action, ...params } = body;\n\n        switch (action) {\n            case \"registerDevice\": {\n                const { id, deviceName, deviceType, userKeyHash, userId } = params;\n\n                if (!userKeyHash || userKeyHash.length === 0) {\n                    return NextResponse.json(\n                        { error: \"userKeyHash is required\" },\n                        { status: 400 }\n                    );\n                }\n\n                // Check if device exists\n                const { data: existingDevice } = await supabase\n                    .from(\"devices\")\n                    .select(\"id\")\n                    .eq(\"user_id\", userId)\n                    .eq(\"device_name\", deviceName)\n                    .eq(\"device_type\", deviceType || \"\")\n                    .single();\n\n                if (existingDevice) {\n                    // Update existing device\n                    const { error: updateError } = await supabase\n                        .from(\"devices\")\n                        .update({\n                            device_name: deviceName,\n                            device_type: deviceType,\n                            user_key_hash: userKeyHash,\n                        })\n                        .eq(\"id\", existingDevice.id);\n\n                    if (updateError) {\n                        console.error(\"[Supabase Proxy] Device Update Error:\", updateError);\n                        return NextResponse.json(\n                            { error: updateError.message, code: updateError.code },\n                            { status: 500 }\n                        );\n                    }\n                    return NextResponse.json({ success: true, updated: true });\n                }\n\n                // Insert new device\n                const { error } = await supabase.from(\"devices\").insert({\n                    id,\n                    device_name: deviceName,\n                    device_type: deviceType,\n                    user_key_hash: userKeyHash,\n                    user_id: userId,\n                });\n\n                if (error) {\n                    console.error(\"[Supabase Proxy] Device Insert Error:\", error);\n                    return NextResponse.json(\n                        { error: error.message, code: error.code },\n                        { status: 500 }\n                    );\n                }\n                return NextResponse.json({ success: true, inserted: true });\n            }\n\n            case \"uploadMetadata\": {\n                const { cid, fileSize, deviceId, nonce, mimeType, userKeyHash } = params;\n\n                const { data, error } = await supabase\n                    .from(\"photos_metadata\")\n                    .insert([\n                        {\n                            cid,\n                            file_size_bytes: fileSize,\n                            device_id: deviceId,\n                            nonce,\n                            mime_type: mimeType,\n                            user_key_hash: userKeyHash,\n                        },\n                    ])\n                    .select();\n\n                if (error) {\n                    console.error(\"[Supabase Proxy] Metadata Upload Error:\", error);\n                    return NextResponse.json(\n                        { error: error.message, code: error.code },\n                        { status: 500 }\n                    );\n                }\n                return NextResponse.json({ success: true, data });\n            }\n\n            case \"loadCIDs\": {\n                const { userKeyHash } = params;\n\n                if (!userKeyHash) {\n                    return NextResponse.json(\n                        { error: \"userKeyHash is required\" },\n                        { status: 400 }\n                    );\n                }\n\n                const { data, error } = await supabase\n                    .from(\"photos_metadata\")\n                    .select(\"cid, device_id, uploaded_at, file_size_bytes, nonce, mime_type\")\n                    .eq(\"user_key_hash\", userKeyHash)\n                    .order(\"uploaded_at\", { ascending: false });\n\n                if (error) {\n                    console.error(\"[Supabase Proxy] Load CIDs Error:\", error);\n                    return NextResponse.json(\n                        { error: error.message, code: error.code },\n                        { status: 500 }\n                    );\n                }\n                return NextResponse.json({ success: true, data: data || [] });\n            }\n\n            case \"deleteMetadata\": {\n                const { cid } = params;\n\n                const { error } = await supabase\n                    .from(\"photos_metadata\")\n                    .delete()\n                    .eq(\"cid\", cid);\n\n                if (error) {\n                    console.error(\"[Supabase Proxy] Delete Error:\", error);\n                    return NextResponse.json(\n                        { error: error.message, code: error.code },\n                        { status: 500 }\n                    );\n                }\n                return NextResponse.json({ success: true });\n            }\n\n            default:\n                return NextResponse.json(\n                    { error: `Unknown action: ${action}` },\n                    { status: 400 }\n                );\n        }\n    } catch (err) {\n        console.error(\"[Supabase Proxy] Error:\", err);\n        return NextResponse.json(\n            { error: \"Internal server error\" },\n            { status: 500 }\n        );\n    }\n}\n"],"names":[],"mappings":"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"}}]
}