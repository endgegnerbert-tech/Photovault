{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/lib/utils.ts"],"sourcesContent":["import { clsx, type ClassValue } from \"clsx\";\nimport { twMerge } from \"tailwind-merge\";\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs));\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,SAAS,GAAG,GAAG,MAAoB;IACxC,OAAO,IAAA,sKAAO,EAAC,IAAA,6IAAI,EAAC;AACtB"}},
    {"offset": {"line": 19, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/components/ui/custom-icon.tsx"],"sourcesContent":["import Image from \"next/image\";\nimport { cn } from \"@/lib/utils\";\n\nconst ICONS = {\n  key: \"/key.svg\",\n  lock: \"/lock.svg\",\n  shield: \"/shield.svg\",\n  upload: \"/upload.svg\",\n  smartphone: \"/smartphone.svg\",\n  cloud: \"/cloud.svg\",\n  clock: \"/clock.svg\",\n  search: \"/search.svg\",\n  image: \"/image.svg\",\n  folder: \"/Openfolder.svg\",\n  refresh: \"/RefreshCw.svg\",\n  chevronRight: \"/ChevronRight.svg\",\n} as const;\n\nexport type IconName = keyof typeof ICONS;\n\ninterface CustomIconProps {\n  name: IconName;\n  className?: string;\n  size?: number;\n}\n\nexport function CustomIcon({ name, className, size = 24 }: CustomIconProps) {\n  return (\n    <div\n      className={cn(\"relative inline-block shrink-0\", className)}\n      style={{ width: size, height: size }}\n    >\n      <Image\n        src={ICONS[name]}\n        alt={name}\n        fill\n        className=\"object-contain\"\n        unoptimized\n      />\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;AAAA;AACA;;;;AAEA,MAAM,QAAQ;IACZ,KAAK;IACL,MAAM;IACN,QAAQ;IACR,QAAQ;IACR,YAAY;IACZ,OAAO;IACP,OAAO;IACP,QAAQ;IACR,OAAO;IACP,QAAQ;IACR,SAAS;IACT,cAAc;AAChB;AAUO,SAAS,WAAW,EAAE,IAAI,EAAE,SAAS,EAAE,OAAO,EAAE,EAAmB;IACxE,qBACE,8OAAC;QACC,WAAW,IAAA,yHAAE,EAAC,kCAAkC;QAChD,OAAO;YAAE,OAAO;YAAM,QAAQ;QAAK;kBAEnC,cAAA,8OAAC,wIAAK;YACJ,KAAK,KAAK,CAAC,KAAK;YAChB,KAAK;YACL,IAAI;YACJ,WAAU;YACV,WAAW;;;;;;;;;;;AAInB"}},
    {"offset": {"line": 71, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/components/ui/shield-loader.tsx"],"sourcesContent":["import type React from \"react\";\nimport \"./shield-loader.css\";\nimport { Image } from \"lucide-react\";\n\n/**\n * Ein Ladebildschirm, der ein Schild aus vielen einzelnen Partikeln aufbaut.\n * Jedes Partikel erscheint mit einer leichten Verzögerung und einem \"Rauch\"-Effekt,\n * um einen dynamischen und modernen Ladeeffekt zu erzeugen.\n */\nconst ShieldLoader: React.FC = () => {\n  // Anzahl der Partikel, aus denen das Schild aufgebaut wird.\n  const particleCount = 150;\n\n  return (\n    // Der Hauptcontainer, der den gesamten Bildschirm einnimmt\n    <div className=\"loader-container\">\n      {/* Das Photo-Icon, das hinter dem Schild hervorlugt */}\n      <div className=\"peeking-photo-icon\">\n        <Image strokeWidth={1.5} />\n      </div>\n\n      {/* Der Container, der die Form des Schildes hat und die Partikel enthält */}\n      <div className=\"shield-container\">\n        {/* Generiert die Partikel-Elemente */}\n        {Array.from({ length: particleCount }).map((_, i) => (\n          <div\n            key={i}\n            className=\"particle\"\n            // Deterministische Verzögerung (SPEED UP: Faktor 0.25 -> 0.1, 0.05 -> 0.02)\n            style={{\n              animationDelay: `${(i % 10) * 0.1 + Math.floor(i / 10) * 0.02}s`,\n            }}\n          />\n        ))}\n        {/* Strukturlinien für das Schild */}\n        <div className=\"shield-structure\">\n          <div className=\"structure-line line-1\" />\n          <div className=\"structure-line line-2\" />\n          <div className=\"structure-line line-3\" />\n          <div className=\"structure-line line-4\" />\n        </div>\n      </div>\n      {/* Der Text, der nach einer kurzen Verzögerung in der Mitte erscheint */}\n      <div className=\"loading-text\">LÄDT...</div>\n    </div>\n  );\n};\n\nexport default ShieldLoader;\n"],"names":[],"mappings":";;;;;AAEA;;;;AAEA;;;;CAIC,GACD,MAAM,eAAyB;IAC7B,4DAA4D;IAC5D,MAAM,gBAAgB;IAEtB,OACE,2DAA2D;kBAC3D,8OAAC;QAAI,WAAU;;0BAEb,8OAAC;gBAAI,WAAU;0BACb,cAAA,8OAAC,6MAAK;oBAAC,aAAa;;;;;;;;;;;0BAItB,8OAAC;gBAAI,WAAU;;oBAEZ,MAAM,IAAI,CAAC;wBAAE,QAAQ;oBAAc,GAAG,GAAG,CAAC,CAAC,GAAG,kBAC7C,8OAAC;4BAEC,WAAU;4BACV,4EAA4E;4BAC5E,OAAO;gCACL,gBAAgB,GAAG,AAAC,IAAI,KAAM,MAAM,KAAK,KAAK,CAAC,IAAI,MAAM,KAAK,CAAC,CAAC;4BAClE;2BALK;;;;;kCAST,8OAAC;wBAAI,WAAU;;0CACb,8OAAC;gCAAI,WAAU;;;;;;0CACf,8OAAC;gCAAI,WAAU;;;;;;0CACf,8OAAC;gCAAI,WAAU;;;;;;0CACf,8OAAC;gCAAI,WAAU;;;;;;;;;;;;;;;;;;0BAInB,8OAAC;gBAAI,WAAU;0BAAe;;;;;;;;;;;;AAGpC;uCAEe"}},
    {"offset": {"line": 184, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/lib/auth-client.ts"],"sourcesContent":["/**\n * Better Auth Client Configuration\n *\n * React hooks for authentication in client components.\n */\n\nimport { createAuthClient } from \"better-auth/react\";\n\nexport const authClient = createAuthClient({\n    baseURL: process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\",\n});\n\n// Export commonly used hooks and methods\nexport const {\n    signIn,\n    signUp,\n    signOut,\n    useSession,\n    getSession,\n} = authClient;\n\n// Type exports for convenience\nexport type Session = typeof authClient.$Infer.Session;\nexport type User = typeof authClient.$Infer.Session.user;\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;;;CAIC,GAED;;AAEO,MAAM,aAAa,IAAA,uMAAgB,EAAC;IACvC,SAAS,wEAAmC;AAChD;AAGO,MAAM,EACT,MAAM,EACN,MAAM,EACN,OAAO,EACP,UAAU,EACV,UAAU,EACb,GAAG"}},
    {"offset": {"line": 212, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/components/photovault/AuthScreen.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState } from \"react\";\nimport { Mail, Lock, Eye, EyeOff, ArrowRight, User, Smartphone, Info } from \"lucide-react\";\nimport { CustomIcon } from \"@/components/ui/custom-icon\";\nimport { signIn, signUp } from \"@/lib/auth-client\";\n\ninterface AuthScreenProps {\n    onSuccess: (user: { id: string; email: string; vaultKeyHash: string | null }) => void;\n}\n\ntype AuthMode = \"welcome\" | \"login\" | \"signup\";\n\nexport function AuthScreen({ onSuccess }: AuthScreenProps) {\n    const [mode, setMode] = useState<AuthMode>(\"welcome\");\n    const [email, setEmail] = useState(\"\");\n    const [password, setPassword] = useState(\"\");\n    const [name, setName] = useState(\"\");\n    const [showPassword, setShowPassword] = useState(false);\n    const [isLoading, setIsLoading] = useState(false);\n    const [error, setError] = useState<string | null>(null);\n\n    const handleLogin = async () => {\n        if (!email || !password) {\n            setError(\"Bitte E-Mail und Passwort eingeben\");\n            return;\n        }\n\n        setIsLoading(true);\n        setError(null);\n\n        try {\n            const result = await signIn.email({\n                email,\n                password,\n            });\n\n            if (result.error) {\n                setError(result.error.message || \"Anmeldung fehlgeschlagen\");\n                return;\n            }\n\n            if (result.data?.user) {\n                onSuccess({\n                    id: result.data.user.id,\n                    email: result.data.user.email,\n                    vaultKeyHash: (result.data.user as { vault_key_hash?: string }).vault_key_hash || null,\n                });\n            }\n        } catch (err) {\n            console.error(\"Login error:\", err);\n            setError(\"Ein Fehler ist aufgetreten. Bitte versuche es erneut.\");\n        } finally {\n            setIsLoading(false);\n        }\n    };\n\n    const handleSignup = async () => {\n        if (!email || !password || !name) {\n            setError(\"Bitte alle Felder ausfuellen\");\n            return;\n        }\n\n        if (password.length < 8) {\n            setError(\"Passwort muss mindestens 8 Zeichen haben\");\n            return;\n        }\n\n        setIsLoading(true);\n        setError(null);\n\n        try {\n            const result = await signUp.email({\n                email,\n                password,\n                name,\n            });\n\n            if (result.error) {\n                setError(result.error.message || \"Registrierung fehlgeschlagen\");\n                return;\n            }\n\n            if (result.data?.user) {\n                onSuccess({\n                    id: result.data.user.id,\n                    email: result.data.user.email,\n                    vaultKeyHash: null, // New user has no vault yet\n                });\n            }\n        } catch (err) {\n            console.error(\"Signup error:\", err);\n            setError(\"Ein Fehler ist aufgetreten. Bitte versuche es erneut.\");\n        } finally {\n            setIsLoading(false);\n        }\n    };\n\n    // Welcome Screen\n    if (mode === \"welcome\") {\n        return (\n            <div className=\"min-h-screen flex flex-col px-6 pt-16 pb-8 safe-area-inset bg-[#FAFBFC]\">\n                <div className=\"flex-1 flex flex-col items-center justify-center text-center\">\n                    {/* Logo with Sketch UI */}\n                    <div className=\"relative w-28 h-28 mb-8\">\n                        <svg className=\"absolute inset-0 w-full h-full\" viewBox=\"0 0 100 100\">\n                             <path \n                                d=\"M 10 10 Q 30 5, 50 10 Q 70 5, 90 10 Q 95 30, 90 50 Q 95 70, 90 90 Q 70 95, 50 90 Q 30 95, 10 90 Q 5 70, 10 50 Q 5 30, 10 10 Z\"\n                                fill=\"white\"\n                                stroke=\"#2563EB\"\n                                strokeWidth=\"3\"\n                             />\n                        </svg>\n                        <div className=\"relative z-10 w-full h-full flex items-center justify-center\">\n                            <CustomIcon name=\"shield\" size={56} className=\"text-[#2563EB]\" />\n                        </div>\n                    </div>\n\n                    <h1 className=\"sketch-heading text-[42px] mb-3\">\n                        PhotoVault\n                    </h1>\n                    <p className=\"sketch-body text-[#3B82F6] max-w-[280px] mb-12\">\n                        Sichere deine Fotos mit Zero-Knowledge Verschluesselung\n                    </p>\n\n                    {/* Features with Sketch UI */}\n                    <div className=\"w-full max-w-[320px] space-y-4 mb-12\">\n                        <FeatureItem icon=\"lock\" text=\"Ende-zu-Ende verschluesselt\" />\n                        <FeatureItem icon=\"smartphone\" text=\"Multi-Device Sync\" />\n                        <FeatureItem icon=\"cloud\" text=\"Dezentrales IPFS Backup\" />\n                    </div>\n                </div>\n\n                {/* Buttons with Sketch UI */}\n                <div className=\"space-y-4\">\n                    <button\n                        onClick={() => setMode(\"signup\")}\n                        className=\"relative w-full h-[60px] group transition-transform active:scale-95\"\n                    >\n                        <svg className=\"absolute inset-0 w-full h-full\" preserveAspectRatio=\"none\">\n                            <path \n                                d=\"M 2 5 Q 25 2, 50 5 Q 75 2, 98 5 Q 99 30, 98 60 Q 75 63, 50 60 Q 25 63, 2 60 Q 1 30, 2 5 Z\"\n                                fill=\"#2563EB\"\n                                stroke=\"#1E40AF\"\n                                strokeWidth=\"2\"\n                            />\n                        </svg>\n                        <span className=\"relative z-10 text-white sketch-subheading text-lg\">\n                            Konto erstellen\n                        </span>\n                    </button>\n\n                    <button\n                        onClick={() => setMode(\"login\")}\n                        className=\"w-full py-2 sketch-body text-[#2563EB] hover:text-[#1E40AF] transition-colors\"\n                    >\n                        Ich habe bereits ein Konto\n                    </button>\n                </div>\n            </div>\n        );\n    }\n\n    // Login / Signup Form\n    return (\n        <div className=\"min-h-screen flex flex-col px-6 pt-12 pb-8 safe-area-inset bg-[#FAFBFC]\">\n            {/* Header */}\n            <button\n                onClick={() => setMode(\"welcome\")}\n                className=\"self-start sketch-body text-[#2563EB] mb-8 ios-tap-target flex items-center gap-2\"\n            >\n                ← Zurueck\n            </button>\n\n            <div className=\"flex-1\">\n                <h1 className=\"sketch-heading text-[32px] mb-2\">\n                    {mode === \"login\" ? \"Willkommen zurueck\" : \"Konto erstellen\"}\n                </h1>\n                <p className=\"sketch-body text-[#3B82F6] mb-8\">\n                    {mode === \"login\"\n                        ? \"Melde dich an, um auf deinen Vault zuzugreifen\"\n                        : \"Erstelle ein Konto, um deinen Vault zu sichern\"}\n                </p>\n\n                {/* Form with Sketch UI */}\n                <div className=\"space-y-6\">\n                    {mode === \"signup\" && (\n                        <div className=\"relative\">\n                            <input\n                                type=\"text\"\n                                value={name}\n                                onChange={(e) => setName(e.target.value)}\n                                placeholder=\"Name\"\n                                className=\"sketch-input-field\"\n                            />\n                            <User className=\"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-[#2563EB]/40\" />\n                        </div>\n                    )}\n\n                    <div className=\"relative\">\n                        <input\n                            type=\"email\"\n                            value={email}\n                            onChange={(e) => setEmail(e.target.value)}\n                            placeholder=\"E-Mail\"\n                            autoComplete=\"email\"\n                            className=\"sketch-input-field\"\n                        />\n                        <Mail className=\"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-[#2563EB]/40\" />\n                    </div>\n\n                    <div className=\"relative\">\n                        <input\n                            type={showPassword ? \"text\" : \"password\"}\n                            value={password}\n                            onChange={(e) => setPassword(e.target.value)}\n                            placeholder=\"Passwort\"\n                            autoComplete={mode === \"login\" ? \"current-password\" : \"new-password\"}\n                            className=\"sketch-input-field\"\n                        />\n                        <Lock className=\"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-[#2563EB]/40\" />\n                        <button\n                            type=\"button\"\n                            onClick={() => setShowPassword(!showPassword)}\n                            className=\"absolute right-4 top-1/2 -translate-y-1/2 text-[#2563EB]/40\"\n                        >\n                            {showPassword ? (\n                                <EyeOff className=\"w-5 h-5\" />\n                            ) : (\n                                <Eye className=\"w-5 h-5\" />\n                            )}\n                        </button>\n                    </div>\n\n                    {error && (\n                        <div className=\"relative py-3 px-4\">\n                            <svg className=\"absolute inset-0 w-full h-full\" preserveAspectRatio=\"none\">\n                                <path \n                                    d=\"M 2 5 Q 25 2, 50 5 Q 75 2, 98 5 Q 99 30, 98 60 Q 75 63, 50 60 Q 25 63, 2 60 Q 1 30, 2 5 Z\"\n                                    fill=\"#FF3B3010\"\n                                    stroke=\"#FF3B30\"\n                                    strokeWidth=\"1\"\n                                />\n                            </svg>\n                            <p className=\"relative z-10 sketch-body text-[#FF3B30] text-center text-sm\">{error}</p>\n                        </div>\n                    )}\n                </div>\n            </div>\n\n            {/* Submit Button with Sketch UI */}\n            <div className=\"space-y-4\">\n                <button\n                    onClick={mode === \"login\" ? handleLogin : handleSignup}\n                    disabled={isLoading}\n                    className=\"relative w-full h-[60px] group transition-transform active:scale-95 disabled:opacity-50\"\n                >\n                    <svg className=\"absolute inset-0 w-full h-full\" preserveAspectRatio=\"none\">\n                        <path \n                            d=\"M 2 5 Q 25 2, 50 5 Q 75 2, 98 5 Q 99 30, 98 60 Q 75 63, 50 60 Q 25 63, 2 60 Q 1 30, 2 5 Z\"\n                            fill=\"#2563EB\"\n                            stroke=\"#1E40AF\"\n                            strokeWidth=\"2\"\n                        />\n                    </svg>\n                    <span className=\"relative z-10 text-white sketch-subheading text-lg flex items-center justify-center gap-2\">\n                        {isLoading && <Loader2 className=\"w-5 h-5 animate-spin\" />}\n                        {mode === \"login\" ? \"Anmelden\" : \"Registrieren\"}\n                    </span>\n                </button>\n\n                <button\n                    onClick={() => setMode(mode === \"login\" ? \"signup\" : \"login\")}\n                    className=\"w-full py-2 sketch-body text-[#2563EB] hover:text-[#1E40AF] transition-colors\"\n                >\n                    {mode === \"login\"\n                        ? \"Noch kein Konto? Registrieren\"\n                        : \"Bereits ein Konto? Anmelden\"}\n                </button>\n            </div>\n\n            <style jsx>{`\n                .sketch-input-field {\n                    width: 100%;\n                    height: 54px;\n                    background-color: transparent;\n                    border: 2px solid #2563EB;\n                    border-radius: 12px;\n                    padding-left: 3rem;\n                    padding-right: 1rem;\n                    font-family: 'Architects Daughter', cursive;\n                    font-size: 17px;\n                    color: #1D1D1F;\n                    transition: border-color 0.2s;\n                }\n                .sketch-input-field:focus {\n                    outline: none;\n                    border-color: #1E40AF;\n                }\n                .sketch-input-field::placeholder {\n                    color: #8E8E93;\n                }\n            `}</style>\n        </div>\n    );\n}\n\nfunction FeatureItem({ icon, text }: { icon: \"lock\" | \"smartphone\" | \"cloud\"; text: string }) {\n    return (\n        <div className=\"relative group\">\n            {/* Hand-drawn border for feature item */}\n            <svg className=\"absolute inset-0 w-full h-full\" preserveAspectRatio=\"none\">\n                <path \n                    d=\"M 2 2 Q 25 -1, 50 2 Q 75 -1, 98 2 Q 100 25, 98 50 Q 75 53, 50 50 Q 25 53, 2 50 Q 0 25, 2 2 Z\"\n                    fill=\"white\"\n                    stroke=\"#2563EB40\"\n                    strokeWidth=\"1.5\"\n                />\n            </svg>\n            <div className=\"relative z-10 flex items-center gap-4 p-4\">\n                <div className=\"w-10 h-10 rounded-full flex items-center justify-center\">\n                    <CustomIcon name={icon} size={24} className=\"text-[#2563EB]\" />\n                </div>\n                <span className=\"sketch-body text-base text-[#1E40AF]\">{text}</span>\n            </div>\n        </div>\n    );\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 809, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/lib/crypto.ts"],"sourcesContent":["/**\n * Crypto Layer - Client-Side Encryption mit tweetnacl\n * Alle Daten werden VOR dem Upload verschlüsselt\n */\n\nimport nacl from 'tweetnacl';\nimport { encodeBase64, decodeBase64 } from 'tweetnacl-util';\n\nexport interface EncryptionKey {\n    publicKey: Uint8Array;\n    secretKey: Uint8Array;\n}\n\nexport interface EncryptedData {\n    ciphertext: string; // Base64\n    nonce: string; // Base64\n}\n\n/**\n * Generiert ein neues Encryption Key Pair\n */\nexport function generateKeyPair(): EncryptionKey {\n    const keyPair = nacl.box.keyPair();\n    return {\n        publicKey: keyPair.publicKey,\n        secretKey: keyPair.secretKey,\n    };\n}\n\n/**\n * Generiert eine 12-Wort Recovery Phrase aus dem Secret Key\n * Vereinfachte Version - in Production würde man BIP39 verwenden\n */\nexport function keyToRecoveryPhrase(secretKey: Uint8Array): string {\n    const base64 = encodeBase64(secretKey);\n    // Für MVP: Base64 in Chunks aufteilen\n    // TODO: BIP39 Wordlist für bessere UX\n    return base64.match(/.{1,8}/g)?.join('-') || base64;\n}\n\n/**\n * Recovered Secret Key aus Recovery Phrase\n */\nexport function recoveryPhraseToKey(phrase: string): Uint8Array {\n    const base64 = phrase.replace(/-/g, '');\n    return decodeBase64(base64);\n}\n\n/**\n * Verschlüsselt Daten (Uint8Array) mit dem Secret Key\n */\nexport function encrypt(\n    data: Uint8Array,\n    secretKey: Uint8Array\n): EncryptedData {\n    const nonce = nacl.randomBytes(nacl.secretbox.nonceLength);\n    const ciphertext = nacl.secretbox(data, nonce, secretKey);\n\n    return {\n        ciphertext: encodeBase64(ciphertext),\n        nonce: encodeBase64(nonce),\n    };\n}\n\n/**\n * Entschlüsselt Daten\n */\nexport function decrypt(\n    encrypted: EncryptedData,\n    secretKey: Uint8Array\n): Uint8Array | null {\n    const ciphertext = decodeBase64(encrypted.ciphertext);\n    const nonce = decodeBase64(encrypted.nonce);\n\n    const decrypted = nacl.secretbox.open(ciphertext, nonce, secretKey);\n    return decrypted;\n}\n\n/**\n * Verschlüsselt ein File (Blob/File) und gibt encrypted Blob zurück\n */\nexport async function encryptFile(\n    file: File,\n    secretKey: Uint8Array\n): Promise<{ encrypted: Blob; nonce: string }> {\n    const arrayBuffer = await file.arrayBuffer();\n    const data = new Uint8Array(arrayBuffer);\n\n    const encrypted = encrypt(data, secretKey);\n\n    // Konvertiere Base64 zurück zu Blob für Storage\n    const ciphertextBytes = decodeBase64(encrypted.ciphertext);\n    const blob = new Blob([ciphertextBytes], { type: 'application/octet-stream' });\n\n    return {\n        encrypted: blob,\n        nonce: encrypted.nonce,\n    };\n}\n\n/**\n * Entschlüsselt ein Blob zurück zum Original\n */\nexport async function decryptFile(\n    encryptedBlob: Blob,\n    nonce: string,\n    secretKey: Uint8Array,\n    originalMimeType: string\n): Promise<Blob | null> {\n    const arrayBuffer = await encryptedBlob.arrayBuffer();\n    const ciphertext = new Uint8Array(arrayBuffer);\n\n    const encrypted: EncryptedData = {\n        ciphertext: encodeBase64(ciphertext),\n        nonce,\n    };\n\n    const decrypted = decrypt(encrypted, secretKey);\n    if (!decrypted) return null;\n\n    return new Blob([decrypted], { type: originalMimeType });\n}\n\n/**\n * Generiert einen stabilen Hash aus dem Secret Key für die Gruppierung von Geräten/Daten\n */\nexport async function getUserKeyHash(secretKey: Uint8Array): Promise<string> {\n    const msgUint8 = new TextEncoder().encode(encodeBase64(secretKey));\n    const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);\n    const hashArray = Array.from(new Uint8Array(hashBuffer));\n    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').slice(0, 16);\n}\n\n/**\n * Speichert Secret Key verschlüsselt im LocalStorage\n * Verwendet ein Master Password (optional für MVP)\n */\nexport function saveKeyToStorage(secretKey: Uint8Array, password?: string): void {\n    if (password) {\n        // TODO: Key Derivation mit PBKDF2\n        // Für MVP: Direkt speichern\n    }\n\n    const encoded = encodeBase64(secretKey);\n    localStorage.setItem('photovault_secret_key', encoded);\n}\n\n/**\n * Lädt Secret Key aus LocalStorage\n */\nexport function loadKeyFromStorage(): Uint8Array | null {\n    const encoded = localStorage.getItem('photovault_secret_key');\n    if (!encoded) return null;\n\n    try {\n        return decodeBase64(encoded);\n    } catch {\n        return null;\n    }\n}\n\n/**\n * Löscht Key aus Storage (Logout)\n */\nexport function clearKeyFromStorage(): void {\n    localStorage.removeItem('photovault_secret_key');\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;CAGC,GAED;AACA;;;AAeO,SAAS;IACZ,MAAM,UAAU,oJAAI,CAAC,GAAG,CAAC,OAAO;IAChC,OAAO;QACH,WAAW,QAAQ,SAAS;QAC5B,WAAW,QAAQ,SAAS;IAChC;AACJ;AAMO,SAAS,oBAAoB,SAAqB;IACrD,MAAM,SAAS,IAAA,iKAAY,EAAC;IAC5B,sCAAsC;IACtC,sCAAsC;IACtC,OAAO,OAAO,KAAK,CAAC,YAAY,KAAK,QAAQ;AACjD;AAKO,SAAS,oBAAoB,MAAc;IAC9C,MAAM,SAAS,OAAO,OAAO,CAAC,MAAM;IACpC,OAAO,IAAA,iKAAY,EAAC;AACxB;AAKO,SAAS,QACZ,IAAgB,EAChB,SAAqB;IAErB,MAAM,QAAQ,oJAAI,CAAC,WAAW,CAAC,oJAAI,CAAC,SAAS,CAAC,WAAW;IACzD,MAAM,aAAa,oJAAI,CAAC,SAAS,CAAC,MAAM,OAAO;IAE/C,OAAO;QACH,YAAY,IAAA,iKAAY,EAAC;QACzB,OAAO,IAAA,iKAAY,EAAC;IACxB;AACJ;AAKO,SAAS,QACZ,SAAwB,EACxB,SAAqB;IAErB,MAAM,aAAa,IAAA,iKAAY,EAAC,UAAU,UAAU;IACpD,MAAM,QAAQ,IAAA,iKAAY,EAAC,UAAU,KAAK;IAE1C,MAAM,YAAY,oJAAI,CAAC,SAAS,CAAC,IAAI,CAAC,YAAY,OAAO;IACzD,OAAO;AACX;AAKO,eAAe,YAClB,IAAU,EACV,SAAqB;IAErB,MAAM,cAAc,MAAM,KAAK,WAAW;IAC1C,MAAM,OAAO,IAAI,WAAW;IAE5B,MAAM,YAAY,QAAQ,MAAM;IAEhC,gDAAgD;IAChD,MAAM,kBAAkB,IAAA,iKAAY,EAAC,UAAU,UAAU;IACzD,MAAM,OAAO,IAAI,KAAK;QAAC;KAAgB,EAAE;QAAE,MAAM;IAA2B;IAE5E,OAAO;QACH,WAAW;QACX,OAAO,UAAU,KAAK;IAC1B;AACJ;AAKO,eAAe,YAClB,aAAmB,EACnB,KAAa,EACb,SAAqB,EACrB,gBAAwB;IAExB,MAAM,cAAc,MAAM,cAAc,WAAW;IACnD,MAAM,aAAa,IAAI,WAAW;IAElC,MAAM,YAA2B;QAC7B,YAAY,IAAA,iKAAY,EAAC;QACzB;IACJ;IAEA,MAAM,YAAY,QAAQ,WAAW;IACrC,IAAI,CAAC,WAAW,OAAO;IAEvB,OAAO,IAAI,KAAK;QAAC;KAAU,EAAE;QAAE,MAAM;IAAiB;AAC1D;AAKO,eAAe,eAAe,SAAqB;IACtD,MAAM,WAAW,IAAI,cAAc,MAAM,CAAC,IAAA,iKAAY,EAAC;IACvD,MAAM,aAAa,MAAM,OAAO,MAAM,CAAC,MAAM,CAAC,WAAW;IACzD,MAAM,YAAY,MAAM,IAAI,CAAC,IAAI,WAAW;IAC5C,OAAO,UAAU,GAAG,CAAC,CAAA,IAAK,EAAE,QAAQ,CAAC,IAAI,QAAQ,CAAC,GAAG,MAAM,IAAI,CAAC,IAAI,KAAK,CAAC,GAAG;AACjF;AAMO,SAAS,iBAAiB,SAAqB,EAAE,QAAiB;IACrE,IAAI,UAAU;IACV,kCAAkC;IAClC,4BAA4B;IAChC;IAEA,MAAM,UAAU,IAAA,iKAAY,EAAC;IAC7B,aAAa,OAAO,CAAC,yBAAyB;AAClD;AAKO,SAAS;IACZ,MAAM,UAAU,aAAa,OAAO,CAAC;IACrC,IAAI,CAAC,SAAS,OAAO;IAErB,IAAI;QACA,OAAO,IAAA,iKAAY,EAAC;IACxB,EAAE,OAAM;QACJ,OAAO;IACX;AACJ;AAKO,SAAS;IACZ,aAAa,UAAU,CAAC;AAC5B"}},
    {"offset": {"line": 932, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/components/photovault/UnlockVaultScreen.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState } from \"react\";\nimport { Info } from \"lucide-react\";\nimport { CustomIcon } from \"@/components/ui/custom-icon\";\nimport {\n    recoveryPhraseToKey,\n    saveKeyToStorage,\n    getUserKeyHash,\n} from \"@/lib/crypto\";\n\ninterface UnlockVaultScreenProps {\n    userEmail: string;\n    expectedKeyHash: string | null;\n    onUnlock: (secretKey: Uint8Array, keyHash: string) => void;\n    onCreateNewVault: () => void;\n    onLogout: () => void;\n}\n\nexport function UnlockVaultScreen({\n    userEmail,\n    expectedKeyHash,\n    onUnlock,\n    onCreateNewVault,\n    onLogout,\n}: UnlockVaultScreenProps) {\n    const [phrase, setPhrase] = useState(\"\");\n    const [isUnlocking, setIsUnlocking] = useState(false);\n    const [error, setError] = useState<string | null>(null);\n\n    const handleUnlock = async () => {\n        if (!phrase.trim()) {\n            setError(\"Bitte gib deine Recovery-Phrase ein\");\n            return;\n        }\n\n        setIsUnlocking(true);\n        setError(null);\n\n        try {\n            // Normalize input\n            const normalizedPhrase = phrase\n                .trim()\n                .replace(/[\\s\\n]+/g, \"-\")\n                .replace(/-+/g, \"-\");\n\n            // Try to decode the key\n            const secretKey = recoveryPhraseToKey(normalizedPhrase);\n\n            if (!secretKey || secretKey.length !== 32) {\n                setError(\"Ungueltige Recovery-Phrase\");\n                setIsUnlocking(false);\n                return;\n            }\n\n            // Calculate key hash\n            const keyHash = await getUserKeyHash(secretKey);\n\n            // If user already has a vault, verify the key hash matches\n            if (expectedKeyHash && keyHash !== expectedKeyHash) {\n                setError(\n                    \"Diese Recovery-Phrase gehoert nicht zu diesem Konto. Bitte ueberpruefe deine Eingabe.\"\n                );\n                setIsUnlocking(false);\n                return;\n            }\n\n            // Save key to local storage\n            saveKeyToStorage(secretKey);\n\n            // Success\n            onUnlock(secretKey, keyHash);\n        } catch (err) {\n            console.error(\"Unlock error:\", err);\n            setError(\"Ungueltige Recovery-Phrase. Bitte ueberpruefe deine Eingabe.\");\n        } finally {\n            setIsUnlocking(false);\n        }\n    };\n\n    return (\n        <div className=\"min-h-screen flex flex-col px-6 pt-12 pb-8 safe-area-inset bg-[#F2F2F7]\">\n            {/* Header */}\n            <div className=\"flex items-center justify-between mb-8\">\n                <div className=\"text-[13px] text-[#6E6E73]\">\n                    Angemeldet als\n                    <br />\n                    <span className=\"text-[#1D1D1F] font-medium\">{userEmail}</span>\n                </div>\n                <button\n                    onClick={onLogout}\n                    className=\"text-[#FF3B30] text-[15px] ios-tap-target\"\n                >\n                    Abmelden\n                </button>\n            </div>\n\n            <div className=\"flex-1 flex flex-col\">\n                {/* Icon & Title */}\n                <div className=\"flex flex-col items-center text-center mb-8\">\n                    <div className=\"w-20 h-20 rounded-full bg-[#007AFF]/10 flex items-center justify-center mb-6\">\n                        <CustomIcon name=\"lock\" size={40} />\n                    </div>\n                    <h1 className=\"sf-pro-display text-[28px] font-bold text-[#1D1D1F] mb-2\">\n                        Vault entsperren\n                    </h1>\n                    <p className=\"text-[15px] text-[#6E6E73] max-w-[300px]\">\n                        {expectedKeyHash\n                            ? \"Gib deine Recovery-Phrase ein, um auf deine verschluesselten Fotos zuzugreifen\"\n                            : \"Du hast noch keinen Vault. Erstelle einen neuen oder stelle einen bestehenden wieder her.\"}\n                    </p>\n                </div>\n\n                {/* Recovery Phrase Input */}\n                <div className=\"mb-6\">\n                    <label className=\"text-[13px] text-[#6E6E73] mb-2 block\">\n                        Recovery-Phrase (12 Woerter)\n                    </label>\n                    <textarea\n                        value={phrase}\n                        onChange={(e) => {\n                            setPhrase(e.target.value);\n                            setError(null);\n                        }}\n                        placeholder=\"abc123XY-def456AB-ghi789CD-...\"\n                        className=\"w-full h-[120px] bg-white rounded-xl p-4 text-[15px] text-[#1D1D1F] font-mono resize-none border border-[#E5E5EA] focus:border-[#007AFF] focus:outline-none transition-colors\"\n                    />\n                    <p className=\"text-[12px] text-[#8E8E93] mt-2\">\n                        Mit Bindestrichen oder Leerzeichen getrennt\n                    </p>\n                </div>\n\n                {error && (\n                    <div className=\"bg-[#FF3B30]/10 rounded-xl p-3 mb-6\">\n                        <p className=\"text-[14px] text-[#FF3B30] text-center\">{error}</p>\n                    </div>\n                )}\n\n                {/* Info Box */}\n                <div className=\"bg-[#007AFF]/5 rounded-xl p-4 mb-6\">\n                    <div className=\"flex items-start gap-3\">\n                        <Info className=\"w-5 h-5 text-[#007AFF] mt-0.5 flex-shrink-0\" />\n                        <div>\n                            <p className=\"text-[13px] text-[#1D1D1F] font-medium mb-1\">\n                                Warum brauche ich die Phrase?\n                            </p>\n                            <p className=\"text-[12px] text-[#6E6E73]\">\n                                Deine Fotos sind lokal verschluesselt. Nur mit der Recovery-Phrase\n                                kannst du sie entschluesseln. Wir speichern sie niemals.\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            {/* Buttons */}\n            <div className=\"space-y-3\">\n                <button\n                    onClick={handleUnlock}\n                    disabled={isUnlocking || !phrase.trim()}\n                    className=\"w-full h-[54px] bg-[#007AFF] text-white text-[17px] font-semibold rounded-2xl ios-tap-target disabled:opacity-50 flex items-center justify-center\"\n                >\n                    {isUnlocking ? (\n                        <div className=\"w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin\" />\n                    ) : (\n                        \"Vault entsperren\"\n                    )}\n                </button>\n\n                {!expectedKeyHash && (\n                    <button\n                        onClick={onCreateNewVault}\n                        className=\"w-full h-[50px] text-[#007AFF] text-[17px] ios-tap-target\"\n                    >\n                        Neuen Vault erstellen\n                    </button>\n                )}\n            </div>\n        </div>\n    );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AACA;AALA;;;;;;AAmBO,SAAS,kBAAkB,EAC9B,SAAS,EACT,eAAe,EACf,QAAQ,EACR,gBAAgB,EAChB,QAAQ,EACa;IACrB,MAAM,CAAC,QAAQ,UAAU,GAAG,IAAA,iNAAQ,EAAC;IACrC,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,iNAAQ,EAAC;IAC/C,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,iNAAQ,EAAgB;IAElD,MAAM,eAAe;QACjB,IAAI,CAAC,OAAO,IAAI,IAAI;YAChB,SAAS;YACT;QACJ;QAEA,eAAe;QACf,SAAS;QAET,IAAI;YACA,kBAAkB;YAClB,MAAM,mBAAmB,OACpB,IAAI,GACJ,OAAO,CAAC,YAAY,KACpB,OAAO,CAAC,OAAO;YAEpB,wBAAwB;YACxB,MAAM,YAAY,IAAA,2IAAmB,EAAC;YAEtC,IAAI,CAAC,aAAa,UAAU,MAAM,KAAK,IAAI;gBACvC,SAAS;gBACT,eAAe;gBACf;YACJ;YAEA,qBAAqB;YACrB,MAAM,UAAU,MAAM,IAAA,sIAAc,EAAC;YAErC,2DAA2D;YAC3D,IAAI,mBAAmB,YAAY,iBAAiB;gBAChD,SACI;gBAEJ,eAAe;gBACf;YACJ;YAEA,4BAA4B;YAC5B,IAAA,wIAAgB,EAAC;YAEjB,UAAU;YACV,SAAS,WAAW;QACxB,EAAE,OAAO,KAAK;YACV,QAAQ,KAAK,CAAC,iBAAiB;YAC/B,SAAS;QACb,SAAU;YACN,eAAe;QACnB;IACJ;IAEA,qBACI,8OAAC;QAAI,WAAU;;0BAEX,8OAAC;gBAAI,WAAU;;kCACX,8OAAC;wBAAI,WAAU;;4BAA6B;0CAExC,8OAAC;;;;;0CACD,8OAAC;gCAAK,WAAU;0CAA8B;;;;;;;;;;;;kCAElD,8OAAC;wBACG,SAAS;wBACT,WAAU;kCACb;;;;;;;;;;;;0BAKL,8OAAC;gBAAI,WAAU;;kCAEX,8OAAC;wBAAI,WAAU;;0CACX,8OAAC;gCAAI,WAAU;0CACX,cAAA,8OAAC,wJAAU;oCAAC,MAAK;oCAAO,MAAM;;;;;;;;;;;0CAElC,8OAAC;gCAAG,WAAU;0CAA2D;;;;;;0CAGzE,8OAAC;gCAAE,WAAU;0CACR,kBACK,mFACA;;;;;;;;;;;;kCAKd,8OAAC;wBAAI,WAAU;;0CACX,8OAAC;gCAAM,WAAU;0CAAwC;;;;;;0CAGzD,8OAAC;gCACG,OAAO;gCACP,UAAU,CAAC;oCACP,UAAU,EAAE,MAAM,CAAC,KAAK;oCACxB,SAAS;gCACb;gCACA,aAAY;gCACZ,WAAU;;;;;;0CAEd,8OAAC;gCAAE,WAAU;0CAAkC;;;;;;;;;;;;oBAKlD,uBACG,8OAAC;wBAAI,WAAU;kCACX,cAAA,8OAAC;4BAAE,WAAU;sCAA0C;;;;;;;;;;;kCAK/D,8OAAC;wBAAI,WAAU;kCACX,cAAA,8OAAC;4BAAI,WAAU;;8CACX,8OAAC,0MAAI;oCAAC,WAAU;;;;;;8CAChB,8OAAC;;sDACG,8OAAC;4CAAE,WAAU;sDAA8C;;;;;;sDAG3D,8OAAC;4CAAE,WAAU;sDAA6B;;;;;;;;;;;;;;;;;;;;;;;;;;;;;0BAU1D,8OAAC;gBAAI,WAAU;;kCACX,8OAAC;wBACG,SAAS;wBACT,UAAU,eAAe,CAAC,OAAO,IAAI;wBACrC,WAAU;kCAET,4BACG,8OAAC;4BAAI,WAAU;;;;;mCAEf;;;;;;oBAIP,CAAC,iCACE,8OAAC;wBACG,SAAS;wBACT,WAAU;kCACb;;;;;;;;;;;;;;;;;;AAOrB"}},
    {"offset": {"line": 1225, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/hooks/use-encryption.ts"],"sourcesContent":["/**\n * useEncryption Hook - Key Management\n */\n\n\"use client\";\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport {\n  generateKeyPair,\n  saveKeyToStorage,\n  loadKeyFromStorage,\n  clearKeyFromStorage,\n  keyToRecoveryPhrase,\n  recoveryPhraseToKey,\n  getUserKeyHash,\n} from \"@/lib/crypto\";\n\nexport function useEncryption() {\n  const [secretKey, setSecretKey] = useState<Uint8Array | null>(null);\n  const [isInitialized, setIsInitialized] = useState(false);\n  const [recoveryPhrase, setRecoveryPhrase] = useState<string | null>(null);\n  const [isGeneratingKey, setIsGeneratingKey] = useState(false);\n  const [userKeyHash, setUserKeyHash] = useState<string | null>(null);\n\n  // Load key on mount\n  useEffect(() => {\n    const loadKey = async () => {\n      const key = loadKeyFromStorage();\n      if (key) {\n        setSecretKey(key);\n        setRecoveryPhrase(keyToRecoveryPhrase(key));\n        const hash = await getUserKeyHash(key);\n        setUserKeyHash(hash);\n      }\n      setIsInitialized(true);\n    };\n    loadKey();\n  }, []);\n\n  // Generate new key\n  const generateNewKey = useCallback((): Promise<string> => {\n    return new Promise((resolve) => {\n      setIsGeneratingKey(true);\n\n      // Simulate key generation time\n      setTimeout(async () => {\n        const keyPair = generateKeyPair();\n        const key = keyPair.secretKey;\n\n        setSecretKey(key);\n        saveKeyToStorage(key);\n\n        const phrase = keyToRecoveryPhrase(key);\n        setRecoveryPhrase(phrase);\n\n        const hash = await getUserKeyHash(key);\n        setUserKeyHash(hash);\n\n        setIsGeneratingKey(false);\n        resolve(phrase);\n      }, 1500);\n    });\n  }, []);\n\n  // Restore from recovery phrase\n  const restoreFromPhrase = useCallback((phrase: string) => {\n    try {\n      const key = recoveryPhraseToKey(phrase);\n      setSecretKey(key);\n      saveKeyToStorage(key);\n      setRecoveryPhrase(phrase);\n      return true;\n    } catch {\n      return false;\n    }\n  }, []);\n\n  // Logout / Clear key\n  const clearKey = useCallback(() => {\n    setSecretKey(null);\n    setRecoveryPhrase(null);\n    clearKeyFromStorage();\n  }, []);\n\n  return {\n    secretKey,\n    isInitialized,\n    hasKey: !!secretKey,\n    recoveryPhrase,\n    userKeyHash,\n    isGeneratingKey,\n    generateNewKey,\n    restoreFromPhrase,\n    clearKey,\n  };\n}\n"],"names":[],"mappings":";;;;AAMA;AACA;AAPA;;CAEC,GAED;;;AAaO,SAAS;IACd,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,iNAAQ,EAAoB;IAC9D,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,iNAAQ,EAAC;IACnD,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,IAAA,iNAAQ,EAAgB;IACpE,MAAM,CAAC,iBAAiB,mBAAmB,GAAG,IAAA,iNAAQ,EAAC;IACvD,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,iNAAQ,EAAgB;IAE9D,oBAAoB;IACpB,IAAA,kNAAS,EAAC;QACR,MAAM,UAAU;YACd,MAAM,MAAM,IAAA,0IAAkB;YAC9B,IAAI,KAAK;gBACP,aAAa;gBACb,kBAAkB,IAAA,2IAAmB,EAAC;gBACtC,MAAM,OAAO,MAAM,IAAA,sIAAc,EAAC;gBAClC,eAAe;YACjB;YACA,iBAAiB;QACnB;QACA;IACF,GAAG,EAAE;IAEL,mBAAmB;IACnB,MAAM,iBAAiB,IAAA,oNAAW,EAAC;QACjC,OAAO,IAAI,QAAQ,CAAC;YAClB,mBAAmB;YAEnB,+BAA+B;YAC/B,WAAW;gBACT,MAAM,UAAU,IAAA,uIAAe;gBAC/B,MAAM,MAAM,QAAQ,SAAS;gBAE7B,aAAa;gBACb,IAAA,wIAAgB,EAAC;gBAEjB,MAAM,SAAS,IAAA,2IAAmB,EAAC;gBACnC,kBAAkB;gBAElB,MAAM,OAAO,MAAM,IAAA,sIAAc,EAAC;gBAClC,eAAe;gBAEf,mBAAmB;gBACnB,QAAQ;YACV,GAAG;QACL;IACF,GAAG,EAAE;IAEL,+BAA+B;IAC/B,MAAM,oBAAoB,IAAA,oNAAW,EAAC,CAAC;QACrC,IAAI;YACF,MAAM,MAAM,IAAA,2IAAmB,EAAC;YAChC,aAAa;YACb,IAAA,wIAAgB,EAAC;YACjB,kBAAkB;YAClB,OAAO;QACT,EAAE,OAAM;YACN,OAAO;QACT;IACF,GAAG,EAAE;IAEL,qBAAqB;IACrB,MAAM,WAAW,IAAA,oNAAW,EAAC;QAC3B,aAAa;QACb,kBAAkB;QAClB,IAAA,2IAAmB;IACrB,GAAG,EAAE;IAEL,OAAO;QACL;QACA;QACA,QAAQ,CAAC,CAAC;QACV;QACA;QACA;QACA;QACA;QACA;IACF;AACF"}},
    {"offset": {"line": 1309, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/components/photovault/VaultSetupScreen.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState } from \"react\";\nimport { Check, Copy, CheckCircle } from \"lucide-react\";\nimport { CustomIcon } from \"@/components/ui/custom-icon\";\nimport ShieldLoader from \"@/components/ui/shield-loader\";\nimport { useEncryption } from \"@/hooks/use-encryption\";\n\ninterface VaultSetupScreenProps {\n    userId: string;\n    onComplete: (keyHash: string) => void;\n    onBack: () => void;\n}\n\ntype SetupStep = \"intro\" | \"generating\" | \"phrase\" | \"confirm\";\n\nexport function VaultSetupScreen({ userId, onComplete, onBack }: VaultSetupScreenProps) {\n    const [step, setStep] = useState<SetupStep>(\"intro\");\n    const [phraseConfirmed, setPhraseConfirmed] = useState(false);\n    const [copied, setCopied] = useState(false);\n\n    const { isGeneratingKey, generateNewKey, recoveryPhrase, userKeyHash } = useEncryption();\n\n    const handleCreateVault = async () => {\n        setStep(\"generating\");\n        try {\n            await generateNewKey();\n            setStep(\"phrase\");\n        } catch (err) {\n            console.error(\"Failed to generate key:\", err);\n            setStep(\"intro\");\n        }\n    };\n\n    const handleCopyPhrase = async () => {\n        if (recoveryPhrase) {\n            await navigator.clipboard.writeText(recoveryPhrase);\n            setCopied(true);\n            setTimeout(() => setCopied(false), 2000);\n        }\n    };\n\n    const handleConfirmPhrase = () => {\n        if (userKeyHash) {\n            onComplete(userKeyHash);\n        }\n    };\n\n    // Parse phrase into words for display\n    const phraseWords = recoveryPhrase?.split(\"-\").slice(0, 12) || [];\n\n    // Show loader during key generation\n    if (step === \"generating\" || isGeneratingKey) {\n        return <ShieldLoader />;\n    }\n\n    // Intro step\n    if (step === \"intro\") {\n        return (\n            <div className=\"min-h-screen flex flex-col px-6 pt-12 pb-8 safe-area-inset bg-[#F2F2F7]\">\n                <button\n                    onClick={onBack}\n                    className=\"self-start text-[#007AFF] text-[17px] mb-8 ios-tap-target\"\n                >\n                    Zurueck\n                </button>\n\n                <div className=\"flex-1 flex flex-col items-center justify-center text-center\">\n                    <div className=\"w-20 h-20 rounded-full bg-[#007AFF]/10 flex items-center justify-center mb-6\">\n                        <CustomIcon name=\"key\" size={40} />\n                    </div>\n\n                    <h1 className=\"sf-pro-display text-[28px] font-bold text-[#1D1D1F] mb-3\">\n                        Erstelle deinen Vault\n                    </h1>\n                    <p className=\"text-[17px] text-[#6E6E73] max-w-[300px] mb-8\">\n                        Dein persoenlicher Verschluesselungsschluessel schuetzt alle deine Fotos\n                    </p>\n\n                    {/* Features */}\n                    <div className=\"w-full max-w-[320px] space-y-3 mb-8\">\n                        <div className=\"bg-white rounded-xl p-4 flex items-start gap-3\">\n                            <div className=\"w-8 h-8 rounded-full bg-[#30D158]/10 flex items-center justify-center flex-shrink-0\">\n                                <CheckCircle className=\"w-5 h-5 text-[#30D158]\" />\n                            </div>\n                            <div className=\"text-left\">\n                                <p className=\"text-[15px] text-[#1D1D1F] font-medium\">Zero-Knowledge</p>\n                                <p className=\"text-[13px] text-[#6E6E73]\">\n                                    Nur du kannst deine Fotos entschluesseln\n                                </p>\n                            </div>\n                        </div>\n\n                        <div className=\"bg-white rounded-xl p-4 flex items-start gap-3\">\n                            <div className=\"w-8 h-8 rounded-full bg-[#30D158]/10 flex items-center justify-center flex-shrink-0\">\n                                <CheckCircle className=\"w-5 h-5 text-[#30D158]\" />\n                            </div>\n                            <div className=\"text-left\">\n                                <p className=\"text-[15px] text-[#1D1D1F] font-medium\">Recovery-Phrase</p>\n                                <p className=\"text-[13px] text-[#6E6E73]\">\n                                    12 Woerter zum Wiederherstellen auf neuen Geraeten\n                                </p>\n                            </div>\n                        </div>\n\n                        <div className=\"bg-white rounded-xl p-4 flex items-start gap-3\">\n                            <div className=\"w-8 h-8 rounded-full bg-[#30D158]/10 flex items-center justify-center flex-shrink-0\">\n                                <CheckCircle className=\"w-5 h-5 text-[#30D158]\" />\n                            </div>\n                            <div className=\"text-left\">\n                                <p className=\"text-[15px] text-[#1D1D1F] font-medium\">Multi-Device</p>\n                                <p className=\"text-[13px] text-[#6E6E73]\">\n                                    Synchronisiere bis zu 3 Geraete\n                                </p>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                <button\n                    onClick={handleCreateVault}\n                    className=\"w-full h-[54px] bg-[#007AFF] text-white text-[17px] font-semibold rounded-2xl ios-tap-target shadow-lg shadow-[#007AFF]/25\"\n                >\n                    Vault erstellen\n                </button>\n            </div>\n        );\n    }\n\n    // Show recovery phrase\n    if (step === \"phrase\") {\n        return (\n            <div className=\"min-h-screen flex flex-col px-6 pt-12 pb-8 safe-area-inset bg-[#F2F2F7]\">\n                <div className=\"flex-1\">\n                    <div className=\"text-center mb-6\">\n                        <h1 className=\"sf-pro-display text-[28px] font-bold text-[#1D1D1F] mb-2\">\n                            Deine Recovery-Phrase\n                        </h1>\n                        <p className=\"text-[15px] text-[#6E6E73]\">\n                            Notiere diese Woerter sicher. Du brauchst sie zur Wiederherstellung.\n                        </p>\n                    </div>\n\n                    {/* 12 words in 3x4 grid */}\n                    <div className=\"grid grid-cols-3 gap-2 mb-4\">\n                        {phraseWords.map((word, index) => (\n                            <div\n                                key={index}\n                                className=\"bg-white rounded-lg p-3 text-center border border-[#E5E5EA]\"\n                            >\n                                <span className=\"text-[11px] text-[#8E8E93] block mb-0.5\">\n                                    {index + 1}\n                                </span>\n                                <span className=\"text-[14px] text-[#1D1D1F] font-mono break-all\">\n                                    {word}\n                                </span>\n                            </div>\n                        ))}\n                    </div>\n\n                    {/* Copy button */}\n                    <button\n                        onClick={handleCopyPhrase}\n                        className=\"w-full flex items-center justify-center gap-2 py-3 text-[#007AFF] text-[15px] ios-tap-target mb-4\"\n                    >\n                        {copied ? (\n                            <>\n                                <Check className=\"w-5 h-5\" />\n                                Kopiert!\n                            </>\n                        ) : (\n                            <>\n                                <Copy className=\"w-5 h-5\" />\n                                Phrase kopieren\n                            </>\n                        )}\n                    </button>\n\n                    {/* Warning */}\n                    <div className=\"bg-[#FF3B30]/10 rounded-xl p-4 mb-6\">\n                        <p className=\"text-[13px] text-[#FF3B30] text-center\">\n                            Teile diese Woerter niemals mit anderen. Wer sie hat, kann auf deine\n                            Fotos zugreifen.\n                        </p>\n                    </div>\n\n                    {/* Checkbox */}\n                    <button\n                        onClick={() => setPhraseConfirmed(!phraseConfirmed)}\n                        className=\"w-full flex items-center gap-3 p-4 bg-white rounded-xl ios-tap-target\"\n                    >\n                        <div\n                            className={`w-6 h-6 rounded-md border-2 flex items-center justify-center transition-colors ${\n                                phraseConfirmed ? \"bg-[#007AFF] border-[#007AFF]\" : \"border-[#C7C7CC]\"\n                            }`}\n                        >\n                            {phraseConfirmed && <Check className=\"w-4 h-4 text-white\" />}\n                        </div>\n                        <span className=\"text-[17px] text-[#1D1D1F]\">\n                            Ich habe die Woerter sicher gespeichert\n                        </span>\n                    </button>\n                </div>\n\n                <button\n                    onClick={handleConfirmPhrase}\n                    disabled={!phraseConfirmed}\n                    className={`w-full h-[54px] text-[17px] font-semibold rounded-2xl ios-tap-target transition-colors ${\n                        phraseConfirmed\n                            ? \"bg-[#007AFF] text-white shadow-lg shadow-[#007AFF]/25\"\n                            : \"bg-[#E5E5EA] text-[#8E8E93]\"\n                    }`}\n                >\n                    Weiter\n                </button>\n            </div>\n        );\n    }\n\n    return null;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1796, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/lib/supabase.ts"],"sourcesContent":["/**\n * Supabase Layer - Metadata-Only Storage\n * Supabase stores ONLY photo metadata and device info, NOT the actual content\n * Content is stored on IPFS (see ipfs.ts and remote-storage.ts)\n */\n\nimport { createClient } from '@supabase/supabase-js'\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey)\n\n// Type definitions for our tables\nexport interface PhotoMetadata {\n  id?: string\n  cid: string              // IPFS Content Identifier (the actual photo is on IPFS)\n  device_id: string        // Which device uploaded this\n  file_size_bytes?: number // Original file size\n  nonce?: string           // Encryption nonce (Base64)\n  mime_type?: string       // Original MIME type\n  user_key_hash?: string   // Hash of user's encryption key (for multi-device sync)\n  uploaded_at?: string     // When it was uploaded\n}\n\nexport interface Device {\n  id?: string\n  device_name: string\n  device_type?: string\n  user_key_hash?: string   // Links device to user's encryption key\n  created_at?: string\n}\n\n/**\n * Upload photo metadata to Supabase (metadata only, NOT the actual photo)\n * The actual encrypted photo is stored on IPFS\n * Uses API proxy to avoid CORS issues on Safari/iOS\n */\nexport async function uploadCIDMetadata(\n  cid: string,\n  fileSize: number,\n  deviceId: string,\n  nonce?: string,\n  mimeType?: string,\n  userKeyHash?: string\n) {\n  console.log('[Supabase] Uploading metadata:', {\n    cid,\n    deviceId,\n    mimeType,\n    fileSize,\n    hasUserKeyHash: !!userKeyHash,\n  });\n\n  // Try API proxy first (avoids CORS issues)\n  try {\n    const response = await fetch('/api/supabase/proxy', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        action: 'uploadMetadata',\n        cid,\n        fileSize,\n        deviceId,\n        nonce,\n        mimeType,\n        userKeyHash,\n      }),\n    });\n\n    const result = await response.json();\n    if (result.success) {\n      console.log('[Supabase] Metadata uploaded via proxy:', result.data?.[0]?.id);\n      return result.data;\n    }\n\n    console.warn('[Supabase] Proxy failed, trying direct client:', result.error);\n  } catch (err) {\n    console.warn('[Supabase] Proxy error, trying direct client:', err);\n  }\n\n  // Fallback to direct client\n  const { data, error } = await supabase\n    .from('photos_metadata')\n    .insert([{\n      cid,\n      file_size_bytes: fileSize,\n      device_id: deviceId,\n      nonce,\n      mime_type: mimeType,\n      user_key_hash: userKeyHash\n    }])\n    .select()\n\n  if (error) {\n    console.error('[Supabase] Metadata Upload Error:', {\n      code: error.code,\n      message: error.message,\n      details: error.details,\n      hint: error.hint,\n    });\n    throw error\n  }\n\n  console.log('[Supabase] Metadata uploaded successfully:', data?.[0]?.id);\n  return data\n}\n\n/**\n * Load all photo CIDs from Supabase for a user\n * Photos are identified by CID and can be fetched from IPFS\n * Uses API proxy to avoid CORS issues on Safari/iOS\n */\nexport async function loadCIDsFromSupabase(_currentDeviceId: string, userKeyHash: string) {\n  if (!userKeyHash) {\n    console.error('loadCIDsFromSupabase: userKeyHash is required');\n    return [];\n  }\n\n  // Try API proxy first (avoids CORS issues)\n  try {\n    const response = await fetch('/api/supabase/proxy', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        action: 'loadCIDs',\n        userKeyHash,\n      }),\n    });\n\n    const result = await response.json();\n    if (result.success) {\n      console.log('[Supabase] CIDs loaded via proxy:', result.data?.length);\n      return result.data || [];\n    }\n\n    console.warn('[Supabase] Proxy failed, trying direct client:', result.error);\n  } catch (err) {\n    console.warn('[Supabase] Proxy error, trying direct client:', err);\n  }\n\n  // Fallback to direct client\n  const { data, error } = await supabase\n    .from('photos_metadata')\n    .select('cid, device_id, uploaded_at, file_size_bytes, nonce, mime_type')\n    .eq('user_key_hash', userKeyHash)\n    .order('uploaded_at', { ascending: false })\n\n  if (error) {\n    console.error('Supabase Load Error:', error)\n    throw error\n  }\n  return data || []\n}\n\n/**\n * Check if CID already exists in Supabase for THIS user\n */\nexport async function cidExistsInSupabase(cid: string, userKeyHash: string): Promise<boolean> {\n  if (!userKeyHash) return false;\n\n  const { data, error } = await supabase\n    .from('photos_metadata')\n    .select('id')\n    .eq('cid', cid)\n    .eq('user_key_hash', userKeyHash)\n    .single()\n\n  if (error && error.code !== 'PGRST116') {\n    // PGRST116 = no rows returned, which is expected\n    console.error('Supabase Check Error:', error)\n  }\n  return !!data\n}\n\n/**\n * Delete photo metadata from Supabase\n * Uses API proxy to avoid CORS issues on Safari/iOS\n */\nexport async function deletePhotoMetadata(cid: string): Promise<void> {\n  // Try API proxy first (avoids CORS issues)\n  try {\n    const response = await fetch('/api/supabase/proxy', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        action: 'deleteMetadata',\n        cid,\n      }),\n    });\n\n    const result = await response.json();\n    if (result.success) {\n      console.log('[Supabase] Metadata deleted via proxy');\n      return;\n    }\n\n    console.warn('[Supabase] Proxy failed, trying direct client:', result.error);\n  } catch (err) {\n    console.warn('[Supabase] Proxy error, trying direct client:', err);\n  }\n\n  // Fallback to direct client\n  const { error } = await supabase\n    .from('photos_metadata')\n    .delete()\n    .eq('cid', cid)\n\n  if (error) {\n    console.error('Supabase Delete Error:', error)\n    throw error\n  }\n}\n\n/**\n * Register or update a device\n * IMPORTANT: userKeyHash and userId are required for RLS/BetterAuth compliance\n * Uses API proxy to avoid CORS issues on Safari/iOS\n */\nexport async function registerDevice(\n  id: string,\n  deviceName: string,\n  deviceType?: string,\n  userKeyHash?: string,\n  userId?: string\n) {\n  // Validate userKeyHash - required for RLS\n  if (!userKeyHash || userKeyHash.length === 0) {\n    console.error('registerDevice: userKeyHash is required');\n    throw new Error('userKeyHash is required for device registration');\n  }\n\n  // Try API proxy first (avoids CORS issues)\n  try {\n    const response = await fetch('/api/supabase/proxy', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        action: 'registerDevice',\n        id,\n        deviceName,\n        deviceType,\n        userKeyHash,\n        userId,\n      }),\n    });\n\n    const result = await response.json();\n    if (result.success) {\n      console.log('[Supabase] Device registered via proxy:', result.updated ? 'updated' : 'inserted');\n      return true;\n    }\n\n    console.warn('[Supabase] Proxy failed, trying direct client:', result.error);\n  } catch (err) {\n    console.warn('[Supabase] Proxy error, trying direct client:', err);\n  }\n\n  // Fallback to direct client\n  const devicePayload = {\n    device_name: deviceName,\n    device_type: deviceType,\n    user_key_hash: userKeyHash,\n    user_id: userId\n  };\n\n  const { data: existingDevice } = await supabase\n    .from('devices')\n    .select('id')\n    .eq('user_id', userId)\n    .eq('device_name', deviceName)\n    .eq('device_type', deviceType || '')\n    .single();\n\n  if (existingDevice) {\n    const { error: updateError } = await supabase\n      .from('devices')\n      .update({\n        device_name: deviceName,\n        device_type: deviceType,\n        user_key_hash: userKeyHash,\n      })\n      .eq('id', existingDevice.id);\n\n    if (updateError) {\n      console.error('[Supabase] Device Update Error:', updateError);\n      throw updateError;\n    }\n    console.log('[Supabase] Device updated:', existingDevice.id);\n    return true;\n  }\n\n  const { error } = await supabase\n    .from('devices')\n    .insert({\n      id,\n      ...devicePayload\n    });\n\n  if (error) {\n    if (error.message?.includes('Device limit exceeded')) {\n      throw new Error('DEVICE_LIMIT_EXCEEDED');\n    }\n    console.error('[Supabase] Device Insert Error:', error);\n    throw error;\n  }\n  console.log('[Supabase] Device inserted:', id);\n  return true;\n}\n\n/**\n * Get all devices for a user (by user_key_hash)\n */\nexport async function getDevicesForUser(userKeyHash: string): Promise<Device[]> {\n  const { data, error } = await supabase\n    .from('devices')\n    .select('*')\n    .eq('user_key_hash', userKeyHash)\n    .order('created_at', { ascending: false })\n\n  if (error) {\n    console.error('Supabase Get Devices Error:', error)\n    throw error\n  }\n  return data || []\n}\n\n/**\n * Get photo metadata by CID\n */\nexport async function getPhotoMetadataByCID(cid: string): Promise<PhotoMetadata | null> {\n  const { data, error } = await supabase\n    .from('photos_metadata')\n    .select('*')\n    .eq('cid', cid)\n    .single()\n\n  if (error && error.code !== 'PGRST116') {\n    console.error('Supabase Get Photo Error:', error)\n    throw error\n  }\n\n  return data\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAAA;;;;CAIC,GAED;;AAEA,MAAM;AACN,MAAM;AAEC,MAAM,WAAW,IAAA,uMAAY,EAAC,aAAa;AA2B3C,eAAe,kBACpB,GAAW,EACX,QAAgB,EAChB,QAAgB,EAChB,KAAc,EACd,QAAiB,EACjB,WAAoB;IAEpB,QAAQ,GAAG,CAAC,kCAAkC;QAC5C;QACA;QACA;QACA;QACA,gBAAgB,CAAC,CAAC;IACpB;IAEA,2CAA2C;IAC3C,IAAI;QACF,MAAM,WAAW,MAAM,MAAM,uBAAuB;YAClD,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAmB;YAC9C,MAAM,KAAK,SAAS,CAAC;gBACnB,QAAQ;gBACR;gBACA;gBACA;gBACA;gBACA;gBACA;YACF;QACF;QAEA,MAAM,SAAS,MAAM,SAAS,IAAI;QAClC,IAAI,OAAO,OAAO,EAAE;YAClB,QAAQ,GAAG,CAAC,2CAA2C,OAAO,IAAI,EAAE,CAAC,EAAE,EAAE;YACzE,OAAO,OAAO,IAAI;QACpB;QAEA,QAAQ,IAAI,CAAC,kDAAkD,OAAO,KAAK;IAC7E,EAAE,OAAO,KAAK;QACZ,QAAQ,IAAI,CAAC,iDAAiD;IAChE;IAEA,4BAA4B;IAC5B,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,mBACL,MAAM,CAAC;QAAC;YACP;YACA,iBAAiB;YACjB,WAAW;YACX;YACA,WAAW;YACX,eAAe;QACjB;KAAE,EACD,MAAM;IAET,IAAI,OAAO;QACT,QAAQ,KAAK,CAAC,qCAAqC;YACjD,MAAM,MAAM,IAAI;YAChB,SAAS,MAAM,OAAO;YACtB,SAAS,MAAM,OAAO;YACtB,MAAM,MAAM,IAAI;QAClB;QACA,MAAM;IACR;IAEA,QAAQ,GAAG,CAAC,8CAA8C,MAAM,CAAC,EAAE,EAAE;IACrE,OAAO;AACT;AAOO,eAAe,qBAAqB,gBAAwB,EAAE,WAAmB;IACtF,IAAI,CAAC,aAAa;QAChB,QAAQ,KAAK,CAAC;QACd,OAAO,EAAE;IACX;IAEA,2CAA2C;IAC3C,IAAI;QACF,MAAM,WAAW,MAAM,MAAM,uBAAuB;YAClD,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAmB;YAC9C,MAAM,KAAK,SAAS,CAAC;gBACnB,QAAQ;gBACR;YACF;QACF;QAEA,MAAM,SAAS,MAAM,SAAS,IAAI;QAClC,IAAI,OAAO,OAAO,EAAE;YAClB,QAAQ,GAAG,CAAC,qCAAqC,OAAO,IAAI,EAAE;YAC9D,OAAO,OAAO,IAAI,IAAI,EAAE;QAC1B;QAEA,QAAQ,IAAI,CAAC,kDAAkD,OAAO,KAAK;IAC7E,EAAE,OAAO,KAAK;QACZ,QAAQ,IAAI,CAAC,iDAAiD;IAChE;IAEA,4BAA4B;IAC5B,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,mBACL,MAAM,CAAC,kEACP,EAAE,CAAC,iBAAiB,aACpB,KAAK,CAAC,eAAe;QAAE,WAAW;IAAM;IAE3C,IAAI,OAAO;QACT,QAAQ,KAAK,CAAC,wBAAwB;QACtC,MAAM;IACR;IACA,OAAO,QAAQ,EAAE;AACnB;AAKO,eAAe,oBAAoB,GAAW,EAAE,WAAmB;IACxE,IAAI,CAAC,aAAa,OAAO;IAEzB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,mBACL,MAAM,CAAC,MACP,EAAE,CAAC,OAAO,KACV,EAAE,CAAC,iBAAiB,aACpB,MAAM;IAET,IAAI,SAAS,MAAM,IAAI,KAAK,YAAY;QACtC,iDAAiD;QACjD,QAAQ,KAAK,CAAC,yBAAyB;IACzC;IACA,OAAO,CAAC,CAAC;AACX;AAMO,eAAe,oBAAoB,GAAW;IACnD,2CAA2C;IAC3C,IAAI;QACF,MAAM,WAAW,MAAM,MAAM,uBAAuB;YAClD,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAmB;YAC9C,MAAM,KAAK,SAAS,CAAC;gBACnB,QAAQ;gBACR;YACF;QACF;QAEA,MAAM,SAAS,MAAM,SAAS,IAAI;QAClC,IAAI,OAAO,OAAO,EAAE;YAClB,QAAQ,GAAG,CAAC;YACZ;QACF;QAEA,QAAQ,IAAI,CAAC,kDAAkD,OAAO,KAAK;IAC7E,EAAE,OAAO,KAAK;QACZ,QAAQ,IAAI,CAAC,iDAAiD;IAChE;IAEA,4BAA4B;IAC5B,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,mBACL,MAAM,GACN,EAAE,CAAC,OAAO;IAEb,IAAI,OAAO;QACT,QAAQ,KAAK,CAAC,0BAA0B;QACxC,MAAM;IACR;AACF;AAOO,eAAe,eACpB,EAAU,EACV,UAAkB,EAClB,UAAmB,EACnB,WAAoB,EACpB,MAAe;IAEf,0CAA0C;IAC1C,IAAI,CAAC,eAAe,YAAY,MAAM,KAAK,GAAG;QAC5C,QAAQ,KAAK,CAAC;QACd,MAAM,IAAI,MAAM;IAClB;IAEA,2CAA2C;IAC3C,IAAI;QACF,MAAM,WAAW,MAAM,MAAM,uBAAuB;YAClD,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAmB;YAC9C,MAAM,KAAK,SAAS,CAAC;gBACnB,QAAQ;gBACR;gBACA;gBACA;gBACA;gBACA;YACF;QACF;QAEA,MAAM,SAAS,MAAM,SAAS,IAAI;QAClC,IAAI,OAAO,OAAO,EAAE;YAClB,QAAQ,GAAG,CAAC,2CAA2C,OAAO,OAAO,GAAG,YAAY;YACpF,OAAO;QACT;QAEA,QAAQ,IAAI,CAAC,kDAAkD,OAAO,KAAK;IAC7E,EAAE,OAAO,KAAK;QACZ,QAAQ,IAAI,CAAC,iDAAiD;IAChE;IAEA,4BAA4B;IAC5B,MAAM,gBAAgB;QACpB,aAAa;QACb,aAAa;QACb,eAAe;QACf,SAAS;IACX;IAEA,MAAM,EAAE,MAAM,cAAc,EAAE,GAAG,MAAM,SACpC,IAAI,CAAC,WACL,MAAM,CAAC,MACP,EAAE,CAAC,WAAW,QACd,EAAE,CAAC,eAAe,YAClB,EAAE,CAAC,eAAe,cAAc,IAChC,MAAM;IAET,IAAI,gBAAgB;QAClB,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,WACL,MAAM,CAAC;YACN,aAAa;YACb,aAAa;YACb,eAAe;QACjB,GACC,EAAE,CAAC,MAAM,eAAe,EAAE;QAE7B,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,mCAAmC;YACjD,MAAM;QACR;QACA,QAAQ,GAAG,CAAC,8BAA8B,eAAe,EAAE;QAC3D,OAAO;IACT;IAEA,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,WACL,MAAM,CAAC;QACN;QACA,GAAG,aAAa;IAClB;IAEF,IAAI,OAAO;QACT,IAAI,MAAM,OAAO,EAAE,SAAS,0BAA0B;YACpD,MAAM,IAAI,MAAM;QAClB;QACA,QAAQ,KAAK,CAAC,mCAAmC;QACjD,MAAM;IACR;IACA,QAAQ,GAAG,CAAC,+BAA+B;IAC3C,OAAO;AACT;AAKO,eAAe,kBAAkB,WAAmB;IACzD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,WACL,MAAM,CAAC,KACP,EAAE,CAAC,iBAAiB,aACpB,KAAK,CAAC,cAAc;QAAE,WAAW;IAAM;IAE1C,IAAI,OAAO;QACT,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,MAAM;IACR;IACA,OAAO,QAAQ,EAAE;AACnB;AAKO,eAAe,sBAAsB,GAAW;IACrD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,mBACL,MAAM,CAAC,KACP,EAAE,CAAC,OAAO,KACV,MAAM;IAET,IAAI,SAAS,MAAM,IAAI,KAAK,YAAY;QACtC,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,MAAM;IACR;IAEA,OAAO;AACT"}},
    {"offset": {"line": 2042, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/lib/ipfs.ts"],"sourcesContent":["/**\n * IPFS Layer - Content-Addressed Storage with Pinata Remote Pinning\n * All encrypted blobs are stored on IPFS with CIDs\n */\n\n// Pinata Configuration\nconst PINATA_JWT = process.env.NEXT_PUBLIC_PINATA_JWT || '';\nconst PINATA_GATEWAY = process.env.NEXT_PUBLIC_PINATA_GATEWAY || 'https://gateway.pinata.cloud';\nconst PINATA_GATEWAY_TOKEN = process.env.NEXT_PUBLIC_PINATA_GATEWAY_TOKEN || '';\n\n// API Endpoints\nconst PINATA_PIN_URL = 'https://api.pinata.cloud/pinning/pinFileToIPFS';\nconst PINATA_UNPIN_URL = 'https://api.pinata.cloud/pinning/unpin';\n\n/**\n * Helper: Get the full gateway base URL\n */\nfunction getGatewayBase(): string {\n    if (PINATA_GATEWAY.startsWith('http')) return PINATA_GATEWAY;\n\n    // If it's just a subdomain or already includes mypinata.cloud but lacks protocol\n    if (PINATA_GATEWAY.includes('.')) {\n        return `https://${PINATA_GATEWAY}`;\n    }\n\n    // Default to mypinata.cloud for simple subdomain strings\n    return `https://${PINATA_GATEWAY}.mypinata.cloud`;\n}\n\n/**\n * Generate a real IPFS CID by uploading to Pinata\n * Returns the CID (Content Identifier) that uniquely identifies this blob\n */\nexport async function uploadToIPFS(\n    blob: Blob,\n    fileName?: string,\n    onProgress?: (progress: number) => void\n): Promise<string> {\n    if (!PINATA_JWT) {\n        console.warn('PINATA_JWT not configured - using local mock CID');\n        const mockCid = `Qm${generateMockHash()}`;\n        return mockCid;\n    }\n\n    console.log('[IPFS] Starting upload to Pinata...', { blobSize: blob.size, fileName });\n\n    return new Promise((resolve, reject) => {\n        const xhr = new XMLHttpRequest();\n        xhr.open('POST', PINATA_PIN_URL);\n        xhr.setRequestHeader('Authorization', `Bearer ${PINATA_JWT}`);\n\n        // Timeout: 2 minutes for large files on mobile\n        xhr.timeout = 120000;\n\n        xhr.upload.onprogress = (event) => {\n            if (event.lengthComputable && onProgress) {\n                const percentComplete = Math.round((event.loaded / event.total) * 100);\n                console.log(`[IPFS] Upload progress: ${percentComplete}%`);\n                onProgress(percentComplete);\n            }\n        };\n\n        xhr.onload = () => {\n            console.log('[IPFS] XHR onload, status:', xhr.status);\n            if (xhr.status >= 200 && xhr.status < 300) {\n                try {\n                    const result = JSON.parse(xhr.responseText);\n                    console.log('[IPFS] Upload success, CID:', result.IpfsHash);\n                    resolve(result.IpfsHash);\n                } catch (e) {\n                    console.error('[IPFS] Failed to parse response:', xhr.responseText);\n                    reject(new Error('Failed to parse Pinata response'));\n                }\n            } else {\n                console.error('[IPFS] Upload failed:', { status: xhr.status, response: xhr.responseText });\n                reject(new Error(`IPFS upload failed: ${xhr.status} - ${xhr.responseText}`));\n            }\n        };\n\n        xhr.onerror = (event) => {\n            console.error('[IPFS] XHR network error:', event);\n            reject(new Error('Network error during IPFS upload - check connection'));\n        };\n\n        xhr.ontimeout = () => {\n            console.error('[IPFS] Upload timeout (2 min)');\n            reject(new Error('IPFS upload timeout - file too large or slow connection'));\n        };\n\n        const formData = new FormData();\n        formData.append('file', blob, fileName || 'encrypted-photo.bin');\n\n        const metadata = JSON.stringify({\n            name: fileName || 'photovault-encrypted',\n            keyvalues: { app: 'photovault', type: 'encrypted-photo' }\n        });\n        formData.append('pinataMetadata', metadata);\n\n        const options = JSON.stringify({ cidVersion: 1 });\n        formData.append('pinataOptions', options);\n\n        console.log('[IPFS] Sending XHR...');\n        xhr.send(formData);\n    });\n}\n\n/**\n * Download content from IPFS\n * Uses API proxy to avoid CORS issues on production\n * Falls back to direct gateway access for development\n */\nexport async function downloadFromIPFS(cid: string): Promise<Blob> {\n    console.log(`[IPFS] Downloading CID: ${cid}`);\n\n    // Primary: Use API proxy (avoids all CORS issues)\n    try {\n        console.log(`[IPFS] Trying API proxy...`);\n        const response = await fetch(`/api/ipfs/download?cid=${encodeURIComponent(cid)}`);\n\n        if (response.ok) {\n            const blob = await response.blob();\n            console.log(`[IPFS] API proxy succeeded, size: ${blob.size} bytes`);\n            return blob;\n        }\n\n        console.warn(`[IPFS] API proxy failed: ${response.status}`);\n    } catch (err) {\n        console.warn(`[IPFS] API proxy error:`, err);\n    }\n\n    // Fallback: Direct gateway access (works in development, may fail on production due to CORS)\n    const gatewayBase = getGatewayBase();\n    const gateways = [\n        () => {\n            const url = new URL(`${gatewayBase}/ipfs/${cid}`);\n            if (PINATA_GATEWAY_TOKEN) url.searchParams.set('pinataGatewayToken', PINATA_GATEWAY_TOKEN);\n            return url.toString();\n        },\n        () => `https://cloudflare-ipfs.com/ipfs/${cid}`,\n    ];\n\n    const controller = new AbortController();\n\n    try {\n        const fetchPromises = gateways.map(async (getUrl, index) => {\n            const url = getUrl();\n            console.log(`[IPFS] Trying gateway ${index + 1}: ${url.substring(0, 60)}...`);\n\n            const response = await fetch(url, {\n                signal: controller.signal,\n                mode: 'cors',\n                credentials: 'omit',\n            });\n\n            if (!response.ok) {\n                throw new Error(`Gateway failed: ${response.status}`);\n            }\n\n            console.log(`[IPFS] Gateway ${index + 1} succeeded`);\n            return response.blob();\n        });\n\n        const winningBlob = await Promise.any(fetchPromises);\n        controller.abort();\n\n        console.log(`[IPFS] Download complete, size: ${winningBlob.size} bytes`);\n        return winningBlob;\n    } catch (error) {\n        controller.abort();\n        console.error('[IPFS] All methods failed:', error);\n        throw new Error(`IPFS download failed for CID: ${cid}. Check network/CORS.`);\n    }\n}\n\n/**\n * Unpin content from Pinata (optional cleanup)\n */\nexport async function unpinFromIPFS(cid: string): Promise<void> {\n    if (!PINATA_JWT) {\n        console.warn('PINATA_JWT not configured - skipping unpin');\n        return;\n    }\n\n    const response = await fetch(`${PINATA_UNPIN_URL}/${cid}`, {\n        method: 'DELETE',\n        headers: {\n            'Authorization': `Bearer ${PINATA_JWT}`,\n        },\n    });\n\n    if (!response.ok) {\n        console.error('Pinata unpin failed:', await response.text());\n        // Don't throw - unpin failure is not critical\n    }\n}\n\n/**\n * Check if a CID exists on IPFS (via gateway)\n */\nexport async function cidExistsOnIPFS(cid: string): Promise<boolean> {\n    try {\n        const gatewayBase = getGatewayBase();\n        const url = new URL(`${gatewayBase}/ipfs/${cid}`);\n        if (PINATA_GATEWAY_TOKEN) {\n            url.searchParams.set('pinataGatewayToken', PINATA_GATEWAY_TOKEN);\n        }\n\n        const response = await fetch(url.toString(), {\n            method: 'HEAD',\n            headers: PINATA_GATEWAY_TOKEN ? {\n                'x-pinata-gateway-token': PINATA_GATEWAY_TOKEN,\n            } : {},\n        });\n        return response.ok;\n    } catch {\n        return false;\n    }\n}\n\n/**\n * Get the gateway URL for a CID (for direct browser access)\n */\nexport function getIPFSGatewayUrl(cid: string): string {\n    const gatewayBase = getGatewayBase();\n    const url = new URL(`${gatewayBase}/ipfs/${cid}`);\n    if (PINATA_GATEWAY_TOKEN) {\n        url.searchParams.set('pinataGatewayToken', PINATA_GATEWAY_TOKEN);\n    }\n    return url.toString();\n}\n\n/**\n * Validate if a string looks like a valid IPFS CID\n */\nexport function isValidCID(cid: string): boolean {\n    // CIDv0 starts with Qm and is 46 chars\n    // CIDv1 starts with bafy and varies in length\n    return (\n        (cid.startsWith('Qm') && cid.length === 46) ||\n        cid.startsWith('bafy') ||\n        cid.startsWith('bafk')\n    );\n}\n\n/**\n * Generate a mock hash for development without Pinata\n */\nfunction generateMockHash(): string {\n    const chars = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';\n    let hash = '';\n    for (let i = 0; i < 44; i++) {\n        hash += chars.charAt(Math.floor(Math.random() * chars.length));\n    }\n    return hash;\n}\n\n/**\n * Check if IPFS/Pinata is configured\n */\nexport function isIPFSConfigured(): boolean {\n    return !!PINATA_JWT && PINATA_JWT.length > 0;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2257, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/lib/storage/remote-storage.ts"],"sourcesContent":["/**\n * Remote Storage Layer - IPFS with Pinata Remote Pinning\n * Encrypted blobs are stored on IPFS, identified by CID\n */\n\nimport { uploadToIPFS, downloadFromIPFS, isIPFSConfigured } from '@/lib/ipfs';\n\nexport interface RemoteStorageProvider {\n    /**\n     * Upload encrypted blob to IPFS\n     * @param blob - The encrypted blob to upload\n     * @param fileName - Optional filename for metadata\n     * @param onProgress - Optional callback for upload progress (0-100)\n     * @returns The IPFS CID (Content Identifier)\n     */\n    upload: (blob: Blob, fileName?: string, onProgress?: (progress: number) => void) => Promise<string>;\n\n    /**\n     * Download encrypted blob from IPFS by CID\n     * @param cid - The IPFS Content Identifier\n     * @returns The encrypted blob\n     */\n    download: (cid: string) => Promise<Blob>;\n\n    /**\n     * Check if remote storage is configured\n     */\n    isConfigured: () => boolean;\n}\n\n/**\n * IPFS Remote Storage Provider\n * Uses Pinata for pinning and dedicated gateway for downloads\n */\nexport const remoteStorage: RemoteStorageProvider = {\n    upload: async (blob: Blob, fileName?: string, onProgress?: (progress: number) => void) => {\n        try {\n            console.log('Uploading to IPFS...', { size: blob.size, fileName });\n            const cid = await uploadToIPFS(blob, fileName, onProgress);\n            console.log('IPFS upload successful:', cid);\n            return cid;\n        } catch (error) {\n            console.error('Remote Storage Upload failed:', error);\n            throw error;\n        }\n    },\n\n    download: async (cid: string) => {\n        try {\n            console.log('Downloading from IPFS:', cid);\n            const blob = await downloadFromIPFS(cid);\n            console.log('IPFS download successful:', { cid, size: blob.size });\n            return blob;\n        } catch (error) {\n            console.error('Remote Storage Download failed:', error);\n            throw error;\n        }\n    },\n\n    isConfigured: () => {\n        return isIPFSConfigured();\n    }\n};\n\n/**\n * Helper: Check if a CID looks like a real IPFS CID or a mock/legacy CID\n */\nexport function isRealIPFSCID(cid: string): boolean {\n    // Real IPFS CIDs start with Qm (v0) or bafy/bafk (v1)\n    return cid.startsWith('Qm') || cid.startsWith('bafy') || cid.startsWith('bafk');\n}\n\n/**\n * Helper: Check if a CID is a legacy local-only CID (cid_timestamp_random)\n */\nexport function isLegacyLocalCID(cid: string): boolean {\n    return cid.startsWith('cid_');\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;;;CAGC,GAED;;AA6BO,MAAM,gBAAuC;IAChD,QAAQ,OAAO,MAAY,UAAmB;QAC1C,IAAI;YACA,QAAQ,GAAG,CAAC,wBAAwB;gBAAE,MAAM,KAAK,IAAI;gBAAE;YAAS;YAChE,MAAM,MAAM,MAAM,IAAA,kIAAY,EAAC,MAAM,UAAU;YAC/C,QAAQ,GAAG,CAAC,2BAA2B;YACvC,OAAO;QACX,EAAE,OAAO,OAAO;YACZ,QAAQ,KAAK,CAAC,iCAAiC;YAC/C,MAAM;QACV;IACJ;IAEA,UAAU,OAAO;QACb,IAAI;YACA,QAAQ,GAAG,CAAC,0BAA0B;YACtC,MAAM,OAAO,MAAM,IAAA,sIAAgB,EAAC;YACpC,QAAQ,GAAG,CAAC,6BAA6B;gBAAE;gBAAK,MAAM,KAAK,IAAI;YAAC;YAChE,OAAO;QACX,EAAE,OAAO,OAAO;YACZ,QAAQ,KAAK,CAAC,mCAAmC;YACjD,MAAM;QACV;IACJ;IAEA,cAAc;QACV,OAAO,IAAA,sIAAgB;IAC3B;AACJ;AAKO,SAAS,cAAc,GAAW;IACrC,sDAAsD;IACtD,OAAO,IAAI,UAAU,CAAC,SAAS,IAAI,UAAU,CAAC,WAAW,IAAI,UAAU,CAAC;AAC5E;AAKO,SAAS,iBAAiB,GAAW;IACxC,OAAO,IAAI,UAAU,CAAC;AAC1B"}},
    {"offset": {"line": 2314, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/lib/storage/local-db.ts"],"sourcesContent":["/**\n * Local Database - Dexie.js Wrapper für Photo Metadata\n * Speichert CIDs und Metadaten lokal (offline-first)\n *\n * WICHTIG: iOS Safari hat Probleme mit Blob-Storage in IndexedDB.\n * Wir speichern Blobs als ArrayBuffer und konvertieren beim Lesen zurück.\n *\n * PERFORMANCE OPTIMIZATIONS (Phase 2):\n * - Compound index on [uploadedAt+id] for efficient pagination\n * - Pagination support for 1000+ photos\n * - Lazy loading of encrypted blobs\n */\n\nimport Dexie, { Table } from 'dexie';\n\n// Public interface - what the app sees\nexport interface PhotoMetadata {\n    id?: number; // Auto-increment\n    cid: string; // IPFS Content ID\n    nonce: string; // Encryption Nonce (Base64)\n    fileName: string;\n    mimeType: string;\n    fileSize: number;\n    width?: number;\n    height?: number;\n    uploadedAt: Date;\n    encryptedBlob?: Blob; // Optional: Lokaler Cache\n}\n\n// Internal storage format - what we actually store in IndexedDB\ninterface PhotoStorageRecord {\n    id?: number;\n    cid: string;\n    nonce: string;\n    fileName: string;\n    mimeType: string;\n    fileSize: number;\n    width?: number;\n    height?: number;\n    uploadedAt: Date;\n    encryptedData?: ArrayBuffer; // Stored as ArrayBuffer for iOS Safari compatibility\n}\n\n// Pagination options\nexport interface PaginationOptions {\n    page?: number;      // 0-indexed page number\n    pageSize?: number;  // Items per page (default: 50)\n}\n\n// Paginated result\nexport interface PaginatedResult<T> {\n    items: T[];\n    total: number;\n    page: number;\n    pageSize: number;\n    hasMore: boolean;\n}\n\nexport class PhotoVaultDB extends Dexie {\n    photos!: Table<PhotoStorageRecord, number>;\n\n    constructor() {\n        super('PhotoVaultDB');\n\n        // Version 2: Added compound index for efficient pagination\n        this.version(2).stores({\n            photos: '++id, cid, uploadedAt, [uploadedAt+id]',\n        }).upgrade(() => {\n            // Migration is automatic - Dexie handles index creation\n            console.log('[LocalDB] Upgraded to v2 with compound index');\n        });\n\n        // Keep v1 for backward compatibility\n        this.version(1).stores({\n            photos: '++id, cid, uploadedAt',\n        });\n    }\n}\n\n// Singleton Instance\nexport const db = new PhotoVaultDB();\n\n/**\n * Convert Blob to ArrayBuffer (for iOS Safari IndexedDB compatibility)\n */\nasync function blobToArrayBuffer(blob: Blob): Promise<ArrayBuffer> {\n    return await blob.arrayBuffer();\n}\n\n/**\n * Convert ArrayBuffer back to Blob\n */\nfunction arrayBufferToBlob(buffer: ArrayBuffer, mimeType: string): Blob {\n    return new Blob([buffer], { type: mimeType });\n}\n\n/**\n * Convert storage record to public PhotoMetadata\n */\nfunction recordToMetadata(record: PhotoStorageRecord): PhotoMetadata {\n    const { encryptedData, ...rest } = record;\n    return {\n        ...rest,\n        encryptedBlob: encryptedData\n            ? arrayBufferToBlob(encryptedData, record.mimeType)\n            : undefined,\n    };\n}\n\n/**\n * Speichert Photo Metadata\n * Konvertiert Blob zu ArrayBuffer für iOS Safari Kompatibilität\n */\nexport async function savePhoto(photo: Omit<PhotoMetadata, 'id'>): Promise<number> {\n    const { encryptedBlob, ...rest } = photo;\n\n    // Convert Blob to ArrayBuffer for storage\n    const storageRecord: Omit<PhotoStorageRecord, 'id'> = {\n        ...rest,\n        encryptedData: encryptedBlob ? await blobToArrayBuffer(encryptedBlob) : undefined,\n    };\n\n    console.log('[LocalDB] Saving photo as ArrayBuffer:', {\n        cid: photo.cid,\n        hasBlob: !!encryptedBlob,\n        arrayBufferSize: storageRecord.encryptedData?.byteLength\n    });\n\n    return await db.photos.add(storageRecord);\n}\n\n/**\n * Lädt alle Photos (sortiert nach Datum)\n * Konvertiert ArrayBuffer zurück zu Blob\n */\nexport async function getAllPhotos(): Promise<PhotoMetadata[]> {\n    const records = await db.photos.orderBy('uploadedAt').reverse().toArray();\n    return records.map(recordToMetadata);\n}\n\n/**\n * Lädt ein Photo by CID\n * Konvertiert ArrayBuffer zurück zu Blob\n */\nexport async function getPhotoByCID(cid: string): Promise<PhotoMetadata | undefined> {\n    const record = await db.photos.where('cid').equals(cid).first();\n    return record ? recordToMetadata(record) : undefined;\n}\n\n/**\n * Löscht ein Photo\n */\nexport async function deletePhoto(id: number): Promise<void> {\n    await db.photos.delete(id);\n}\n\n/**\n * Löscht alle Photos (Reset)\n */\nexport async function clearAllPhotos(): Promise<void> {\n    await db.photos.clear();\n}\n\n/**\n * Zählt Anzahl der Photos\n */\nexport async function getPhotoCount(): Promise<number> {\n    return await db.photos.count();\n}\n\n/**\n * Lädt Photos mit Pagination (optimiert für 1000+ Photos)\n * Uses compound index [uploadedAt+id] for efficient cursor-based pagination\n */\nexport async function getPhotosPaginated(\n    options: PaginationOptions = {}\n): Promise<PaginatedResult<PhotoMetadata>> {\n    const { page = 0, pageSize = 50 } = options;\n    const offset = page * pageSize;\n\n    // Get total count (cached by Dexie for performance)\n    const total = await db.photos.count();\n\n    // Use offset-based pagination with index\n    const records = await db.photos\n        .orderBy('uploadedAt')\n        .reverse()\n        .offset(offset)\n        .limit(pageSize)\n        .toArray();\n\n    return {\n        items: records.map(recordToMetadata),\n        total,\n        page,\n        pageSize,\n        hasMore: offset + records.length < total,\n    };\n}\n\n/**\n * Lädt Photos mit Cursor-basierter Pagination (für infinite scroll)\n * Mehr performant als offset-basierte Pagination bei großen Datenmengen\n */\nexport async function getPhotosAfterCursor(\n    cursor?: { uploadedAt: Date; id: number },\n    limit: number = 50\n): Promise<{ items: PhotoMetadata[]; nextCursor?: { uploadedAt: Date; id: number } }> {\n    let query = db.photos.orderBy('uploadedAt').reverse();\n\n    if (cursor) {\n        // Use compound key for efficient cursor-based pagination\n        query = query.filter(record => {\n            if (!record.id) return false;\n            // Photos older than cursor, or same date but lower ID\n            if (record.uploadedAt < cursor.uploadedAt) return true;\n            if (record.uploadedAt.getTime() === cursor.uploadedAt.getTime() && record.id < cursor.id) return true;\n            return false;\n        });\n    }\n\n    const records = await query.limit(limit + 1).toArray();\n    const hasMore = records.length > limit;\n    const items = hasMore ? records.slice(0, limit) : records;\n\n    const lastItem = items[items.length - 1];\n    const nextCursor = hasMore && lastItem?.id && lastItem?.uploadedAt\n        ? { uploadedAt: lastItem.uploadedAt, id: lastItem.id }\n        : undefined;\n\n    return {\n        items: items.map(recordToMetadata),\n        nextCursor,\n    };\n}\n\n/**\n * Lädt nur Metadaten ohne Blob (für schnelle Galerie-Ansicht)\n * Optimiert für initiales Laden - Blobs werden on-demand nachgeladen\n */\nexport async function getPhotosMetadataOnly(\n    options: PaginationOptions = {}\n): Promise<PaginatedResult<Omit<PhotoMetadata, 'encryptedBlob'>>> {\n    const { page = 0, pageSize = 50 } = options;\n    const offset = page * pageSize;\n\n    const total = await db.photos.count();\n\n    // Only select non-blob fields for faster loading\n    const records = await db.photos\n        .orderBy('uploadedAt')\n        .reverse()\n        .offset(offset)\n        .limit(pageSize)\n        .toArray();\n\n    // Return metadata without converting blobs\n    const items = records.map(record => ({\n        id: record.id,\n        cid: record.cid,\n        nonce: record.nonce,\n        fileName: record.fileName,\n        mimeType: record.mimeType,\n        fileSize: record.fileSize,\n        width: record.width,\n        height: record.height,\n        uploadedAt: record.uploadedAt,\n    }));\n\n    return {\n        items,\n        total,\n        page,\n        pageSize,\n        hasMore: offset + records.length < total,\n    };\n}\n\n/**\n * Lädt den Blob für ein einzelnes Photo (lazy loading)\n */\nexport async function getPhotoBlob(id: number): Promise<Blob | undefined> {\n    const record = await db.photos.get(id);\n    if (!record?.encryptedData) return undefined;\n    return arrayBufferToBlob(record.encryptedData, record.mimeType);\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2500, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/lib/storage/settings-store.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { persist, createJSONStorage } from 'zustand/middleware';\n\nexport interface SettingsState {\n    backupActive: boolean;\n    autoBackupEnabled: boolean;\n    backgroundBackupEnabled: boolean;\n    selectedPlan: 'free' | 'backup-plus';\n    lastBackup: string;\n    permanence: number;\n    setBackupActive: (active: boolean) => void;\n    setAutoBackupEnabled: (enabled: boolean) => void;\n    setBackgroundBackupEnabled: (enabled: boolean) => void;\n    setSelectedPlan: (plan: 'free' | 'backup-plus') => void;\n    setLastBackup: (date: string) => void;\n    setPermanence: (value: number) => void;\n}\n\nconst dummyStorage = {\n    getItem: () => null,\n    setItem: () => { },\n    removeItem: () => { },\n};\n\nexport const useSettingsStore = create<SettingsState>()(\n    persist(\n        (set) => ({\n            backupActive: false,\n            autoBackupEnabled: true,\n            backgroundBackupEnabled: false,\n            selectedPlan: 'free',\n            lastBackup: 'Noch nie',\n            permanence: 0,\n\n            setBackupActive: (active) => set({ backupActive: active }),\n            setAutoBackupEnabled: (enabled) => set({ autoBackupEnabled: enabled }),\n            setBackgroundBackupEnabled: (enabled) => set({ backgroundBackupEnabled: enabled }),\n            setSelectedPlan: (plan) => set({ selectedPlan: plan }),\n            setLastBackup: (date) => set({ lastBackup: date }),\n            setPermanence: (value) => set({ permanence: value }),\n        }),\n        {\n            name: 'photovault-settings',\n            storage: createJSONStorage(() => typeof window !== 'undefined' ? localStorage : dummyStorage),\n        }\n    )\n);\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAiBA,MAAM,eAAe;IACjB,SAAS,IAAM;IACf,SAAS,KAAQ;IACjB,YAAY,KAAQ;AACxB;AAEO,MAAM,mBAAmB,IAAA,kJAAM,IAClC,IAAA,wJAAO,EACH,CAAC,MAAQ,CAAC;QACN,cAAc;QACd,mBAAmB;QACnB,yBAAyB;QACzB,cAAc;QACd,YAAY;QACZ,YAAY;QAEZ,iBAAiB,CAAC,SAAW,IAAI;gBAAE,cAAc;YAAO;QACxD,sBAAsB,CAAC,UAAY,IAAI;gBAAE,mBAAmB;YAAQ;QACpE,4BAA4B,CAAC,UAAY,IAAI;gBAAE,yBAAyB;YAAQ;QAChF,iBAAiB,CAAC,OAAS,IAAI;gBAAE,cAAc;YAAK;QACpD,eAAe,CAAC,OAAS,IAAI;gBAAE,YAAY;YAAK;QAChD,eAAe,CAAC,QAAU,IAAI;gBAAE,YAAY;YAAM;IACtD,CAAC,GACD;IACI,MAAM;IACN,SAAS,IAAA,kKAAiB,EAAC,IAAM,sCAAgC,0BAAe;AACpF"}},
    {"offset": {"line": 2546, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/components/features/settings/DevicePairing.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState } from \"react\";\nimport { QRCodeSVG } from \"qrcode.react\";\nimport { X, Copy, Check, Smartphone, QrCode } from \"lucide-react\";\nimport { useEncryption } from \"@/hooks/use-encryption\";\n\ninterface DevicePairingProps {\n  isOpen: boolean;\n  onClose: () => void;\n}\n\ntype PairingMode = \"show\" | \"input\";\n\nexport function DevicePairing({ isOpen, onClose }: DevicePairingProps) {\n  const [mode, setMode] = useState<PairingMode>(\"show\");\n  const [inputKey, setInputKey] = useState(\"\");\n  const [copied, setCopied] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [success, setSuccess] = useState(false);\n\n  const { recoveryPhrase, restoreFromPhrase } = useEncryption();\n\n  const handleCopyKey = async () => {\n    if (!recoveryPhrase) return;\n\n    try {\n      await navigator.clipboard.writeText(recoveryPhrase);\n      setCopied(true);\n      setTimeout(() => setCopied(false), 2000);\n    } catch {\n      console.error(\"Failed to copy to clipboard\");\n    }\n  };\n\n  const handleImportKey = () => {\n    setError(null);\n\n    if (!inputKey.trim()) {\n      setError(\"Bitte gib einen Schlüssel ein\");\n      return;\n    }\n\n    const success = restoreFromPhrase(inputKey.trim());\n\n    if (success) {\n      setSuccess(true);\n      setInputKey(\"\");\n      setTimeout(() => {\n        setSuccess(false);\n        onClose();\n      }, 1500);\n    } else {\n      setError(\"Ungültiger Schlüssel. Bitte überprüfe die Eingabe.\");\n    }\n  };\n\n  if (!isOpen) return null;\n\n  return (\n    <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 px-4\">\n      <div className=\"bg-white w-full max-w-[380px] rounded-2xl overflow-hidden\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between p-4 border-b border-[#E5E5EA]\">\n          <h2 className=\"sf-pro-display text-[17px] font-semibold text-[#1D1D1F]\">\n            Gerät verbinden\n          </h2>\n          <button\n            onClick={onClose}\n            className=\"w-8 h-8 flex items-center justify-center rounded-full bg-[#F2F2F7]\"\n          >\n            <X className=\"w-4 h-4 text-[#6E6E73]\" />\n          </button>\n        </div>\n\n        {/* Mode Tabs */}\n        <div className=\"flex border-b border-[#E5E5EA]\">\n          <button\n            onClick={() => setMode(\"show\")}\n            className={`flex-1 py-3 text-[15px] font-medium flex items-center justify-center gap-2 ${\n              mode === \"show\"\n                ? \"text-[#007AFF] border-b-2 border-[#007AFF]\"\n                : \"text-[#6E6E73]\"\n            }`}\n          >\n            <QrCode className=\"w-4 h-4\" />\n            Schlüssel zeigen\n          </button>\n          <button\n            onClick={() => setMode(\"input\")}\n            className={`flex-1 py-3 text-[15px] font-medium flex items-center justify-center gap-2 ${\n              mode === \"input\"\n                ? \"text-[#007AFF] border-b-2 border-[#007AFF]\"\n                : \"text-[#6E6E73]\"\n            }`}\n          >\n            <Smartphone className=\"w-4 h-4\" />\n            Schlüssel eingeben\n          </button>\n        </div>\n\n        {/* Content */}\n        <div className=\"p-5\">\n          {mode === \"show\" ? (\n            <div className=\"flex flex-col items-center\">\n              <p className=\"text-[13px] text-[#6E6E73] text-center mb-4\">\n                Scanne diesen QR-Code mit deinem anderen Gerät oder kopiere den Schlüssel.\n              </p>\n\n              {/* QR Code */}\n              {recoveryPhrase && (\n                <div className=\"bg-white p-4 rounded-xl border border-[#E5E5EA] mb-4\">\n                  <QRCodeSVG\n                    value={recoveryPhrase}\n                    size={180}\n                    level=\"M\"\n                    includeMargin={false}\n                  />\n                </div>\n              )}\n\n              {/* Key Display */}\n              <div className=\"w-full bg-[#F2F2F7] rounded-xl p-3 mb-4\">\n                <p className=\"text-[11px] text-[#6E6E73] mb-1\">Dein Schlüssel:</p>\n                <p className=\"text-[13px] font-mono text-[#1D1D1F] break-all leading-relaxed\">\n                  {recoveryPhrase || \"Kein Schlüssel verfügbar\"}\n                </p>\n              </div>\n\n              {/* Copy Button */}\n              <button\n                onClick={handleCopyKey}\n                disabled={!recoveryPhrase}\n                className=\"w-full h-[44px] bg-[#007AFF] text-white text-[15px] font-semibold rounded-xl flex items-center justify-center gap-2 disabled:opacity-50\"\n              >\n                {copied ? (\n                  <>\n                    <Check className=\"w-4 h-4\" />\n                    Kopiert!\n                  </>\n                ) : (\n                  <>\n                    <Copy className=\"w-4 h-4\" />\n                    Schlüssel kopieren\n                  </>\n                )}\n              </button>\n            </div>\n          ) : (\n            <div className=\"flex flex-col\">\n              <p className=\"text-[13px] text-[#6E6E73] text-center mb-4\">\n                Gib den Schlüssel von deinem anderen Gerät ein, um deine Fotos zu synchronisieren.\n              </p>\n\n              {/* Key Input */}\n              <textarea\n                value={inputKey}\n                onChange={(e) => {\n                  setInputKey(e.target.value);\n                  setError(null);\n                }}\n                placeholder=\"Schlüssel hier eingeben...\"\n                className=\"w-full h-[100px] bg-[#F2F2F7] rounded-xl p-3 text-[14px] font-mono text-[#1D1D1F] resize-none mb-3 placeholder:text-[#C7C7CC]\"\n              />\n\n              {/* Error Message */}\n              {error && (\n                <p className=\"text-[13px] text-[#FF3B30] text-center mb-3\">\n                  {error}\n                </p>\n              )}\n\n              {/* Success Message */}\n              {success && (\n                <p className=\"text-[13px] text-[#30D158] text-center mb-3\">\n                  Schlüssel erfolgreich importiert!\n                </p>\n              )}\n\n              {/* Import Button */}\n              <button\n                onClick={handleImportKey}\n                disabled={!inputKey.trim() || success}\n                className=\"w-full h-[44px] bg-[#30D158] text-white text-[15px] font-semibold rounded-xl flex items-center justify-center gap-2 disabled:opacity-50\"\n              >\n                <Smartphone className=\"w-4 h-4\" />\n                Gerät verbinden\n              </button>\n\n              {/* Warning */}\n              <p className=\"text-[11px] text-[#FF9500] text-center mt-4\">\n                Achtung: Dies überschreibt deinen aktuellen Schlüssel. Stelle sicher, dass du ihn gesichert hast.\n              </p>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2869, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/components/photovault/SettingsPanel.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { Plus, Loader2, Check, Cloud } from \"lucide-react\";\nimport { CustomIcon } from \"@/components/ui/custom-icon\";\nimport type { AppState } from \"./PhotoVaultApp\";\nimport { useEncryption } from \"@/hooks/use-encryption\";\nimport { getDevicesForUser, uploadCIDMetadata, cidExistsInSupabase } from \"@/lib/supabase\";\nimport { getDeviceId } from \"@/lib/deviceId\";\nimport { remoteStorage } from \"@/lib/storage/remote-storage\";\nimport { getAllPhotos } from \"@/lib/storage/local-db\";\nimport { getUserKeyHash } from \"@/lib/crypto\";\n\n// Helper to format date\nfunction formatDate(dateStr?: string): string {\n  if (!dateStr) return \"Unbekannt\";\n  const date = new Date(dateStr);\n  const now = new Date();\n  const diffMs = now.getTime() - date.getTime();\n  const diffMins = Math.floor(diffMs / 60000);\n  const diffHours = Math.floor(diffMs / 3600000);\n  const diffDays = Math.floor(diffMs / 86400000);\n\n  if (diffMins < 1) return \"Gerade eben\";\n  if (diffMins < 60) return `vor ${diffMins} Min.`;\n  if (diffHours < 24) return `vor ${diffHours} Std.`;\n  if (diffDays < 7) return `vor ${diffDays} Tagen`;\n  return date.toLocaleDateString(\"de-DE\");\n}\n\ninterface SettingsPanelProps {\n  state: AppState;\n  setState: React.Dispatch<React.SetStateAction<AppState>>;\n  onRestartOnboarding: () => void;\n  authUser: { id: string; email: string } | null;\n}\n\ninterface Device {\n  id: string;\n  device_name: string;\n  device_type?: string;\n  created_at?: string;\n}\n\nimport { useSettingsStore } from \"@/lib/storage/settings-store\";\n\nexport function SettingsPanel({\n  state,\n  setState,\n  onRestartOnboarding,\n  authUser,\n}: SettingsPanelProps) {\n  const [showDevices, setShowDevices] = useState(false);\n  const [showPhraseWarning, setShowPhraseWarning] = useState(false);\n  const [showNewKeyWarning, setShowNewKeyWarning] = useState(false);\n  const [showBackupPhrase, setShowBackupPhrase] = useState(false);\n  const [showSourceSelector, setShowSourceSelector] = useState(false);\n  const [showPlanSelector, setShowPlanSelector] = useState(false);\n  const [realDevices, setRealDevices] = useState<Device[]>([]);\n\n  // Manual Backup State\n  const [isUploading, setIsUploading] = useState(false);\n  const [uploadProgress, setUploadProgress] = useState({ current: 0, total: 0 });\n\n  // Persistent Settings\n  const autoBackupEnabled = useSettingsStore(state => state.autoBackupEnabled);\n  const setAutoBackupEnabled = useSettingsStore(state => state.setAutoBackupEnabled);\n  const backgroundBackupEnabled = useSettingsStore(state => state.backgroundBackupEnabled);\n  const setBackgroundBackupEnabled = useSettingsStore(state => state.setBackgroundBackupEnabled);\n  const selectedPlan = useSettingsStore(state => state.selectedPlan);\n  const setSelectedPlan = useSettingsStore(state => state.setSelectedPlan);\n  const setLastBackup = useSettingsStore(state => state.setLastBackup);\n\n  const { secretKey, recoveryPhrase, generateNewKey, clearKey } = useEncryption();\n  const currentDeviceId = typeof window !== \"undefined\" ? getDeviceId() : \"\";\n  const [userKeyHash, setUserKeyHash] = useState<string | null>(null);\n\n  // Get userKeyHash\n  useEffect(() => {\n    if (secretKey) {\n      import(\"@/lib/crypto\").then(m => m.getUserKeyHash(secretKey)).then(setUserKeyHash);\n    }\n  }, [secretKey]);\n\n  // Fetch real devices from Supabase using hash (aggregates all devices with same key)\n  useEffect(() => {\n    if (!userKeyHash) return;\n\n    const fetchDevices = async () => {\n      try {\n        const devices = await getDevicesForUser(userKeyHash);\n        setRealDevices(devices as Device[]);\n      } catch (err) {\n        console.error(\"Failed to fetch devices:\", err);\n      }\n    };\n\n    fetchDevices();\n  }, [userKeyHash]);\n\n  // Get the real backup phrase words\n  const realBackupPhraseWords = recoveryPhrase?.split(\"-\").slice(0, 12) || [];\n\n  const toggleAutoBackup = () => {\n    setAutoBackupEnabled(!autoBackupEnabled);\n  };\n\n  const toggleBackgroundBackup = () => {\n    setBackgroundBackupEnabled(!backgroundBackupEnabled);\n  };\n\n  // Manual backup: Upload local photos to IPFS that aren't already there\n  const triggerManualBackup = async () => {\n    if (isUploading || !secretKey) return;\n\n    setIsUploading(true);\n    console.log(\"[Backup] Starting manual backup to IPFS...\");\n\n    try {\n      const photos = await getAllPhotos();\n      const photosWithBlobs = photos.filter((p) => p.encryptedBlob);\n\n      setUploadProgress({ current: 0, total: photosWithBlobs.length });\n\n      let uploaded = 0;\n      const deviceId = getDeviceId();\n      const keyHash = userKeyHash || await getUserKeyHash(secretKey);\n\n      for (const photo of photosWithBlobs) {\n        if (!photo.encryptedBlob) continue;\n\n        try {\n          // Check if already in Supabase metadata for this user\n          const existsInSupabase = await cidExistsInSupabase(photo.cid, keyHash);\n\n          if (!existsInSupabase) {\n            // Upload encrypted blob to IPFS\n            const newCid = await remoteStorage.upload(photo.encryptedBlob, photo.fileName);\n            console.log(`[Backup] Uploaded to IPFS: ${newCid}`);\n\n            // Sync metadata to Supabase\n            await uploadCIDMetadata(\n              newCid,\n              photo.fileSize,\n              deviceId,\n              photo.nonce,\n              photo.mimeType,\n              keyHash\n            );\n          }\n\n          uploaded++;\n          setUploadProgress({ current: uploaded, total: photosWithBlobs.length });\n        } catch (err) {\n          console.error(`[Backup] Failed to upload ${photo.cid}:`, err);\n        }\n      }\n\n      setLastBackup(\"Gerade eben\");\n      console.log(`[Backup] Complete: ${uploaded} photos processed`);\n    } catch (err) {\n      console.error(\"[Backup] Failed:\", err);\n    } finally {\n      setIsUploading(false);\n      setUploadProgress({ current: 0, total: 0 });\n    }\n  };\n\n  const viewBackupPhrase = () => {\n    setShowPhraseWarning(false);\n    setShowBackupPhrase(true);\n  };\n\n  const handleGenerateNewKey = async () => {\n    clearKey();\n    const newPhrase = await generateNewKey();\n\n    if (newPhrase) {\n      setState((prev) => ({\n        ...prev,\n        photosCount: 0,\n      }));\n    }\n\n    setShowNewKeyWarning(false);\n  };\n\n  const addDevice = () => {\n    // Show the pairing modal\n    setShowDevices(false);\n    // Since DevicePairing is normally inside Dashboard, \n    // we should probably have it available here too or trigger a global state.\n    // In this component, we can just add the DevicePairing modal here as well.\n    setShowPairingFromSettings(true);\n  };\n\n  const [showPairingFromSettings, setShowPairingFromSettings] = useState(false);\n  const [showClearCacheWarning, setShowClearCacheWarning] = useState(false);\n\n  const handleClearCache = async () => {\n    try {\n      // Clear IndexedDB (Dexie)\n      const { db } = await import(\"@/lib/storage/local-db\");\n      await db.delete();\n      \n      // Clear local storage\n      localStorage.clear();\n      \n      // Force reload to clean state\n      window.location.reload();\n    } catch (err) {\n      console.error(\"Failed to clear cache:\", err);\n    }\n  };\n\n  const changeSource = (source: \"photos-app\" | \"files-app\") => {\n    console.log(\"Update backup source preference:\", source);\n    setState((prev) => ({ ...prev, photoSource: source }));\n    setShowSourceSelector(false);\n  };\n\n  const changePlan = (plan: \"free\" | \"backup-plus\") => {\n    console.log(\"Update plan:\", plan);\n    setSelectedPlan(plan);\n    setShowPlanSelector(false);\n  };\n\n  if (showDevices) {\n    // Transform real devices into the format expected by DevicesView\n    const displayDevices = realDevices.map((device) => ({\n      id: device.id,\n      name: device.device_name || \"Unbekanntes Gerät\",\n      lastActive: device.id === currentDeviceId ? \"Aktiv\" : formatDate(device.created_at),\n      syncing: false,\n    }));\n\n    // If no devices in DB, show current device\n    if (displayDevices.length === 0) {\n      displayDevices.push({\n        id: currentDeviceId,\n        name: \"Dieses Gerät\",\n        lastActive: \"Aktiv\",\n        syncing: false,\n      });\n    }\n\n    return (\n      <DevicesView\n        devices={displayDevices}\n        onBack={() => setShowDevices(false)}\n        onAddDevice={addDevice}\n      />\n    );\n  }\n\n  return (\n    <div className=\"h-full flex flex-col pb-4 overflow-y-auto\">\n      {/* Header with Sketch UI */}\n      <header className=\"px-5 pt-6 pb-4 bg-[#FAFBFC]\">\n        <h1 className=\"sketch-heading text-[32px]\">\n          Einstellungen\n        </h1>\n      </header>\n\n      <div className=\"flex-1 px-5\">\n        {/* Backup Settings Section */}\n        <div className=\"mb-6\">\n          <h2 className=\"text-[13px] font-semibold text-[#6E6E73] uppercase tracking-wide px-4 mb-2\">\n            Backup\n          </h2>\n          <div className=\"bg-white rounded-xl overflow-hidden\">\n            <SettingsToggleRow\n              label=\"Automatisches Backup\"\n              description=\"Neue Fotos automatisch sichern\"\n              enabled={autoBackupEnabled}\n              onToggle={toggleAutoBackup}\n            />\n            <div className=\"h-[0.5px] bg-[#E5E5EA] ml-4\" />\n            <SettingsToggleRow\n              label=\"Hintergrund-Backup\"\n              description=\"Weiter sichern wenn App geschlossen\"\n              enabled={backgroundBackupEnabled}\n              onToggle={toggleBackgroundBackup}\n            />\n            <div className=\"h-[0.5px] bg-[#E5E5EA] ml-4\" />\n            <button\n              onClick={() => setShowSourceSelector(true)}\n              className=\"w-full flex items-center justify-between p-4 ios-tap-target\"\n            >\n              <div className=\"flex items-center gap-3\">\n                <CustomIcon name=\"folder\" size={24} />\n                <div className=\"text-left\">\n                  <span className=\"text-[17px] text-[#1D1D1F] block\">\n                    Backup-Quelle\n                  </span>\n                  <span className=\"text-[13px] text-[#6E6E73]\">\n                    {state.photoSource === \"photos-app\"\n                      ? \"Fotos-App\"\n                      : \"Dateien-App\"}\n                  </span>\n                </div>\n              </div>\n              <CustomIcon name=\"chevronRight\" size={16} />\n            </button>\n          </div>\n\n          {/* Manual Backup Button */}\n          <button\n            onClick={triggerManualBackup}\n            disabled={isUploading || !secretKey}\n            className=\"w-full h-[50px] bg-[#007AFF] text-white text-[17px] font-semibold rounded-xl mt-3 ios-tap-target disabled:opacity-70 flex items-center justify-center gap-2\"\n          >\n            {isUploading ? (\n              <>\n                <Loader2 className=\"w-5 h-5 animate-spin\" />\n                {uploadProgress.total > 0\n                  ? `${uploadProgress.current}/${uploadProgress.total} hochladen...`\n                  : \"Vorbereiten...\"}\n              </>\n            ) : (\n              <>\n                <Cloud className=\"w-5 h-5\" />\n                Jetzt sichern\n              </>\n            )}\n          </button>\n          <p className=\"text-[13px] text-[#6E6E73] px-4 mt-2 text-center\">\n            Alle lokalen Fotos in die Cloud hochladen\n          </p>\n        </div>\n\n        {/* Storage Section */}\n        <div className=\"mb-6\">\n          <h2 className=\"text-[13px] font-semibold text-[#6E6E73] uppercase tracking-wide px-4 mb-2\">\n            Speicher\n          </h2>\n          <div className=\"bg-white rounded-xl overflow-hidden\">\n            <div className=\"p-4\">\n              <div className=\"flex items-center justify-between mb-1\">\n                <span className=\"text-[17px] text-[#1D1D1F]\">\n                  Aktueller Plan\n                </span>\n                <span className=\"text-[15px] font-semibold text-[#007AFF]\">\n                  {selectedPlan === \"free\" ? \"Free\" : \"Backup+\"}\n                </span>\n              </div>\n              <p className=\"text-[13px] text-[#6E6E73]\">\n                {selectedPlan === \"free\"\n                  ? \"Fotos auf deinen Geräten\"\n                  : \"200 GB Cloud-Backup\"}\n              </p>\n            </div>\n            <div className=\"h-[0.5px] bg-[#E5E5EA] ml-4\" />\n            <div className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <span className=\"text-[15px] text-[#6E6E73]\">Verwendet</span>\n                <span className=\"text-[15px] text-[#1D1D1F]\">\n                  {state.photosCount.toLocaleString()} Fotos (nur lokal)\n                </span>\n              </div>\n            </div>\n            <div className=\"h-[0.5px] bg-[#E5E5EA] ml-4\" />\n            <button\n              onClick={() => setShowPlanSelector(true)}\n              className=\"w-full flex items-center justify-between p-4 ios-tap-target\"\n            >\n              <span className=\"text-[17px] text-[#007AFF]\">\n                {selectedPlan === \"free\"\n                  ? \"Upgrade zu Backup+\"\n                  : \"Plan verwalten\"}\n              </span>\n              <CustomIcon name=\"chevronRight\" size={16} />\n            </button>\n          </div>\n        </div>\n\n        {/* Devices Section */}\n        <div className=\"mb-6\">\n          <h2 className=\"text-[13px] font-semibold text-[#6E6E73] uppercase tracking-wide px-4 mb-2\">\n            Geräte\n          </h2>\n          <div className=\"bg-white rounded-xl overflow-hidden\">\n            <button\n              onClick={() => {\n                console.log(\"Fetch Device List\");\n                setShowDevices(true);\n              }}\n              className=\"w-full flex items-center justify-between p-4 ios-tap-target\"\n            >\n              <div className=\"flex items-center gap-3\">\n                <CustomIcon name=\"smartphone\" size={24} />\n                <span className=\"text-[17px] text-[#1D1D1F]\">\n                  Verbundene Geräte\n                </span>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-[15px] text-[#6E6E73]\">\n                  {realDevices.length || 1}\n                </span>\n                <CustomIcon name=\"chevronRight\" size={16} />\n              </div>\n            </button>\n          </div>\n        </div>\n\n        {/* Security Section */}\n        <div className=\"mb-6\">\n          <h2 className=\"text-[13px] font-semibold text-[#6E6E73] uppercase tracking-wide px-4 mb-2\">\n            Sicherheit\n          </h2>\n          <div className=\"bg-white rounded-xl overflow-hidden\">\n            <button\n              onClick={() => setShowPhraseWarning(true)}\n              className=\"w-full flex items-center justify-between p-4 ios-tap-target\"\n            >\n              <span className=\"text-[17px] text-[#1D1D1F]\">\n                Backup-Phrase anzeigen\n              </span>\n              <CustomIcon name=\"chevronRight\" size={16} />\n            </button>\n            <div className=\"h-[0.5px] bg-[#E5E5EA] ml-4\" />\n            <button\n              onClick={() => setShowNewKeyWarning(true)}\n              className=\"w-full flex items-center justify-between p-4 ios-tap-target\"\n            >\n              <span className=\"text-[17px] text-[#FF3B30]\">\n                Neuen Schlüssel erstellen\n              </span>\n              <CustomIcon name=\"chevronRight\" size={16} />\n            </button>\n          </div>\n          <p className=\"text-[13px] text-[#6E6E73] px-4 mt-2\">\n            Teile diese Wörter niemals mit anderen.\n          </p>\n        </div>\n\n        {/* Maintenance Section */}\n        <div className=\"mb-6\">\n          <h2 className=\"text-[13px] font-semibold text-[#6E6E73] uppercase tracking-wide px-4 mb-2\">\n            Wartung\n          </h2>\n          <div className=\"bg-white rounded-xl overflow-hidden\">\n            <button\n              onClick={() => setShowClearCacheWarning(true)}\n              className=\"w-full flex items-center justify-between p-4 ios-tap-target\"\n            >\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-6 h-6 flex items-center justify-center text-[#FF9500]\">\n                  <CustomIcon name=\"refresh\" size={24} />\n                </div>\n                <span className=\"text-[17px] text-[#FF9500]\">\n                  Lokalen Cache leeren\n                </span>\n              </div>\n              <CustomIcon name=\"chevronRight\" size={16} />\n            </button>\n          </div>\n          <p className=\"text-[13px] text-[#6E6E73] px-4 mt-2\">\n            Löscht lokale Vorschaubilder und Gerätedaten. Deine Fotos in der Cloud bleiben sicher.\n          </p>\n        </div>\n      </div>\n\n      {/* View Backup Phrase Warning Modal */}\n      {showPhraseWarning && (\n        <Modal\n          title=\"Sicherheitshinweis\"\n          message=\"Deine Backup-Phrase gibt vollen Zugriff auf deine verschlüsselten Fotos. Nur an einem privaten Ort anzeigen.\"\n          confirmLabel=\"Phrase anzeigen\"\n          confirmDestructive={false}\n          onConfirm={viewBackupPhrase}\n          onCancel={() => setShowPhraseWarning(false)}\n        />\n      )}\n\n      {/* Show Backup Phrase Modal */}\n      {showBackupPhrase && (\n        <div className=\"fixed inset-0 bg-black/40 flex items-end justify-center z-50\">\n          <div className=\"bg-white w-full max-w-[428px] rounded-t-2xl p-6 pb-10\">\n            <h3 className=\"sketch-subheading text-[22px] text-center mb-2\">\n              Deine Backup-Phrase\n            </h3>\n            <p className=\"text-[15px] text-[#6E6E73] text-center mb-4\">\n              Notiere diese Wörter und bewahre sie sicher auf.\n            </p>\n\n            {realBackupPhraseWords.length > 0 ? (\n              <>\n                {/* Real phrase in grid */}\n                <div className=\"grid grid-cols-3 gap-2 mb-4\">\n                  {realBackupPhraseWords.map((word, index) => (\n                    <div\n                      key={index}\n                      className=\"bg-[#F2F2F7] rounded-lg p-2 text-center\"\n                    >\n                      <span className=\"text-[11px] text-[#8E8E93] block\">\n                        {index + 1}\n                      </span>\n                      <span className=\"text-[14px] text-[#1D1D1F] font-mono\">\n                        {word}\n                      </span>\n                    </div>\n                  ))}\n                </div>\n\n                {/* Full key for copy */}\n                <div className=\"bg-[#F2F2F7] rounded-xl p-3 mb-4\">\n                  <p className=\"text-[11px] text-[#6E6E73] mb-1\">Vollständiger Schlüssel:</p>\n                  <p className=\"text-[12px] font-mono text-[#1D1D1F] break-all\">\n                    {recoveryPhrase}\n                  </p>\n                </div>\n              </>\n            ) : (\n              <div className=\"bg-[#FF9500]/10 rounded-xl p-4 mb-4\">\n                <p className=\"text-[13px] text-[#FF9500] text-center\">\n                  Kein Schlüssel gefunden. Bitte erstelle einen neuen Schlüssel.\n                </p>\n              </div>\n            )}\n\n            {/* Warning */}\n            <div className=\"bg-[#FF3B30]/10 rounded-xl p-3 mb-4\">\n              <p className=\"text-[13px] text-[#FF3B30] text-center\">\n                ⚠️ Teile diese Wörter niemals mit anderen\n              </p>\n            </div>\n\n            <button\n              onClick={() => setShowBackupPhrase(false)}\n              className=\"w-full h-[50px] bg-[#007AFF] text-white text-[17px] font-semibold rounded-xl ios-tap-target\"\n            >\n              Fertig\n            </button>\n          </div>\n        </div>\n      )}\n\n      {/* Generate New Key Warning Modal */}\n      {showNewKeyWarning && (\n        <Modal\n          title=\"Datenverlust-Warnung\"\n          message=\"Das Erstellen eines neuen Schlüssels löscht alle vorhandenen Backup-Daten permanent. Diese Aktion kann nicht rückgängig gemacht werden.\"\n          confirmLabel=\"Neuen Schlüssel erstellen\"\n          confirmDestructive={true}\n          onConfirm={handleGenerateNewKey}\n          onCancel={() => setShowNewKeyWarning(false)}\n        />\n      )}\n\n      {/* Source Selector Modal */}\n      {showSourceSelector && (\n        <SourceSelectorModal\n          currentSource={state.photoSource}\n          onSelect={changeSource}\n          onClose={() => setShowSourceSelector(false)}\n        />\n      )}\n\n      {/* Plan Selector Modal */}\n      {showPlanSelector && (\n        <PlanSelectorModal\n          currentPlan={selectedPlan}\n          onSelect={changePlan}\n          onClose={() => setShowPlanSelector(false)}\n        />\n      )}\n\n      {/* Clear Cache Warning Modal */}\n      {showClearCacheWarning && (\n        <Modal\n          title=\"Cache leeren?\"\n          message=\"Dies wird lokale Vorschaubilder und Gerätedaten löschen. Deine verschlüsselten Fotos in der Cloud bleiben sicher. Die App wird neu geladen.\"\n          confirmLabel=\"Cache leeren\"\n          confirmDestructive={true}\n          onConfirm={handleClearCache}\n          onCancel={() => setShowClearCacheWarning(false)}\n        />\n      )}\n\n      {/* Device Pairing Modal */}\n      <DevicePairing \n        isOpen={showPairingFromSettings} \n        onClose={() => setShowPairingFromSettings(false)} \n      />\n    </div>\n  );\n}\n\nimport { DevicePairing } from \"@/components/features/settings/DevicePairing\";\n\nfunction SettingsToggleRow({\n  label,\n  description,\n  enabled,\n  onToggle,\n}: {\n  label: string;\n  description: string;\n  enabled: boolean;\n  onToggle: () => void;\n}) {\n  return (\n    <button\n      onClick={onToggle}\n      className=\"w-full flex items-center justify-between p-4 ios-tap-target\"\n    >\n      <div className=\"text-left\">\n        <p className=\"text-[17px] text-[#1D1D1F]\">{label}</p>\n        <p className=\"text-[13px] text-[#6E6E73] mt-0.5\">{description}</p>\n      </div>\n      <div\n        className={`w-[51px] h-[31px] rounded-full p-[2px] shrink-0 ${\n          enabled ? \"bg-[#30D158]\" : \"bg-[#E5E5EA]\"\n        }`}\n      >\n        <div\n          className={`w-[27px] h-[27px] rounded-full bg-white shadow-sm ${\n            enabled ? \"ml-auto\" : \"\"\n          }`}\n        />\n      </div>\n    </button>\n  );\n}\n\nfunction DevicesView({\n  devices,\n  onBack,\n  onAddDevice,\n}: {\n  devices: {\n    id: string;\n    name: string;\n    lastActive: string;\n    syncing?: boolean;\n  }[];\n  onBack: () => void;\n  onAddDevice: () => void;\n}) {\n  return (\n    <div className=\"h-full flex flex-col pb-4 overflow-y-auto\">\n      {/* Header */}\n      <header className=\"px-5 pt-6 pb-4 bg-[#F2F2F7]\">\n        <button\n          onClick={onBack}\n          className=\"sketch-body text-[#2563EB] mb-2 flex items-center gap-2\"\n        >\n          ← Zurück\n        </button>\n        <h1 className=\"sketch-heading text-[32px]\">Geräte</h1>\n      </header>\n\n      <div className=\"flex-1 px-5\">\n        <div className=\"bg-white rounded-xl overflow-hidden\">\n          {devices.map((device, index) => (\n            <div key={device.id}>\n              {index > 0 && <div className=\"h-[0.5px] bg-[#E5E5EA] ml-4\" />}\n              <div className=\"flex items-center gap-3 p-4\">\n                <CustomIcon name=\"smartphone\" size={32} />\n                <div className=\"flex-1\">\n                  <p className=\"text-[17px] text-[#1D1D1F]\">{device.name}</p>\n                  <p className=\"text-[13px] text-[#6E6E73]\">\n                    {device.lastActive}\n                  </p>\n                </div>\n                {device.syncing ? (\n                  <Loader2 className=\"w-5 h-5 text-[#007AFF] animate-spin\" />\n                ) : device.lastActive === \"Aktiv\" ? (\n                  <div className=\"flex items-center gap-1\">\n                    <Check className=\"w-4 h-4 text-[#30D158]\" />\n                    <span className=\"text-[13px] text-[#30D158] font-medium\">\n                      Dieses Gerät\n                    </span>\n                  </div>\n                ) : null}\n              </div>\n            </div>\n          ))}\n        </div>\n\n        <button\n          onClick={onAddDevice}\n          className=\"w-full flex items-center justify-center gap-2 mt-6 p-4 bg-white rounded-xl ios-tap-target\"\n        >\n          <Plus className=\"w-5 h-5 text-[#007AFF]\" />\n          <span className=\"text-[17px] text-[#007AFF]\">\n            Neues Gerät verbinden\n          </span>\n        </button>\n\n        <p className=\"text-[13px] text-[#6E6E73] text-center mt-3\">\n          Scanne den QR-Code oder gib deine Backup-Phrase ein\n        </p>\n      </div>\n    </div>\n  );\n}\n\nfunction SourceSelectorModal({\n  currentSource,\n  onSelect,\n  onClose,\n}: {\n  currentSource: \"photos-app\" | \"files-app\";\n  onSelect: (source: \"photos-app\" | \"files-app\") => void;\n  onClose: () => void;\n}) {\n  const sources = [\n    {\n      id: \"photos-app\" as const,\n      label: \"Fotos-App\",\n      description: \"Alle Fotos aus der iOS Foto-Bibliothek\",\n    },\n    {\n      id: \"files-app\" as const,\n      label: \"Dateien-App\",\n      description: \"Fotos aus einem bestimmten Ordner\",\n    },\n  ];\n\n  return (\n    <div className=\"fixed inset-0 bg-black/40 flex items-end justify-center z-50\">\n      <div className=\"bg-white w-full max-w-[428px] rounded-t-2xl p-6 pb-10\">\n        <h3 className=\"sf-pro-display text-[20px] text-[#1D1D1F] text-center mb-2\">\n          Backup-Quelle\n        </h3>\n        <p className=\"text-[15px] text-[#6E6E73] text-center mb-6\">\n          Wo sind deine Fotos gespeichert?\n        </p>\n\n        <div className=\"space-y-3 mb-6\">\n          {sources.map((source) => (\n            <button\n              key={source.id}\n              onClick={() => onSelect(source.id)}\n              className={`w-full p-4 rounded-xl bg-[#F2F2F7] text-left ios-tap-target ${\n                currentSource === source.id ? \"ring-2 ring-[#007AFF]\" : \"\"\n              }`}\n            >\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-[17px] font-medium text-[#1D1D1F]\">\n                    {source.label}\n                  </p>\n                  <p className=\"text-[13px] text-[#6E6E73] mt-0.5\">\n                    {source.description}\n                  </p>\n                </div>\n                <div\n                  className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${\n                    currentSource === source.id\n                      ? \"border-[#007AFF] bg-[#007AFF]\"\n                      : \"border-[#C7C7CC]\"\n                  }`}\n                >\n                  {currentSource === source.id && (\n                    <div className=\"w-2.5 h-2.5 rounded-full bg-white\" />\n                  )}\n                </div>\n              </div>\n            </button>\n          ))}\n        </div>\n\n        <button\n          onClick={onClose}\n          className=\"w-full h-[44px] text-[#007AFF] text-[17px] ios-tap-target\"\n        >\n          Abbrechen\n        </button>\n      </div>\n    </div>\n  );\n}\n\nfunction PlanSelectorModal({\n  currentPlan,\n  onSelect,\n  onClose,\n}: {\n  currentPlan: \"free\" | \"backup-plus\";\n  onSelect: (plan: \"free\" | \"backup-plus\") => void;\n  onClose: () => void;\n}) {\n  const plans = [\n    {\n      id: \"free\" as const,\n      label: \"FREE\",\n      subtitle: \"Auf deinen Geräten\",\n      price: \"0€/Monat\",\n      features: [\n        \"Unbegrenzte Fotos\",\n        \"Zero-Knowledge Verschlüsselung\",\n        \"Multi-Device Sync\",\n      ],\n    },\n    {\n      id: \"backup-plus\" as const,\n      label: \"BACKUP+\",\n      subtitle: \"Dauerhaft im Netz\",\n      price: \"2,99€/Monat\",\n      features: [\n        \"Alles von Free\",\n        \"200 GB Cloud-Backup\",\n        \"Schnellere Synchronisierung\",\n      ],\n    },\n  ];\n\n  return (\n    <div className=\"fixed inset-0 bg-black/40 flex items-end justify-center z-50\">\n      <div className=\"bg-white w-full max-w-[428px] rounded-t-2xl p-6 pb-10 max-h-[80vh] overflow-y-auto\">\n        <h3 className=\"sf-pro-display text-[20px] text-[#1D1D1F] text-center mb-2\">\n          Speicherplan\n        </h3>\n        <p className=\"text-[15px] text-[#6E6E73] text-center mb-6\">\n          Du kannst jederzeit wechseln\n        </p>\n\n        <div className=\"space-y-3 mb-6\">\n          {plans.map((plan) => (\n            <button\n              key={plan.id}\n              onClick={() => onSelect(plan.id)}\n              className={`w-full p-4 rounded-xl bg-[#F2F2F7] text-left ios-tap-target ${\n                currentPlan === plan.id ? \"ring-2 ring-[#007AFF]\" : \"\"\n              }`}\n            >\n              <div className=\"flex items-start justify-between\">\n                <div className=\"flex-1\">\n                  <p className=\"text-[13px] font-bold text-[#007AFF] tracking-wide\">\n                    {plan.label}\n                  </p>\n                  <p className=\"text-[17px] font-semibold text-[#1D1D1F] mt-0.5\">\n                    {plan.subtitle}\n                  </p>\n                  <ul className=\"mt-2 space-y-1\">\n                    {plan.features.map((feature) => (\n                      <li\n                        key={feature}\n                        className=\"text-[13px] text-[#6E6E73] flex items-center gap-2\"\n                      >\n                        <span className=\"text-[#30D158]\">✓</span> {feature}\n                      </li>\n                    ))}\n                  </ul>\n                  <p className=\"text-[15px] font-semibold text-[#1D1D1F] mt-3\">\n                    {plan.price}\n                  </p>\n                </div>\n                <div\n                  className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${\n                    currentPlan === plan.id\n                      ? \"border-[#007AFF] bg-[#007AFF]\"\n                      : \"border-[#C7C7CC]\"\n                  }`}\n                >\n                  {currentPlan === plan.id && (\n                    <div className=\"w-2.5 h-2.5 rounded-full bg-white\" />\n                  )}\n                </div>\n              </div>\n            </button>\n          ))}\n        </div>\n\n        <button\n          onClick={onClose}\n          className=\"w-full h-[44px] text-[#007AFF] text-[17px] ios-tap-target\"\n        >\n          Abbrechen\n        </button>\n      </div>\n    </div>\n  );\n}\n\nfunction Modal({\n  title,\n  message,\n  confirmLabel,\n  confirmDestructive,\n  onConfirm,\n  onCancel,\n}: {\n  title: string;\n  message: string;\n  confirmLabel: string;\n  confirmDestructive: boolean;\n  onConfirm: () => void;\n  onCancel: () => void;\n}) {\n  return (\n    <div className=\"fixed inset-0 bg-black/40 flex items-center justify-center z-50 px-8\">\n      <div className=\"bg-white w-full max-w-[270px] rounded-2xl overflow-hidden\">\n        <div className=\"p-4 text-center\">\n          <h3 className=\"sf-pro-display text-[17px] text-[#1D1D1F] mb-1\">\n            {title}\n          </h3>\n          <p className=\"text-[13px] text-[#6E6E73] leading-relaxed\">\n            {message}\n          </p>\n        </div>\n        <div className=\"border-t border-[#E5E5EA]\">\n          <button\n            onClick={onCancel}\n            className=\"w-full py-3 text-[17px] text-[#007AFF] border-b border-[#E5E5EA] ios-tap-target\"\n          >\n            Abbrechen\n          </button>\n          <button\n            onClick={onConfirm}\n            className={`w-full py-3 text-[17px] font-semibold ios-tap-target ${\n              confirmDestructive ? \"text-[#FF3B30]\" : \"text-[#007AFF]\"\n            }`}\n          >\n            {confirmLabel}\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4469, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/lib/heic-converter.ts"],"sourcesContent":["/**\n * HEIC Converter - Non-blocking HEIC to JPEG conversion\n * Uses Web Worker for iPad/iPhone performance optimization\n *\n * Phase 2: Performance Optimization\n */\n\ninterface ConversionResult {\n    file: File;\n    converted: boolean;\n    originalSize?: number;\n    convertedSize?: number;\n}\n\n// Singleton worker instance\nlet worker: Worker | null = null;\nlet messageId = 0;\nconst pendingConversions = new Map<number, {\n    resolve: (result: ConversionResult) => void;\n    reject: (error: Error) => void;\n}>();\n\n/**\n * Initialize the HEIC worker (lazy initialization)\n */\nfunction getWorker(): Worker | null {\n    if (typeof window === 'undefined') return null;\n\n    if (!worker) {\n        try {\n            worker = new Worker('/workers/heic-worker.js');\n            worker.onmessage = handleWorkerMessage;\n            worker.onerror = handleWorkerError;\n            console.log('[HEIC] Worker initialized');\n        } catch (error) {\n            console.warn('[HEIC] Worker creation failed, will use main thread:', error);\n            return null;\n        }\n    }\n\n    return worker;\n}\n\n/**\n * Handle messages from the worker\n */\nfunction handleWorkerMessage(e: MessageEvent) {\n    const { id, success, file, blob, fileName, mimeType, converted, error, originalSize, convertedSize } = e.data;\n\n    const pending = pendingConversions.get(id);\n    if (!pending) return;\n\n    pendingConversions.delete(id);\n\n    if (!success) {\n        pending.reject(new Error(error || 'Conversion failed'));\n        return;\n    }\n\n    // If we got a blob back, create a File from it\n    if (blob && converted) {\n        const convertedFile = new File([blob], fileName, {\n            type: mimeType,\n            lastModified: Date.now()\n        });\n        pending.resolve({\n            file: convertedFile,\n            converted: true,\n            originalSize,\n            convertedSize\n        });\n    } else {\n        // Original file returned (not HEIC or conversion skipped)\n        pending.resolve({\n            file: file,\n            converted: false\n        });\n    }\n}\n\n/**\n * Handle worker errors\n */\nfunction handleWorkerError(error: ErrorEvent) {\n    console.error('[HEIC] Worker error:', error);\n    // Reject all pending conversions\n    pendingConversions.forEach(({ reject }) => {\n        reject(new Error('Worker error: ' + error.message));\n    });\n    pendingConversions.clear();\n\n    // Reset worker for retry\n    worker = null;\n}\n\n/**\n * Convert HEIC/HEIF to JPEG using Web Worker (non-blocking)\n * Falls back to main thread if worker is unavailable\n */\nexport async function convertHeicToJpeg(file: File, quality: number = 0.92): Promise<ConversionResult> {\n    // Check if conversion is needed first\n    const heicTypes = ['image/heic', 'image/heif', 'image/heic-sequence', 'image/heif-sequence'];\n    const isHeic = heicTypes.includes(file.type?.toLowerCase()) ||\n                   file.name?.toLowerCase().endsWith('.heic') ||\n                   file.name?.toLowerCase().endsWith('.heif');\n\n    if (!isHeic) {\n        return { file, converted: false };\n    }\n\n    // Try to use Web Worker for non-blocking conversion\n    const workerInstance = getWorker();\n\n    if (workerInstance) {\n        return new Promise((resolve, reject) => {\n            const id = ++messageId;\n            pendingConversions.set(id, { resolve, reject });\n\n            // Set timeout for conversion (2 minutes max)\n            setTimeout(() => {\n                if (pendingConversions.has(id)) {\n                    pendingConversions.delete(id);\n                    console.warn('[HEIC] Worker timeout, falling back to main thread');\n                    convertOnMainThread(file, quality).then(resolve).catch(reject);\n                }\n            }, 120000);\n\n            workerInstance.postMessage({ id, file, quality });\n        });\n    }\n\n    // Fallback to main thread\n    console.log('[HEIC] Using main thread conversion');\n    return convertOnMainThread(file, quality);\n}\n\n/**\n * Fallback: Convert on main thread (blocks UI but works everywhere)\n */\nasync function convertOnMainThread(file: File, quality: number): Promise<ConversionResult> {\n    try {\n        // Dynamic import heic2any\n        const heic2any = (await import('heic2any')).default;\n\n        const convertedBlob = await heic2any({\n            blob: file,\n            toType: 'image/jpeg',\n            quality\n        });\n\n        const resultBlob = Array.isArray(convertedBlob) ? convertedBlob[0] : convertedBlob;\n        const newFileName = file.name.replace(/\\.(heic|heif)$/i, '.jpg');\n\n        const convertedFile = new File([resultBlob], newFileName, {\n            type: 'image/jpeg',\n            lastModified: file.lastModified\n        });\n\n        return {\n            file: convertedFile,\n            converted: true,\n            originalSize: file.size,\n            convertedSize: convertedFile.size\n        };\n    } catch (error) {\n        console.error('[HEIC] Main thread conversion failed:', error);\n        // Return original on error\n        return { file, converted: false };\n    }\n}\n\n/**\n * Check if the file is a HEIC/HEIF image\n */\nexport function isHeicFile(file: File): boolean {\n    const heicTypes = ['image/heic', 'image/heif', 'image/heic-sequence', 'image/heif-sequence'];\n    return heicTypes.includes(file.type?.toLowerCase()) ||\n           file.name?.toLowerCase().endsWith('.heic') ||\n           file.name?.toLowerCase().endsWith('.heif');\n}\n\n/**\n * Terminate the worker (call on app cleanup)\n */\nexport function terminateHeicWorker(): void {\n    if (worker) {\n        worker.terminate();\n        worker = null;\n        pendingConversions.clear();\n        console.log('[HEIC] Worker terminated');\n    }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4636, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/hooks/use-gallery-data.ts"],"sourcesContent":["/**\n * useGalleryData Hook - Local Photo Gallery Management with IPFS Cloud Sync\n * Photos are encrypted client-side and stored on IPFS\n * Only metadata (CID, nonce, etc.) is stored in Supabase\n */\n\n'use client';\n\nimport { useState, useEffect, useCallback } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport {\n    getAllPhotos,\n    savePhoto,\n    deletePhoto,\n    getPhotoCount,\n    type PhotoMetadata,\n} from '@/lib/storage/local-db';\nimport { encryptFile, decryptFile, getUserKeyHash } from '@/lib/crypto';\nimport { uploadCIDMetadata } from '@/lib/supabase';\nimport { remoteStorage } from '@/lib/storage/remote-storage';\nimport { getDeviceId } from '@/lib/deviceId';\n\n// HEIC conversion moved to Web Worker for non-blocking performance\n// See src/lib/heic-converter.ts\nimport { convertHeicToJpeg } from '@/lib/heic-converter';\n\nexport function useGalleryData(secretKey: Uint8Array | null) {\n    const queryClient = useQueryClient();\n    const [userKeyHash, setUserKeyHash] = useState<string | null>(null);\n\n    // Generate Key Hash when secretKey changes\n    useEffect(() => {\n        if (secretKey) {\n            getUserKeyHash(secretKey).then(setUserKeyHash);\n        } else {\n            setUserKeyHash(null);\n        }\n    }, [secretKey]);\n\n    // Query: Load all photos from local IndexedDB\n    // WICHTIG: Query ist IMMER enabled - IndexedDB braucht kein secretKey\n    // Decryption passiert separat wenn secretKey vorhanden ist\n    const {\n        data: photos = [],\n        isLoading,\n        error,\n    } = useQuery({\n        queryKey: ['photos'],\n        queryFn: getAllPhotos,\n        enabled: true, // Immer laden, unabhängig von secretKey\n    });\n\n    // Query: Photo count\n    const { data: photoCount = 0 } = useQuery({\n        queryKey: ['photoCount'],\n        queryFn: getPhotoCount,\n    });\n\n    const [uploadProgress, setUploadProgress] = useState<number>(0);\n\n    // Mutation: Upload photo (convert HEIC -> encrypt -> IPFS -> Supabase metadata)\n    const uploadMutation = useMutation({\n        mutationFn: async (file: File) => {\n            if (!secretKey) throw new Error('No encryption key');\n            if (!userKeyHash) throw new Error('userKeyHash not ready - bitte kurz warten');\n\n            console.log('[Upload] Starting upload:', file.name);\n            setUploadProgress(0);\n\n            // Step 0: Convert HEIC to JPEG if needed (iOS compatibility)\n            // Uses Web Worker for non-blocking conversion on iPad/iPhone\n            const conversionResult = await convertHeicToJpeg(file);\n            const processedFile = conversionResult.file;\n\n            if (conversionResult.converted) {\n                console.log('[Upload] HEIC converted:', {\n                    originalSize: conversionResult.originalSize,\n                    convertedSize: conversionResult.convertedSize\n                });\n            }\n\n            // Step 1: Encrypt file client-side\n            const { encrypted, nonce } = await encryptFile(processedFile, secretKey);\n            console.log('[Upload] Encrypted:', { size: encrypted.size });\n\n            // Step 2: Upload encrypted blob to IPFS -> returns real CID\n            let cid: string;\n            try {\n                cid = await remoteStorage.upload(encrypted, processedFile.name, (progress) => {\n                    setUploadProgress(progress);\n                });\n                console.log('[Upload] IPFS CID:', cid);\n            } catch (error) {\n                console.error('[Upload] IPFS failed:', error);\n                // Generate fallback local CID for offline-first\n                cid = `cid_${Date.now()}_${Math.random().toString(36).slice(2)}`;\n                console.log('[Upload] Using fallback CID:', cid);\n            }\n\n            // Step 3: Save to local IndexedDB (for immediate access)\n            const metadata: Omit<PhotoMetadata, 'id'> = {\n                cid,\n                nonce,\n                fileName: processedFile.name,\n                mimeType: processedFile.type,\n                fileSize: processedFile.size,\n                uploadedAt: new Date(),\n                encryptedBlob: encrypted, // Keep locally for fast access\n            };\n\n            try {\n                await savePhoto(metadata);\n                console.log('[Upload] Saved to IndexedDB:', cid);\n            } catch (dbError) {\n                console.error('[Upload] IndexedDB save FAILED:', dbError);\n                throw dbError; // Fail the mutation - this is critical\n            }\n\n            // Step 4: Sync metadata to Supabase (CID only, no blob)\n            const deviceId = getDeviceId();\n            try {\n                await uploadCIDMetadata(\n                    cid,\n                    processedFile.size,\n                    deviceId,\n                    nonce,\n                    processedFile.type,\n                    userKeyHash // Jetzt garantiert nicht undefined\n                );\n                console.log('[Upload] Supabase synced:', cid);\n            } catch (error) {\n                console.error('[Upload] Supabase sync failed (local + IPFS OK):', error);\n                // Don't throw - local + IPFS save succeeded\n            }\n\n            return metadata;\n        },\n        onSuccess: () => {\n            // Sofort Queries invalidieren für UI-Update\n            queryClient.invalidateQueries({ queryKey: ['photos'] });\n            queryClient.invalidateQueries({ queryKey: ['photoCount'] });\n            console.log('[Upload] Complete - queries invalidated');\n        },\n        onError: (error) => {\n            console.error('[Upload] Mutation failed:', error);\n        },\n    });\n\n    // Mutation: Delete photo\n    const deleteMutation = useMutation({\n        mutationFn: async (id: number) => {\n            await deletePhoto(id);\n            // Note: IPFS content is immutable - we just remove our reference\n            // In production, you might want to unpin from Pinata\n        },\n        onSuccess: () => {\n            queryClient.invalidateQueries({ queryKey: ['photos'] });\n            queryClient.invalidateQueries({ queryKey: ['photoCount'] });\n        },\n    });\n\n    // Decrypt photo for display\n    const decryptPhoto = useCallback(\n        async (photo: PhotoMetadata): Promise<string | null> => {\n            if (!secretKey || !photo.encryptedBlob) return null;\n\n            const decrypted = await decryptFile(\n                photo.encryptedBlob,\n                photo.nonce,\n                secretKey,\n                photo.mimeType\n            );\n\n            if (!decrypted) return null;\n\n            return URL.createObjectURL(decrypted);\n        },\n        [secretKey]\n    );\n\n    return {\n        photos,\n        photoCount,\n        isLoading,\n        error,\n        uploadPhoto: uploadMutation.mutate,\n        deletePhoto: deleteMutation.mutate,\n        decryptPhoto,\n        isUploading: uploadMutation.isPending,\n        uploadProgress,\n        userKeyHash\n    };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4824, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/hooks/useRealtimeSync.ts"],"sourcesContent":["/**\n * useRealtimeSync Hook - Real-time METADATA sync across devices via Supabase\n *\n * This is a \"thin\" sync layer - it ONLY syncs metadata (CIDs, nonce, etc.)\n * The actual photo content stays on IPFS and is fetched on-demand by the UI\n *\n * PHASE 3 FIXES:\n * - Fixed race conditions with proper ref usage\n * - Added debouncing for rapid events\n * - Separated subscription setup from data loading\n * - Proper cleanup on unmount\n */\n\n'use client';\n\nimport { useEffect, useCallback, useState, useRef } from 'react';\nimport { supabase, loadCIDsFromSupabase } from '@/lib/supabase';\nimport { getDeviceId } from '@/lib/deviceId';\nimport { getUserKeyHash } from '@/lib/crypto';\nimport type { RealtimeChannel } from '@supabase/supabase-js';\n\nexport interface SyncedPhoto {\n  cid: string;\n  device_id: string;\n  uploaded_at: string;\n  file_size_bytes: number | null;\n  nonce: string | null;\n  mime_type: string | null;\n  isFromOtherDevice: boolean;\n}\n\ninterface UseRealtimeSyncOptions {\n  onNewPhoto?: (photo: SyncedPhoto) => void;\n  onPhotoDeleted?: (cid: string) => void;\n  enabled?: boolean;\n  secretKey?: Uint8Array | null;\n}\n\nexport function useRealtimeSync(options: UseRealtimeSyncOptions = {}) {\n  const { onNewPhoto, onPhotoDeleted, enabled = true, secretKey } = options;\n  const [remoteCIDs, setRemoteCIDs] = useState<SyncedPhoto[]>([]);\n  const [isConnected, setIsConnected] = useState(false);\n  const [lastSyncError, setLastSyncError] = useState<Error | null>(null);\n  const [userKeyHash, setUserKeyHash] = useState<string | null>(null);\n\n  // Refs to avoid stale closures in callbacks\n  const userKeyHashRef = useRef<string | null>(null);\n  const deviceIdRef = useRef<string>('server');\n  const onNewPhotoRef = useRef(onNewPhoto);\n  const onPhotoDeletedRef = useRef(onPhotoDeleted);\n  const channelRef = useRef<RealtimeChannel | null>(null);\n  const isSubscribedRef = useRef(false);\n\n  // Update refs when values change\n  useEffect(() => {\n    onNewPhotoRef.current = onNewPhoto;\n    onPhotoDeletedRef.current = onPhotoDeleted;\n  }, [onNewPhoto, onPhotoDeleted]);\n\n  // Initialize device ID (only on client)\n  useEffect(() => {\n    if (typeof window !== 'undefined') {\n      deviceIdRef.current = getDeviceId();\n    }\n  }, []);\n\n  // Generate Key Hash when secretKey changes\n  useEffect(() => {\n    let isMounted = true;\n\n    if (secretKey) {\n      getUserKeyHash(secretKey).then((hash) => {\n        if (isMounted) {\n          setUserKeyHash(hash);\n          userKeyHashRef.current = hash;\n        }\n      });\n    } else {\n      setUserKeyHash(null);\n      userKeyHashRef.current = null;\n    }\n\n    return () => {\n      isMounted = false;\n    };\n  }, [secretKey]);\n\n  // Load initial CIDs from Supabase (metadata only)\n  // Using ref for userKeyHash to avoid recreating callback\n  const loadRemoteCIDs = useCallback(async () => {\n    const currentKeyHash = userKeyHashRef.current;\n    const currentDeviceId = deviceIdRef.current;\n\n    if (!currentKeyHash) return [];\n\n    try {\n      const data = await loadCIDsFromSupabase(currentDeviceId, currentKeyHash);\n      const photos: SyncedPhoto[] = data.map((row: { cid: string; device_id: string; uploaded_at: string; file_size_bytes: number | null; nonce: string | null; mime_type: string | null }) => ({\n        cid: row.cid,\n        device_id: row.device_id,\n        uploaded_at: row.uploaded_at,\n        file_size_bytes: row.file_size_bytes,\n        nonce: row.nonce || null,\n        mime_type: row.mime_type || null,\n        isFromOtherDevice: row.device_id !== currentDeviceId,\n      }));\n      setRemoteCIDs(photos);\n      setLastSyncError(null);\n      return photos;\n    } catch (error) {\n      console.error('Failed to load remote CIDs:', error);\n      setLastSyncError(error as Error);\n      return [];\n    }\n  }, []); // Empty deps - uses refs\n\n  // Load data when userKeyHash becomes available\n  useEffect(() => {\n    if (userKeyHash && enabled) {\n      loadRemoteCIDs();\n    }\n  }, [userKeyHash, enabled, loadRemoteCIDs]);\n\n  // Subscribe to realtime changes - SEPARATE from data loading\n  useEffect(() => {\n    if (!enabled || typeof window === 'undefined') return;\n\n    // Don't subscribe if already subscribed\n    if (isSubscribedRef.current) return;\n\n    // Wait for userKeyHash to be ready before subscribing\n    if (!userKeyHash) return;\n\n    console.log('[Realtime] Setting up subscription...');\n    isSubscribedRef.current = true;\n\n    // Debounce helper for rapid events\n    let eventQueue: SyncedPhoto[] = [];\n    let debounceTimer: NodeJS.Timeout | null = null;\n\n    const processEventQueue = () => {\n      if (eventQueue.length === 0) return;\n\n      setRemoteCIDs((prev) => {\n        const newPhotos = eventQueue.filter(\n          (photo) => !prev.some((p) => p.cid === photo.cid)\n        );\n        if (newPhotos.length === 0) return prev;\n        return [...newPhotos, ...prev];\n      });\n\n      // Notify callbacks for photos from other devices\n      eventQueue\n        .filter((p) => p.isFromOtherDevice)\n        .forEach((photo) => {\n          console.log('[Realtime] New photo from another device:', photo.cid);\n          onNewPhotoRef.current?.(photo);\n        });\n\n      eventQueue = [];\n    };\n\n    const channel = supabase\n      .channel(`photos_metadata_${userKeyHash.slice(0, 8)}`)\n      .on(\n        'postgres_changes',\n        {\n          event: 'INSERT',\n          schema: 'public',\n          table: 'photos_metadata',\n        },\n        (payload) => {\n          const newPhoto = payload.new as {\n            cid: string;\n            device_id: string;\n            uploaded_at: string;\n            file_size_bytes: number | null;\n            nonce: string | null;\n            mime_type: string | null;\n            user_key_hash: string | null;\n          };\n\n          // Only process if it belongs to this user\n          const currentKeyHash = userKeyHashRef.current;\n          if (currentKeyHash && newPhoto.user_key_hash !== currentKeyHash) {\n            return;\n          }\n\n          const syncedPhoto: SyncedPhoto = {\n            cid: newPhoto.cid,\n            device_id: newPhoto.device_id,\n            uploaded_at: newPhoto.uploaded_at,\n            file_size_bytes: newPhoto.file_size_bytes,\n            nonce: newPhoto.nonce,\n            mime_type: newPhoto.mime_type,\n            isFromOtherDevice: newPhoto.device_id !== deviceIdRef.current,\n          };\n\n          // Add to queue for debounced processing\n          eventQueue.push(syncedPhoto);\n\n          // Debounce: process after 100ms of no new events\n          if (debounceTimer) clearTimeout(debounceTimer);\n          debounceTimer = setTimeout(processEventQueue, 100);\n        }\n      )\n      .on(\n        'postgres_changes',\n        {\n          event: 'DELETE',\n          schema: 'public',\n          table: 'photos_metadata',\n        },\n        (payload) => {\n          const deleted = payload.old as { cid: string };\n          onPhotoDeletedRef.current?.(deleted.cid);\n          setRemoteCIDs((prev) => prev.filter((p) => p.cid !== deleted.cid));\n        }\n      )\n      .subscribe((status) => {\n        console.log('[Realtime] Status:', status);\n        setIsConnected(status === 'SUBSCRIBED');\n\n        // Auto-reconnect on channel error with exponential backoff\n        if (status === 'CHANNEL_ERROR') {\n          console.log('[Realtime] Channel error, retrying in 5s...');\n          setTimeout(() => {\n            if (channelRef.current && isSubscribedRef.current) {\n              channelRef.current.subscribe();\n            }\n          }, 5000);\n        }\n      });\n\n    channelRef.current = channel;\n\n    return () => {\n      console.log('[Realtime] Cleaning up subscription...');\n      isSubscribedRef.current = false;\n\n      if (debounceTimer) clearTimeout(debounceTimer);\n\n      if (channelRef.current) {\n        supabase.removeChannel(channelRef.current);\n        channelRef.current = null;\n      }\n    };\n  }, [enabled, userKeyHash]); // Only depend on enabled and userKeyHash\n\n  // Force refresh\n  const refresh = useCallback(async () => {\n    return loadRemoteCIDs();\n  }, [loadRemoteCIDs]);\n\n  // Get CIDs from other devices only\n  const remoteCIDsFromOtherDevices = remoteCIDs.filter((p) => p.isFromOtherDevice);\n\n  return {\n    remoteCIDs,\n    remoteCIDsFromOtherDevices,\n    isConnected,\n    lastSyncError,\n    refresh,\n    deviceId: deviceIdRef.current,\n    userKeyHash,\n  };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4966, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/components/photovault/DecryptedThumbnail.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState, useEffect, useRef } from \"react\";\nimport { Loader2, Cloud } from \"lucide-react\";\nimport { CustomIcon } from \"@/components/ui/custom-icon\";\nimport { decryptFile } from \"@/lib/crypto\";\nimport { remoteStorage } from \"@/lib/storage/remote-storage\";\nimport { isRealIPFSCID } from \"@/lib/storage/remote-storage\";\nimport type { PhotoMetadata } from \"@/lib/storage/local-db\";\n\ninterface DecryptedThumbnailProps {\n    photo: PhotoMetadata;\n    secretKey: Uint8Array | null;\n    /** If true, show cloud icon overlay for cloud-only photos */\n    showCloudBadge?: boolean;\n}\n\nexport function DecryptedThumbnail({\n    photo,\n    secretKey,\n    showCloudBadge = true\n}: DecryptedThumbnailProps) {\n    const [imageUrl, setImageUrl] = useState<string | null>(null);\n    const [error, setError] = useState(false);\n    const [isDecrypting, setIsDecrypting] = useState(false);\n    const [isFetchingFromCloud, setIsFetchingFromCloud] = useState(false);\n    const [isCloudPhoto, setIsCloudPhoto] = useState(false);\n\n    // Track the current image URL for cleanup\n    const currentUrlRef = useRef<string | null>(null);\n\n    useEffect(() => {\n        // Skip if no key or already have URL\n        if (!secretKey || imageUrl) return;\n\n        const loadAndDecrypt = async () => {\n            setIsDecrypting(true);\n\n            try {\n                let blobToDecrypt: Blob | undefined = photo.encryptedBlob;\n\n                // If no local blob, try to fetch from IPFS (cloud)\n                if (!blobToDecrypt && photo.cid && isRealIPFSCID(photo.cid)) {\n                    setIsFetchingFromCloud(true);\n                    setIsCloudPhoto(true);\n                    console.log('Fetching from IPFS for thumbnail:', photo.cid);\n\n                    try {\n                        blobToDecrypt = await remoteStorage.download(photo.cid);\n                        console.log('Fetched from IPFS:', { cid: photo.cid, size: blobToDecrypt.size });\n                    } catch (fetchError) {\n                        console.error(`Failed to fetch from IPFS (CID: ${photo.cid}):`, fetchError);\n                        setError(true);\n                        return;\n                    } finally {\n                        setIsFetchingFromCloud(false);\n                    }\n                }\n\n                // If still no blob, show error\n                if (!blobToDecrypt) {\n                    console.log('No blob available for:', photo.cid);\n                    // Don't set error - this might be a cloud-only photo not yet fetched\n                    setIsCloudPhoto(true);\n                    return;\n                }\n\n                // Decrypt the blob\n                const decrypted = await decryptFile(\n                    blobToDecrypt,\n                    photo.nonce,\n                    secretKey,\n                    photo.mimeType\n                );\n\n                if (decrypted) {\n                    const url = URL.createObjectURL(decrypted);\n                    currentUrlRef.current = url;\n                    setImageUrl(url);\n                } else {\n                    setError(true);\n                }\n            } catch (err) {\n                console.error(\"Failed to decrypt photo:\", photo.cid, err);\n                setError(true);\n            } finally {\n                setIsDecrypting(false);\n            }\n        };\n\n        loadAndDecrypt();\n\n        // Cleanup: Revoke object URL when component unmounts or photo changes\n        return () => {\n            if (currentUrlRef.current) {\n                // Delay revocation slightly to avoid WebKitBlobResource-Fehler on some browsers\n                // while the image might still be painting or being accessed\n                const urlToRevoke = currentUrlRef.current;\n                setTimeout(() => {\n                    try {\n                        URL.revokeObjectURL(urlToRevoke);\n                    } catch (e) {\n                        // Ignore errors during revocation\n                    }\n                }, 1000);\n                currentUrlRef.current = null;\n            }\n        };\n    }, [photo, secretKey, imageUrl]);\n\n    // Error state\n    if (error) {\n        return (\n            <div className=\"w-full h-full flex flex-col items-center justify-center bg-red-50 text-red-500 p-2 text-center\">\n                <CustomIcon name=\"lock\" size={24} className=\"mb-1 opacity-50\" />\n                <span className=\"text-[10px]\">Fehler</span>\n            </div>\n        );\n    }\n\n    // Loading state (fetching from cloud)\n    if (isFetchingFromCloud) {\n        return (\n            <div className=\"w-full h-full flex flex-col items-center justify-center bg-blue-50\">\n                <Cloud className=\"w-5 h-5 text-blue-400 mb-1 animate-pulse\" />\n                <Loader2 className=\"w-4 h-4 animate-spin text-blue-400\" />\n                <span className=\"text-[9px] text-blue-500 mt-1\">Laden...</span>\n            </div>\n        );\n    }\n\n    // Loading state (decrypting)\n    if (isDecrypting || !imageUrl) {\n        // Cloud-only photo placeholder\n        if (isCloudPhoto && !imageUrl && !isDecrypting) {\n            return (\n                <div className=\"w-full h-full flex flex-col items-center justify-center bg-gray-100 relative\">\n                    <Cloud className=\"w-6 h-6 text-gray-400\" />\n                    <span className=\"text-[9px] text-gray-500 mt-1\">In der Cloud</span>\n                </div>\n            );\n        }\n\n        return (\n            <div className=\"w-full h-full flex items-center justify-center bg-gray-100\">\n                <Loader2 className=\"w-6 h-6 animate-spin text-gray-400\" />\n            </div>\n        );\n    }\n\n    // Image loaded - show with optional cloud badge\n    return (\n        <div className=\"relative w-full h-full\">\n            <img\n                src={imageUrl}\n                alt=\"\"\n                className=\"w-full h-full object-cover animate-in fade-in duration-500\"\n                loading=\"lazy\"\n            />\n            {/* Cloud badge overlay for photos fetched from cloud */}\n            {showCloudBadge && isCloudPhoto && (\n                <div className=\"absolute bottom-1 right-1 bg-black/50 rounded-full p-1\">\n                    <Cloud className=\"w-3 h-3 text-white\" />\n                </div>\n            )}\n        </div>\n    );\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5210, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/components/photovault/PhotoGallery.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState, useRef, useCallback, useMemo } from \"react\";\nimport { SlidersHorizontal, X, Check, CloudOff, Download, Loader2, Cloud } from \"lucide-react\";\nimport { CustomIcon } from \"@/components/ui/custom-icon\";\nimport { useEncryption } from \"@/hooks/use-encryption\";\nimport { useGalleryData } from \"@/hooks/use-gallery-data\";\nimport { useRealtimeSync, type SyncedPhoto } from \"@/hooks/useRealtimeSync\";\nimport { DecryptedThumbnail } from \"./DecryptedThumbnail\";\nimport { remoteStorage, isRealIPFSCID } from \"@/lib/storage/remote-storage\";\nimport { decryptFile } from \"@/lib/crypto\";\nimport type { PhotoMetadata } from \"@/lib/storage/local-db\";\n\ninterface PhotoGalleryProps {\n  photosCount?: number;\n  authUser: { id: string; email: string } | null;\n}\n\n// Generate placeholder photo URLs with dates\nconst generatePhotos = (count: number) => {\n    const categories = [\n        \"nature\",\n        \"architecture\",\n        \"travel\",\n        \"food\",\n        \"animals\",\n        \"city\",\n        \"landscape\",\n        \"portrait\",\n        \"ocean\",\n        \"forest\",\n    ];\n\n    // Create photos with dates going backwards from today\n    const today = new Date();\n    return Array.from({ length: count }, (_, i) => {\n        const date = new Date(today);\n        date.setDate(date.getDate() - Math.floor(i / 3)); // 3 photos per day\n\n        return {\n            id: `photo-${i}`,\n            cid: `Qm${Math.random().toString(36).substring(2, 15)}${Math.random().toString(36).substring(2, 15)}`,\n            placeholderUrl: `https://picsum.photos/seed/${i + 100}/400/400`,\n            category: categories[i % categories.length],\n            date: date.toISOString().split(\"T\")[0],\n            metadata: undefined as PhotoMetadata | undefined,\n        };\n    });\n};\n\n// Group photos by date\nconst groupPhotosByDate = (photos: ReturnType<typeof generatePhotos>) => {\n    const groups: { [key: string]: typeof photos } = {};\n    photos.forEach((photo) => {\n        if (!groups[photo.date]) {\n            groups[photo.date] = [];\n        }\n        groups[photo.date].push(photo);\n    });\n    return Object.entries(groups).map(([date, photos]) => ({\n        date,\n        photos,\n        label: formatDateLabel(date),\n    }));\n};\n\nconst formatDateLabel = (dateStr: string) => {\n    const date = new Date(dateStr);\n    const today = new Date();\n    const yesterday = new Date(today);\n    yesterday.setDate(yesterday.getDate() - 1);\n\n    if (dateStr === today.toISOString().split(\"T\")[0]) {\n        return \"Heute\";\n    } else if (dateStr === yesterday.toISOString().split(\"T\")[0]) {\n        return \"Gestern\";\n    } else {\n        return date.toLocaleDateString(\"de-DE\", {\n            weekday: \"long\",\n            day: \"numeric\",\n            month: \"long\",\n        });\n    }\n};\n\nexport function PhotoGallery({ photosCount = 0, authUser }: PhotoGalleryProps) {\n    const [searchQuery, setSearchQuery] = useState(\"\");\n    const [showSearch, setShowSearch] = useState(false);\n    const [showFilter, setShowFilter] = useState(false);\n    const [selectedFilter, setSelectedFilter] = useState<string | null>(null);\n    const [selectMode, setSelectMode] = useState(false);\n    const [selectedPhotos, setSelectedPhotos] = useState<Set<string>>(new Set());\n    const [fullscreenPhoto, setFullscreenPhoto] = useState<string | null>(null);\n    const [syncNotification, setSyncNotification] = useState<string | null>(null);\n\n    // Fullscreen photo state\n    const [fullscreenImageUrl, setFullscreenImageUrl] = useState<string | null>(null);\n    const [isLoadingFullscreen, setIsLoadingFullscreen] = useState(false);\n    const [isDownloading, setIsDownloading] = useState(false);\n\n    const longPressTimer = useRef<NodeJS.Timeout | null>(null);\n\n    // Encryption & Real Photo Storage\n    const { secretKey } = useEncryption();\n    const {\n        photos: realPhotos,\n        uploadPhoto,\n        isUploading,\n        uploadProgress,\n    } = useGalleryData(secretKey);\n\n    // Realtime Sync - receive photos from other devices\n    const handleNewPhoto = useCallback((photo: SyncedPhoto) => {\n        console.log('New photo from device:', photo.device_id);\n        setSyncNotification(`Neues Foto von anderem Gerät empfangen`);\n        setTimeout(() => setSyncNotification(null), 3000);\n    }, []);\n\n    const {\n        remoteCIDs,\n        remoteCIDsFromOtherDevices,\n        isConnected,\n    } = useRealtimeSync({\n        onNewPhoto: handleNewPhoto,\n        enabled: true,\n        secretKey,\n    });\n\n    // Combine local photos with remote-only photos\n    const allPhotos = (() => {\n        // Start with local photos\n        const localPhotos = realPhotos.map((p) => ({\n            id: p.id?.toString() || p.cid,\n            cid: p.cid,\n            placeholderUrl: \"\",\n            category: \"photo\",\n            date: p.uploadedAt.toISOString().split(\"T\")[0],\n            metadata: p,\n            isLocal: true,\n            isCloud: isRealIPFSCID(p.cid),\n        }));\n\n        // Add remote-only photos (from other devices, not in local DB)\n        const localCids = new Set(realPhotos.map(p => p.cid));\n        const remoteOnlyPhotos = remoteCIDs\n            .filter(r => !localCids.has(r.cid))\n            .map((r) => ({\n                id: r.cid,\n                cid: r.cid,\n                placeholderUrl: \"\",\n                category: \"cloud\",\n                date: r.uploaded_at ? new Date(r.uploaded_at).toISOString().split(\"T\")[0] : new Date().toISOString().split(\"T\")[0],\n                metadata: {\n                    cid: r.cid,\n                    nonce: r.nonce || '',\n                    fileName: `cloud_${r.cid}`,\n                    mimeType: r.mime_type || 'image/jpeg',\n                    fileSize: r.file_size_bytes || 0,\n                    uploadedAt: r.uploaded_at ? new Date(r.uploaded_at) : new Date(),\n                } as PhotoMetadata,\n                isLocal: false,\n                isCloud: true,\n            }));\n\n        return [...localPhotos, ...remoteOnlyPhotos];\n    })();\n\n    // Use real photos if available, otherwise use placeholders\n    const photos = useMemo(() => \n        allPhotos.length > 0 ? allPhotos : generatePhotos(Math.min(photosCount, 50)),\n    [allPhotos, photosCount]);\n\n    const filteredPhotos = useMemo(() => \n        photos.filter((photo) => {\n            if (selectedFilter && photo.category !== selectedFilter) return false;\n            if (searchQuery && !photo.category.includes(searchQuery.toLowerCase()))\n                return false;\n            return true;\n        }),\n    [photos, selectedFilter, searchQuery]);\n\n    const filteredGroups = useMemo(() => \n        groupPhotosByDate(filteredPhotos),\n    [filteredPhotos]);\n\n    // Load fullscreen photo (on-demand from IPFS if needed)\n    const loadFullscreenPhoto = async (photo: typeof photos[0]) => {\n        if (!secretKey || !photo.metadata) return;\n\n        setIsLoadingFullscreen(true);\n        setFullscreenImageUrl(null);\n\n        try {\n            let blobToDecrypt: Blob | undefined = photo.metadata.encryptedBlob;\n\n            // Fetch from IPFS if not local\n            if (!blobToDecrypt && photo.cid && isRealIPFSCID(photo.cid)) {\n                console.log('Loading full-res from IPFS:', photo.cid);\n                blobToDecrypt = await remoteStorage.download(photo.cid);\n            }\n\n            if (!blobToDecrypt) {\n                console.error('No blob available for fullscreen');\n                return;\n            }\n\n            // Decrypt\n            const decrypted = await decryptFile(\n                blobToDecrypt,\n                photo.metadata.nonce,\n                secretKey,\n                photo.metadata.mimeType\n            );\n\n            if (decrypted) {\n                const url = URL.createObjectURL(decrypted);\n                setFullscreenImageUrl(url);\n            }\n        } catch (error) {\n            console.error('Failed to load fullscreen photo:', error);\n        } finally {\n            setIsLoadingFullscreen(false);\n        }\n    };\n\n    // Download photo to device\n    const downloadPhoto = async (photo: typeof photos[0]) => {\n        if (!secretKey || !photo.metadata) return;\n\n        setIsDownloading(true);\n\n        try {\n            let blobToDecrypt: Blob | undefined = photo.metadata.encryptedBlob;\n\n            // Fetch from IPFS if not local\n            if (!blobToDecrypt && photo.cid && isRealIPFSCID(photo.cid)) {\n                blobToDecrypt = await remoteStorage.download(photo.cid);\n            }\n\n            if (!blobToDecrypt) return;\n\n            // Decrypt\n            const decrypted = await decryptFile(\n                blobToDecrypt,\n                photo.metadata.nonce,\n                secretKey,\n                photo.metadata.mimeType\n            );\n\n            if (decrypted) {\n                // Create download link\n                const url = URL.createObjectURL(decrypted);\n                const a = document.createElement('a');\n                a.href = url;\n                a.download = photo.metadata.fileName || `photo_${photo.cid.slice(0, 8)}.jpg`;\n                document.body.appendChild(a);\n                a.click();\n                document.body.removeChild(a);\n                URL.revokeObjectURL(url);\n\n                setSyncNotification('Foto heruntergeladen!');\n                setTimeout(() => setSyncNotification(null), 2000);\n            }\n        } catch (error) {\n            console.error('Failed to download photo:', error);\n        } finally {\n            setIsDownloading(false);\n        }\n    };\n\n    const handlePhotoTap = (photoId: string, photo: typeof photos[0]) => {\n        if (selectMode) {\n            setSelectedPhotos((prev) => {\n                const newSet = new Set(prev);\n                if (newSet.has(photoId)) {\n                    newSet.delete(photoId);\n                } else {\n                    newSet.add(photoId);\n                }\n                return newSet;\n            });\n        } else {\n            setFullscreenPhoto(photoId);\n            if (photo.metadata) {\n                loadFullscreenPhoto(photo);\n            }\n        }\n    };\n\n    const closeFullscreen = () => {\n        setFullscreenPhoto(null);\n        if (fullscreenImageUrl) {\n            URL.revokeObjectURL(fullscreenImageUrl);\n            setFullscreenImageUrl(null);\n        }\n    };\n\n    const handleTouchStart = (photoId: string) => {\n        longPressTimer.current = setTimeout(() => {\n            setSelectMode(true);\n            setSelectedPhotos(new Set([photoId]));\n        }, 500);\n    };\n\n    const handleTouchEnd = () => {\n        if (longPressTimer.current) {\n            clearTimeout(longPressTimer.current);\n            longPressTimer.current = null;\n        }\n    };\n\n    const categories = [\n        { id: \"nature\", label: \"Natur\" },\n        { id: \"architecture\", label: \"Architektur\" },\n        { id: \"travel\", label: \"Reisen\" },\n        { id: \"food\", label: \"Essen\" },\n        { id: \"animals\", label: \"Tiere\" },\n        { id: \"city\", label: \"Stadt\" },\n        { id: \"landscape\", label: \"Landschaft\" },\n    ];\n\n    // Handle file upload\n    const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {\n        const files = Array.from(e.target.files || []);\n        files.forEach((file) => uploadPhoto(file));\n    };\n\n    return (\n        <div className=\"flex flex-col h-full bg-[#F2F2F7]\">\n            {/* Header */}\n            <header className=\"h-[60px] bg-white border-b border-[#E5E5EA] px-4 flex items-center justify-between shrink-0\">\n                {showSearch ? (\n                    <div className=\"flex-1 flex items-center gap-3\">\n                        <div className=\"flex-1 bg-[#E5E5EA] rounded-lg px-3 py-2 flex items-center gap-2\">\n                            <CustomIcon name=\"search\" size={16} />\n                            <input\n                                type=\"text\"\n                                placeholder=\"Suchen...\"\n                                value={searchQuery}\n                                onChange={(e) => setSearchQuery(e.target.value)}\n                                className=\"flex-1 bg-transparent text-[15px] text-[#1D1D1F] outline-none\"\n                                autoFocus\n                            />\n                        </div>\n                        <button\n                            onClick={() => {\n                                setShowSearch(false);\n                                setSearchQuery(\"\");\n                            }}\n                            className=\"text-[17px] text-[#007AFF] ios-tap-target\"\n                        >\n                            Abbrechen\n                        </button>\n                    </div>\n                ) : selectMode ? (\n                    <>\n                        <button\n                            onClick={() => {\n                                setSelectMode(false);\n                                setSelectedPhotos(new Set());\n                            }}\n                            className=\"text-[17px] text-[#007AFF] ios-tap-target\"\n                        >\n                            Abbrechen\n                        </button>\n                        <span className=\"sketch-body text-[17px] text-[#1D1D1F]\">\n                            {selectedPhotos.size} ausgewählt\n                        </span>\n                        <button\n                            onClick={() => {\n                                console.log(\n                                    \"TODO: Delete selected photos\",\n                                    Array.from(selectedPhotos),\n                                );\n                            }}\n                            className=\"text-[17px] text-[#FF3B30] ios-tap-target\"\n                        >\n                            Löschen\n                        </button>\n                    </>\n                ) : (\n                    <>\n                        <div className=\"flex items-center gap-2\">\n                            <CustomIcon name=\"lock\" size={20} />\n                            <h1 className=\"sketch-subheading text-[20px] text-[#1D1D1F]\">\n                                Galerie\n                            </h1>\n                            {/* Sync Status Indicator */}\n                            {isConnected ? (\n                                <Cloud className=\"w-4 h-4 text-[#007AFF]\" />\n                            ) : (\n                                <CloudOff className=\"w-4 h-4 text-[#8E8E93]\" />\n                            )}\n                        </div>\n                        <div className=\"flex items-center gap-4\">\n                            {/* Upload Button */}\n                            <label className=\"ios-tap-target cursor-pointer\">\n                                <div className={isUploading ? \"animate-pulse opacity-50\" : \"\"}>\n                                    <CustomIcon name=\"upload\" size={24} />\n                                </div>\n                                <input\n                                    type=\"file\"\n                                    multiple\n                                    accept=\"image/*\"\n                                    onChange={handleFileUpload}\n                                    className=\"hidden\"\n                                    disabled={isUploading}\n                                />\n                            </label>\n                            <button\n                                onClick={() => setShowSearch(true)}\n                                className=\"ios-tap-target\"\n                            >\n                                <CustomIcon name=\"search\" size={24} />\n                            </button>\n                            <button\n                                onClick={() => setShowFilter(!showFilter)}\n                                className=\"ios-tap-target\"\n                            >\n                                <SlidersHorizontal\n                                    className={`w-6 h-6 ${selectedFilter ? \"text-[#30D158]\" : \"text-[#007AFF]\"}`}\n                                />\n                            </button>\n                        </div>\n                    </>\n                )}\n            </header>\n\n            {/* Filter Bar */}\n            {showFilter && (\n                <div className=\"bg-white border-b border-[#E5E5EA] px-4 py-3 shrink-0\">\n                    <div className=\"flex gap-2 overflow-x-auto pb-1 -mx-1 px-1\">\n                        <button\n                            onClick={() => setSelectedFilter(null)}\n                            className={`px-4 py-1.5 rounded-full text-[15px] whitespace-nowrap shrink-0 ${\n                                selectedFilter === null\n                                    ? \"bg-[#007AFF] text-white\"\n                                    : \"bg-[#E5E5EA] text-[#1D1D1F]\"\n                            }`}\n                        >\n                            Alle\n                        </button>\n                        {categories.map((cat) => (\n                            <button\n                                key={cat.id}\n                                onClick={() => setSelectedFilter(cat.id)}\n                                className={`px-4 py-1.5 rounded-full text-[15px] whitespace-nowrap shrink-0 ${\n                                    selectedFilter === cat.id\n                                        ? \"bg-[#007AFF] text-white\"\n                                        : \"bg-[#E5E5EA] text-[#1D1D1F]\"\n                                }`}\n                            >\n                                {cat.label}\n                            </button>\n                        ))}\n                    </div>\n                </div>\n            )}\n\n            {/* Photo Grid with Date Groups */}\n            <div className=\"flex-1 overflow-y-auto\">\n                {filteredGroups.map((group) => (\n                    <div key={group.date} className=\"mb-2\">\n                        {/* Date Header */}\n                        <div className=\"sticky top-0 bg-[#F2F2F7]/95 backdrop-blur-sm px-3 py-2 z-10\">\n                            <p className=\"text-[13px] font-semibold text-[#6E6E73]\">\n                                {group.label}\n                            </p>\n                        </div>\n\n                        {/* Photos Grid */}\n                        <div className=\"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-[2px] md:gap-1 px-[2px] md:px-1\">\n                            {group.photos.map((photo) => {\n                                const isRealPhoto = photo.metadata !== undefined;\n\n                                return (\n                                    <button\n                                        key={photo.id}\n                                        onClick={() => handlePhotoTap(photo.id, photo)}\n                                        onTouchStart={() => handleTouchStart(photo.id)}\n                                        onTouchEnd={handleTouchEnd}\n                                        onTouchCancel={handleTouchEnd}\n                                        onContextMenu={(e) => {\n                                            e.preventDefault();\n                                            setSelectMode(true);\n                                            setSelectedPhotos(new Set([photo.id]));\n                                        }}\n                                        className=\"relative aspect-square overflow-hidden bg-[#E5E5EA]\"\n                                    >\n                                        {isRealPhoto ? (\n                                            <DecryptedThumbnail\n                                                photo={photo.metadata!}\n                                                secretKey={secretKey}\n                                                showCloudBadge={true}\n                                            />\n                                        ) : photo.placeholderUrl ? (\n                                            // Placeholder photo (demo data)\n                                            <img\n                                                src={photo.placeholderUrl}\n                                                alt=\"\"\n                                                className=\"w-full h-full object-cover\"\n                                                loading=\"lazy\"\n                                            />\n                                        ) : null}\n\n                                        {selectMode && (\n                                            <div className=\"absolute inset-0 bg-black/20\">\n                                                <div\n                                                    className={`absolute top-2 right-2 w-6 h-6 rounded-full border-2 flex items-center justify-center ${\n                                                        selectedPhotos.has(photo.id)\n                                                            ? \"bg-[#007AFF] border-[#007AFF]\"\n                                                            : \"border-white bg-black/30\"\n                                                    }`}\n                                                >\n                                                    {selectedPhotos.has(photo.id) && (\n                                                        <Check className=\"w-4 h-4 text-white\" />\n                                                    )}\n                                                </div>\n                                            </div>\n                                        )}\n                                    </button>\n                                );\n                            })}\n                        </div>\n                    </div>\n                ))}\n\n                {/* Help text */}\n                <div className=\"text-center py-6 px-4\">\n                    <p className=\"text-[13px] text-[#8E8E93]\">\n                        Lange drücken zum Auswählen • Tippen zum Öffnen\n                    </p>\n                    <p className=\"text-[11px] text-[#C7C7CC] mt-1\">\n                        {realPhotos.length} Fotos lokal • {remoteCIDs.length} in der Cloud\n                    </p>\n                    {remoteCIDsFromOtherDevices.length > 0 && (\n                        <div className=\"text-[11px] text-[#007AFF] mt-1 flex items-center justify-center gap-1\">\n                            <CustomIcon name=\"smartphone\" size={12} />\n                            {remoteCIDsFromOtherDevices.length} von anderen Geräten\n                        </div>\n                    )}\n                </div>\n            </div>\n\n            {/* Sync Notification Toast */}\n            {syncNotification && (\n                <div className=\"fixed top-[70px] left-1/2 -translate-x-1/2 bg-[#1D1D1F] text-white px-4 py-2 rounded-full text-[13px] flex items-center gap-2 z-50 animate-pulse\">\n                    <Cloud className=\"w-4 h-4\" />\n                    {syncNotification}\n                </div>\n            )}\n\n            {/* Fullscreen Photo View */}\n            {fullscreenPhoto && (\n                <div className=\"fixed inset-0 bg-black z-50 flex flex-col\">\n                    <header className=\"h-[60px] flex items-center justify-between px-4 bg-black/80\">\n                        <button\n                            onClick={closeFullscreen}\n                            className=\"ios-tap-target\"\n                        >\n                            <X className=\"w-6 h-6 text-white\" />\n                        </button>\n                        <span className=\"text-[17px] text-white\">\n                            Foto {photos.findIndex((p) => p.id === fullscreenPhoto) + 1} von{\" \"}\n                            {photos.length}\n                        </span>\n                        <div className=\"w-10\" />\n                    </header>\n                    <div className=\"flex-1 flex items-center justify-center p-4\">\n                        {isLoadingFullscreen ? (\n                            <div className=\"flex flex-col items-center gap-4\">\n                                <Loader2 className=\"w-12 h-12 animate-spin text-white/60\" />\n                                <p className=\"text-white/60 text-center\">\n                                    Lade von IPFS...\n                                </p>\n                            </div>\n                        ) : fullscreenImageUrl ? (\n                            <img\n                                src={fullscreenImageUrl}\n                                alt=\"\"\n                                className=\"max-w-full max-h-full object-contain rounded-lg\"\n                            />\n                        ) : (\n                            <div className=\"flex flex-col items-center gap-4\">\n                                <CustomIcon name=\"lock\" size={64} />\n                                <p className=\"text-white/80 text-center\">\n                                    Verschlüsseltes Foto\n                                </p>\n                            </div>\n                        )}\n                    </div>\n                    <footer className=\"h-[80px] flex items-center justify-center gap-6 bg-black/80 px-4\">\n                        {/* Download Button */}\n                        <button\n                            onClick={() => {\n                                const photo = photos.find((p) => p.id === fullscreenPhoto);\n                                if (photo) downloadPhoto(photo);\n                            }}\n                            disabled={isDownloading}\n                            className=\"flex flex-col items-center gap-1 ios-tap-target\"\n                        >\n                            {isDownloading ? (\n                                <Loader2 className=\"w-6 h-6 animate-spin text-white\" />\n                            ) : (\n                                <Download className=\"w-6 h-6 text-white\" />\n                            )}\n                            <span className=\"text-[11px] text-white/80\">Herunterladen</span>\n                        </button>\n\n                        {/* Lock indicator */}\n                        <div className=\"flex flex-col items-center gap-1\">\n                            <CustomIcon name=\"lock\" size={20} />\n                            <span className=\"text-[11px] text-white/60\">Verschlüsselt</span>\n                        </div>\n                    </footer>\n                </div>\n            )}\n            {/* Upload Progress Overlay */}\n            {isUploading && (\n                <div className=\"fixed inset-0 bg-black/40 backdrop-blur-sm z-[60] flex items-center justify-center p-6\">\n                    <div className=\"bg-white w-full max-w-[280px] rounded-2xl p-6 shadow-2xl flex flex-col items-center\">\n                        <div className=\"w-16 h-16 rounded-full bg-[#007AFF]/10 flex items-center justify-center mb-4\">\n                            <Loader2 className=\"w-8 h-8 text-[#007AFF] animate-spin\" />\n                        </div>\n                        <h3 className=\"sketch-subheading text-[17px] font-semibold text-[#1D1D1F] mb-1\">\n                            Foto wird gesichert ({uploadProgress}%)\n                        </h3>\n                        <h3 className=\"sketch-subheading text-[20px] mb-2 text-center\">\n                            Verschlüsselung & IPFS-Upload wird durchgeführt...\n                        </h3>\n                        <div className=\"w-full bg-[#E5E5EA] h-1.5 rounded-full mt-4 overflow-hidden\">\n                            <div \n                                className=\"bg-[#007AFF] h-full transition-all duration-300\"\n                                style={{ width: `${uploadProgress}%` }}\n                            />\n                        </div>\n                    </div>\n                </div>\n            )}\n        </div>\n    );\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6201, "column": 0}, "map": {"version":3,"sources":["file:///Users/einarjaeger/Documents/GitHub/Photovault/src/components/photovault/PhotoVaultApp.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState, useEffect, useCallback, useRef } from \"react\";\nimport { Settings } from \"lucide-react\";\nimport { CustomIcon } from \"@/components/ui/custom-icon\";\nimport ShieldLoader from \"@/components/ui/shield-loader\";\n\n// Screens\nimport { AuthScreen } from \"./AuthScreen\";\nimport { UnlockVaultScreen } from \"./UnlockVaultScreen\";\nimport { VaultSetupScreen } from \"./VaultSetupScreen\";\nimport { SettingsPanel } from \"./SettingsPanel\";\nimport { PhotoGallery } from \"./PhotoGallery\";\n\n// Auth\nimport { useSession, signOut } from \"@/lib/auth-client\";\n\n// Crypto\nimport { loadKeyFromStorage, getUserKeyHash, clearKeyFromStorage } from \"@/lib/crypto\";\n\n// Device & Supabase\nimport { getDeviceId, getDeviceName, getDeviceType } from \"@/lib/deviceId\";\nimport { registerDevice } from \"@/lib/supabase\";\n\nexport interface AppState {\n    isOnboarded: boolean;\n    backupActive: boolean;\n    selectedPlan: \"free\" | \"backup-plus\";\n    autoBackupEnabled: boolean;\n    backgroundBackupEnabled: boolean;\n    photosCount: number;\n    lastBackup: string;\n    permanence: number;\n    encryptionKey: string;\n    backupPhrase: string[];\n    devices: {\n        id: string;\n        name: string;\n        lastActive: string;\n        syncing?: boolean;\n    }[];\n    photoSource: \"photos-app\" | \"files-app\";\n}\n\nconst defaultState: AppState = {\n    isOnboarded: false,\n    backupActive: false,\n    selectedPlan: \"free\",\n    autoBackupEnabled: true,\n    backgroundBackupEnabled: false,\n    photosCount: 0,\n    lastBackup: \"Noch nie\",\n    permanence: 0,\n    encryptionKey: \"\",\n    backupPhrase: [],\n    devices: [],\n    photoSource: \"photos-app\",\n};\n\nexport type Screen = \"gallery\" | \"settings\";\n\ntype AppPhase =\n    | \"loading\"\n    | \"auth\"           // No session - show login/signup\n    | \"unlock\"         // Session exists but no local key - show unlock screen\n    | \"setup\"          // Session exists, no vault_key_hash - create new vault\n    | \"main\";          // Fully authenticated with local key\n\ninterface AuthUser {\n    id: string;\n    email: string;\n    vaultKeyHash: string | null;\n}\n\nexport function PhotoVaultApp() {\n    const [state, setState] = useState<AppState>(defaultState);\n    const [currentScreen, setCurrentScreen] = useState<Screen>(\"gallery\");\n    const [appPhase, setAppPhase] = useState<AppPhase>(\"loading\");\n    const [authUser, setAuthUser] = useState<AuthUser | null>(null);\n\n    // Better Auth session hook\n    const { data: session, isPending: isSessionLoading } = useSession();\n\n    // Ref-Guard: Verhindert mehrfache Device-Registrierung pro Session\n    const hasRegisteredDevice = useRef(false);\n\n    // Register device for authenticated user (nur einmal pro Session)\n    const registerDeviceForUser = useCallback(async (keyHash: string, userId: string) => {\n        // Guard: Nur einmal registrieren\n        if (hasRegisteredDevice.current) {\n            console.log(\"[Device] Already registered this session, skipping\");\n            return;\n        }\n\n        try {\n            const deviceId = getDeviceId();\n            const deviceName = getDeviceName();\n            const deviceType = getDeviceType();\n\n            await registerDevice(deviceId, deviceName, deviceType, keyHash, userId);\n            hasRegisteredDevice.current = true; // Markiere als registriert\n            console.log(\"[Device] Registered successfully:\", deviceId);\n        } catch (err) {\n            console.error(\"[Device] Registration failed:\", err);\n        }\n    }, []);\n\n    // Initialize app - check auth state and local key\n    useEffect(() => {\n        const initializeApp = async () => {\n            // Wait for session check to complete\n            if (isSessionLoading) return;\n\n            // No session - need to authenticate\n            if (!session?.user) {\n                setAppPhase(\"auth\");\n                return;\n            }\n\n            // Have session - fetch vault_key_hash from API (not session)\n            const user = session.user as { id: string; email: string };\n\n            // Fetch the actual vault_key_hash from the database\n            let vaultKeyHash: string | null = null;\n            try {\n                const response = await fetch(\"/api/auth/get-vault-key-hash\");\n                if (response.ok) {\n                    const data = await response.json();\n                    vaultKeyHash = data.vaultKeyHash;\n                }\n            } catch (err) {\n                console.error(\"Failed to fetch vault_key_hash:\", err);\n            }\n\n            setAuthUser({\n                id: user.id,\n                email: user.email,\n                vaultKeyHash,\n            });\n\n            const localKey = loadKeyFromStorage();\n\n            if (localKey) {\n                // Verify local key matches account's vault_key_hash (if set)\n                const localKeyHash = await getUserKeyHash(localKey);\n\n                if (vaultKeyHash && localKeyHash !== vaultKeyHash) {\n                    // Key mismatch - user needs to enter correct recovery phrase\n                    console.warn(\"Local key doesn't match account's vault_key_hash\");\n                    clearKeyFromStorage();\n                    setAppPhase(\"unlock\");\n                    return;\n                }\n\n                // Register device\n                await registerDeviceForUser(localKeyHash, user.id);\n\n                // Ready to go\n                setState((prev) => ({ ...prev, isOnboarded: true }));\n                setAppPhase(\"main\");\n            } else if (vaultKeyHash) {\n                // User has a vault but no local key - need to unlock\n                setAppPhase(\"unlock\");\n            } else {\n                // New user without vault - need to create one\n                setAppPhase(\"setup\");\n            }\n        };\n\n        initializeApp();\n    }, [session, isSessionLoading, registerDeviceForUser]);\n\n    // Handle successful auth (login/signup)\n    const handleAuthSuccess = useCallback(async (user: AuthUser) => {\n        // Fetch the actual vault_key_hash from the database\n        let vaultKeyHash: string | null = user.vaultKeyHash;\n        try {\n            const response = await fetch(\"/api/auth/get-vault-key-hash\");\n            if (response.ok) {\n                const data = await response.json();\n                vaultKeyHash = data.vaultKeyHash;\n            }\n        } catch (err) {\n            console.error(\"Failed to fetch vault_key_hash:\", err);\n        }\n\n        const updatedUser = { ...user, vaultKeyHash };\n        setAuthUser(updatedUser);\n\n        // Check for local key\n        const localKey = loadKeyFromStorage();\n\n        if (localKey) {\n            // User has local key - verify and proceed\n            const keyHash = await getUserKeyHash(localKey);\n            if (vaultKeyHash && keyHash !== vaultKeyHash) {\n                clearKeyFromStorage();\n                setAppPhase(\"unlock\");\n            } else {\n                await registerDeviceForUser(keyHash, user.id);\n                setState((prev) => ({ ...prev, isOnboarded: true }));\n                setAppPhase(\"main\");\n            }\n        } else if (vaultKeyHash) {\n            // User has vault but no local key\n            setAppPhase(\"unlock\");\n        } else {\n            // New user - create vault\n            setAppPhase(\"setup\");\n        }\n    }, [registerDeviceForUser]);\n\n    // Handle vault unlock (user entered recovery phrase)\n    const handleVaultUnlock = useCallback(async (secretKey: Uint8Array, keyHash: string) => {\n        if (!authUser) return;\n\n        // If user doesn't have vault_key_hash set, update it\n        if (!authUser.vaultKeyHash) {\n            await updateUserVaultKeyHash(authUser.id, keyHash);\n            setAuthUser({ ...authUser, vaultKeyHash: keyHash });\n        }\n\n        // Register device\n        await registerDeviceForUser(keyHash, authUser.id);\n\n        setState((prev) => ({ ...prev, isOnboarded: true }));\n        setAppPhase(\"main\");\n    }, [authUser, registerDeviceForUser]);\n\n    // Handle new vault creation\n    const handleVaultCreated = useCallback(async (keyHash: string) => {\n        if (!authUser) return;\n\n        // Update user's vault_key_hash (anchor key to account)\n        await updateUserVaultKeyHash(authUser.id, keyHash);\n        setAuthUser({ ...authUser, vaultKeyHash: keyHash });\n\n        // Register device\n        await registerDeviceForUser(keyHash, authUser.id);\n\n        setState((prev) => ({ ...prev, isOnboarded: true }));\n        setAppPhase(\"main\");\n    }, [authUser, registerDeviceForUser]);\n\n    // Handle logout\n    const handleLogout = useCallback(async () => {\n        await signOut();\n        clearKeyFromStorage();\n        setAuthUser(null);\n        setState(defaultState);\n        setAppPhase(\"auth\");\n    }, []);\n\n    const navigateTo = (screen: Screen) => {\n        setCurrentScreen(screen);\n    };\n\n    // Loading state\n    if (appPhase === \"loading\" || isSessionLoading) {\n        return <ShieldLoader />;\n    }\n\n    // Auth screen (login/signup)\n    if (appPhase === \"auth\") {\n        return (\n            <div className=\"min-h-screen ios-bg-gray\">\n                <div className=\"max-w-[1200px] mx-auto min-h-screen bg-[#F2F2F7]\">\n                    <AuthScreen onSuccess={handleAuthSuccess} />\n                </div>\n            </div>\n        );\n    }\n\n    // Unlock vault screen (enter recovery phrase)\n    if (appPhase === \"unlock\" && authUser) {\n        return (\n            <div className=\"min-h-screen ios-bg-gray\">\n                <div className=\"max-w-[1200px] mx-auto min-h-screen bg-[#F2F2F7]\">\n                    <UnlockVaultScreen\n                        userEmail={authUser.email}\n                        expectedKeyHash={authUser.vaultKeyHash}\n                        onUnlock={handleVaultUnlock}\n                        onCreateNewVault={() => setAppPhase(\"setup\")}\n                        onLogout={handleLogout}\n                    />\n                </div>\n            </div>\n        );\n    }\n\n    // Vault setup screen (create new vault)\n    if (appPhase === \"setup\" && authUser) {\n        return (\n            <div className=\"min-h-screen ios-bg-gray\">\n                <div className=\"max-w-[1200px] mx-auto min-h-screen bg-[#F2F2F7]\">\n                    <VaultSetupScreen\n                        userId={authUser.id}\n                        onComplete={handleVaultCreated}\n                        onBack={() => setAppPhase(\"unlock\")}\n                    />\n                </div>\n            </div>\n        );\n    }\n\n    // Main app\n    return (\n        <div className=\"min-h-screen ios-bg-gray\">\n            <div className=\"max-w-[1200px] mx-auto min-h-screen bg-[#F2F2F7] flex flex-col relative\">\n                {/* Main Content Area */}\n                <div className=\"flex-1 overflow-hidden pb-[80px]\">\n                    {currentScreen === \"gallery\" && (\n                        <PhotoGallery \n                            photosCount={state.photosCount} \n                            authUser={authUser}\n                        />\n                    )}\n                    {currentScreen === \"settings\" && (\n                        <SettingsPanel\n                            state={state}\n                            setState={setState}\n                            onRestartOnboarding={handleLogout}\n                            authUser={authUser}\n                        />\n                    )}\n                </div>\n\n                {/* Bottom Navigation */}\n                <BottomNavigation\n                    currentScreen={currentScreen}\n                    onNavigate={navigateTo}\n                />\n            </div>\n        </div>\n    );\n}\n\n// Helper function to update user's vault_key_hash via API\nasync function updateUserVaultKeyHash(userId: string, keyHash: string): Promise<void> {\n    try {\n        const response = await fetch(\"/api/auth/update-vault-key\", {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({ userId, keyHash }),\n        });\n\n        if (!response.ok) {\n            throw new Error(\"Failed to update vault key hash\");\n        }\n    } catch (err) {\n        console.error(\"Failed to update vault_key_hash:\", err);\n        throw err;\n    }\n}\n\nfunction BottomNavigation({\n    currentScreen,\n    onNavigate,\n}: {\n    currentScreen: Screen;\n    onNavigate: (screen: Screen) => void;\n}) {\n    return (\n        <nav className=\"fixed bottom-0 left-0 right-0 h-[80px] bg-white/80 backdrop-blur-xl border-t border-[#E5E5EA]/50 flex items-start justify-around pt-2 pb-6 max-w-[1200px] mx-auto safe-area-bottom z-40\">\n            {/* Gallery Tab */}\n            <button\n                onClick={() => onNavigate(\"gallery\")}\n                className=\"flex flex-col items-center gap-1 ios-tap-target px-8\"\n            >\n                <CustomIcon\n                    name=\"image\"\n                    size={24}\n                    className={currentScreen === \"gallery\" ? \"text-[#007AFF]\" : \"text-[#6E6E73]\"}\n                />\n                <span\n                    className={`text-[10px] ${currentScreen === \"gallery\" ? \"text-[#007AFF]\" : \"text-[#6E6E73]\"}`}\n                >\n                    Galerie\n                </span>\n            </button>\n\n            {/* Settings Tab */}\n            <button\n                onClick={() => onNavigate(\"settings\")}\n                className=\"flex flex-col items-center gap-1 ios-tap-target px-8\"\n            >\n                <Settings\n                    className={`w-6 h-6 ${currentScreen === \"settings\" ? \"text-[#007AFF]\" : \"text-[#6E6E73]\"}`}\n                />\n                <span\n                    className={`text-[10px] ${currentScreen === \"settings\" ? \"text-[#007AFF]\" : \"text-[#6E6E73]\"}`}\n                >\n                    Einstellungen\n                </span>\n            </button>\n        </nav>\n    );\n}\n"],"names":[],"mappings":"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"}}]
}